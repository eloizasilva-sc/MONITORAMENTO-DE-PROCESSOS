<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Processos Auditados | Gestão de Auditoria</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Em GitHub Pages, /_sdk costuma falhar. O sistema abaixo tem fallback (localStorage). -->
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    .sidebar-item:hover { background-color: #1e293b; }
    .active-link { background-color: #64748b; color: white; }
    .glass { background: rgba(255,255,255,.75); backdrop-filter: blur(10px); }
    .card-hover { transition: transform .15s ease, box-shadow .15s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(15, 23, 42, .08); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.25s ease-out; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-full">

  <!-- Login -->
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-gradient-to-r from-slate-800 to-slate-950 p-8 text-white text-center">
        <i data-lucide="shield-check" class="w-16 h-16 mx-auto mb-4"></i>
        <h1 class="text-2xl font-extrabold tracking-tight">PROCESSOS AUDITADOS</h1>
        <p class="text-sm opacity-90 mt-1">SESAP/RN</p>
      </div>

      <div class="p-8">
        <h2 class="text-lg font-bold text-slate-800 mb-6 text-center">Acesso</h2>

        <form id="login-form" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Usuário *</label>
            <select id="login-perfil" required onchange="toggleSetorField()"
              class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
              <option value="">Selecione...</option>
              <option value="Administrador Geral - CAS ADM">Administrador Geral - CAS ADM</option>
              <option value="Técnico">Técnico (Por Setor)</option>
            </select>
          </div>

          <div id="setor-field" style="display:none;">
            <label class="block text-sm font-medium text-slate-700 mb-2">Setor Responsável *</label>
            <select id="login-setor" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
              <option value="">Selecione seu setor...</option>
            </select>
            <p class="text-xs text-slate-500 mt-2">A lista é atualizada automaticamente quando você cadastra novos processos</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Nome Completo *</label>
            <input type="text" id="login-nome" required placeholder="Digite seu nome"
              class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <button type="submit" id="login-btn"
            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl">
            Entrar
          </button>
        </form>

        <div class="mt-6 pt-6 border-t border-slate-200 text-center text-xs text-slate-500">
          <p>Sistema de Gestão de Auditorias</p>
          <p class="mt-1">CAS Administrativo</p>
        </div>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" style="display:none;" class="flex h-full overflow-hidden w-full">

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-950 text-slate-300 flex flex-col hidden md:flex">
      <div class="p-6 flex items-center gap-3 text-white border-b border-slate-800">
        <i data-lucide="shield-check" class="text-slate-400"></i>
        <span class="font-extrabold text-lg tracking-tight">PROCESSOS AUDITADOS</span>
      </div>

      <div class="px-5 py-4 bg-slate-900 border-b border-slate-800">
        <div class="flex items-center gap-3 mb-2">
          <div class="h-10 w-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm" id="user-avatar">AD</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-white truncate" id="user-name-sidebar">Usuário</p>
            <p class="text-xs text-slate-400" id="user-role-sidebar">Carregando...</p>
          </div>
        </div>
        <div id="user-setor-badge" style="display:none;" class="mt-2 px-3 py-1.5 bg-blue-600 bg-opacity-20 border border-blue-500 rounded-xl">
          <p class="text-xs font-semibold text-blue-300 text-center" id="user-setor-text"></p>
        </div>
      </div>

      <nav class="flex-1 px-4 space-y-2 mt-4">
        <a href="#" onclick="showView('dashboard'); return false;" id="nav-dashboard" class="sidebar-item flex items-center gap-3 p-3 rounded-xl transition-all active-link">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
        </a>
        <a href="#" onclick="showView('processos'); return false;" id="nav-processos" class="sidebar-item flex items-center gap-3 p-3 rounded-xl transition-all">
          <i data-lucide="clipboard-list" class="w-5 h-5"></i> Processos
        </a>
        <a href="#" onclick="showView('recomendacoes'); return false;" id="nav-recomendacoes" class="sidebar-item flex items-center gap-3 p-3 rounded-xl transition-all">
          <i data-lucide="list-checks" class="w-5 h-5"></i> Plano de Ação
        </a>

        <!-- Somente ADMIN vê Auditoria -->
        <a href="#" onclick="showView('auditoria'); return false;" id="nav-auditoria" style="display:none;"
           class="sidebar-item flex items-center gap-3 p-3 rounded-xl transition-all">
          <i data-lucide="activity" class="w-5 h-5"></i> Auditoria do Sistema
        </a>

        <a href="#" onclick="exportMenuOpen(); return false;" class="sidebar-item flex items-center gap-3 p-3 rounded-xl transition-all">
          <i data-lucide="download" class="w-5 h-5"></i> Exportar PDF
        </a>
      </nav>

      <div class="p-4 border-t border-slate-800">
        <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl text-sm font-medium transition-colors">
          <i data-lucide="log-out" class="w-4 h-4"></i> Sair
        </button>
        <div class="mt-3 text-xs text-slate-500 text-center">SESAP/RN</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-y-auto">

      <!-- Header -->
      <header class="bg-white/80 backdrop-blur border-b border-slate-200 h-16 flex items-center justify-between px-8 sticky top-0 z-10">
        <div>
          <h1 id="page-title" class="font-semibold text-lg text-slate-800">Dashboard</h1>
          <p id="page-subtitle" class="text-xs text-slate-500"></p>
        </div>

        <div class="flex items-center gap-3">
          <button onclick="openNewProcessoModal()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-semibold hover:bg-slate-900 flex items-center gap-2 shadow-sm">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
          <div class="h-9 w-9 bg-slate-800 rounded-full flex items-center justify-center text-white font-semibold text-sm" id="user-avatar-header">AD</div>
        </div>
      </header>

      <!-- Dashboard -->
      <div id="view-dashboard" class="p-8 max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-2xl border border-slate-200 p-6 card-hover">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-slate-500">Locais</p>
              <i data-lucide="building-2" class="w-5 h-5 text-slate-400"></i>
            </div>
            <h3 id="dash-total-locais" class="text-3xl font-extrabold mt-2">0</h3>
            <p class="text-xs text-slate-400 mt-2">Unidades auditadas</p>
          </div>

          <div class="bg-white rounded-2xl border border-slate-200 p-6 card-hover">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-slate-500">Processos</p>
              <i data-lucide="clipboard-list" class="w-5 h-5 text-slate-400"></i>
            </div>
            <h3 id="dash-total-processos" class="text-3xl font-extrabold mt-2">0</h3>
            <p class="text-xs text-slate-400 mt-2">Cadastrados</p>
          </div>

          <div class="bg-white rounded-2xl border border-slate-200 p-6 card-hover">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-slate-500">Recomendações</p>
              <i data-lucide="list-checks" class="w-5 h-5 text-slate-400"></i>
            </div>
            <h3 id="dash-total-recomendacoes" class="text-3xl font-extrabold mt-2">0</h3>
            <p class="text-xs text-slate-400 mt-2">Ativas</p>
          </div>

          <div class="bg-white rounded-2xl border border-slate-200 p-6 card-hover">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-red-600">Atrasadas</p>
              <i data-lucide="alarm-clock" class="w-5 h-5 text-red-400"></i>
            </div>
            <h3 id="dash-atrasadas" class="text-3xl font-extrabold mt-2 text-red-600">0</h3>
            <p class="text-xs text-slate-400 mt-2">Precisam de ação</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="lg:col-span-3 bg-white rounded-2xl border border-slate-200 p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-lg font-extrabold text-slate-800">Distribuição por Unidade</h2>
                <p class="text-sm text-slate-500">Visão rápida por local auditado</p>
              </div>
              <i data-lucide="pie-chart" class="w-5 h-5 text-slate-400"></i>
            </div>
            <div id="locais-dashboard" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>

            <div id="dashboard-empty" style="display:none;" class="mt-6 bg-slate-50 rounded-2xl border border-slate-200 p-10 text-center">
              <i data-lucide="folder-open" class="w-14 h-14 text-slate-300 mx-auto mb-4"></i>
              <h3 class="text-xl font-extrabold text-slate-700 mb-2">Nenhuma auditoria cadastrada</h3>
              <p class="text-slate-500 mb-6">Crie seu primeiro processo para iniciar o monitoramento</p>
              <button onclick="openNewProcessoModal()" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-semibold hover:bg-slate-900 inline-flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Processos -->
      <div id="view-processos" style="display:none;" class="p-8 max-w-7xl mx-auto">
        <div id="processos-list" class="space-y-6"></div>
        <div id="processos-empty" class="bg-white rounded-2xl border border-slate-200 p-12 text-center">
          <i data-lucide="folder-open" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-extrabold text-slate-700 mb-2">Nenhum processo cadastrado</h3>
          <p class="text-slate-500 mb-6">Comece criando seu primeiro processo de auditoria</p>
          <button onclick="openNewProcessoModal()" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-semibold hover:bg-slate-900 inline-flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
        </div>
      </div>

      <!-- Plano de Ação -->
      <div id="view-recomendacoes" style="display:none;" class="p-8 max-w-7xl mx-auto">
        <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-6 card-hover">
          <div class="flex flex-col lg:flex-row gap-3 lg:items-end">
            <div class="flex-1">
              <label class="block text-xs font-bold text-slate-600 mb-1">Buscar</label>
              <input id="filtro-busca" type="text" placeholder="Recomendação, processo, unidade, área..."
                oninput="applyRecFilters()"
                class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">Unidade</label>
              <select id="filtro-unidade" onchange="applyRecFilters()"
                class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Todas</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">Processo</label>
              <select id="filtro-processo" onchange="applyRecFilters()"
                class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Todos</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">Área responsável</label>
              <select id="filtro-area" onchange="applyRecFilters()"
                class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Todas</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">Status</label>
              <select id="filtro-status" onchange="applyRecFilters()"
                class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Todos</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Execução">Em Execução</option>
                <option value="Atrasado">Atrasado</option>
                <option value="Concluído">Concluído</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-slate-600 mb-1">Prioridade</label>
              <select id="filtro-prioridade" onchange="applyRecFilters()"
                class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Todas</option>
                <option value="Alta">Alta</option>
                <option value="Média">Média</option>
                <option value="Baixa">Baixa</option>
              </select>
            </div>

            <div class="flex items-center gap-2 pb-1">
              <input id="filtro-atrasadas" type="checkbox" onchange="applyRecFilters()" class="h-4 w-4">
              <label for="filtro-atrasadas" class="text-sm text-slate-700">Somente atrasadas</label>
            </div>

            <div class="lg:ml-auto flex gap-2">
              <button onclick="resetRecFilters()" class="px-3 py-2 border border-slate-300 rounded-xl text-sm font-semibold hover:bg-slate-50">Limpar</button>
              <button onclick="renderCurrentView()" class="px-3 py-2 bg-slate-800 text-white rounded-xl text-sm font-semibold hover:bg-slate-900">Atualizar</button>
            </div>
          </div>
        </div>

        <div id="recomendacoes-grouped" class="space-y-6"></div>

        <div id="recomendacoes-empty" style="display:none;" class="bg-white rounded-2xl border border-slate-200 p-12 text-center">
          <i data-lucide="clipboard-check" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-extrabold text-slate-700 mb-2">Nenhuma recomendação encontrada</h3>
          <p class="text-slate-500">As recomendações atribuídas ao seu setor aparecerão aqui</p>
        </div>
      </div>

      <!-- Auditoria (somente Admin) -->
      <div id="view-auditoria" style="display:none;" class="p-8 max-w-7xl mx-auto">
        <div class="bg-white rounded-2xl border border-slate-200 p-6 card-hover">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-extrabold text-slate-800">Auditoria das Modificações</h2>
              <p class="text-sm text-slate-500 mt-1">Quem fez, o que fez, data e hora, com detalhes do registro.</p>
            </div>
            <div class="flex gap-2">
              <button onclick="exportAuditCsv()" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-sm font-semibold hover:bg-slate-900 flex items-center gap-2">
                <i data-lucide="file-down" class="w-4 h-4"></i> Exportar CSV
              </button>
              <button onclick="clearAuditLog()" class="px-4 py-2 border border-red-300 text-red-700 rounded-xl text-sm font-semibold hover:bg-red-50 flex items-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Limpar
              </button>
            </div>
          </div>

          <div class="mt-6 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600 border-b">
                  <th class="py-3 pr-4">Data/Hora</th>
                  <th class="py-3 pr-4">Usuário</th>
                  <th class="py-3 pr-4">Perfil</th>
                  <th class="py-3 pr-4">Ação</th>
                  <th class="py-3 pr-4">Entidade</th>
                  <th class="py-3 pr-4">Identificador</th>
                  <th class="py-3">Detalhes</th>
                </tr>
              </thead>
              <tbody id="audit-table-body" class="divide-y"></tbody>
            </table>
          </div>

          <div id="audit-empty" class="mt-6 text-sm text-slate-500 bg-slate-50 border border-slate-200 rounded-2xl p-6">
            Nenhuma modificação registrada ainda.
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Modal Processo -->
  <div id="modal-processo" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-extrabold text-xl text-slate-800">Novo Processo</h2>
        <button onclick="closeModal('processo')" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <form id="processo-form" class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Nº do Processo SEI *</label>
            <input type="text" id="processo_numero" required
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Eixo *</label>
            <select id="eixo" onchange="toggleEixoOutro()" required
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Selecione...</option>
              <option value="Orçamento e Estoques">Orçamento e Estoques</option>
              <option value="Demandas Judiciais">Demandas Judiciais</option>
              <option value="Contratos">Contratos</option>
              <option value="Outro">Outro</option>
            </select>
            <input type="text" id="eixo_outro" placeholder="Digite o nome do novo eixo..." style="display:none;"
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mt-2">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Unidade/Local da Auditoria *</label>
            <input type="text" id="unidade" required placeholder="Hospital/Setor"
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Período *</label>
            <input type="text" id="periodo" required placeholder="Janeiro/2026"
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Objeto da Auditoria *</label>
            <input type="text" id="objeto" required
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável (Gestor da unidade)</label>
            <input type="text" id="responsavel" placeholder="Nome do responsável"
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Auditor Responsável</label>
            <input type="text" id="auditor"
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Setores/Áreas Envolvidos *</label>
            <p class="text-xs text-blue-600 mb-2">Esses setores entram automaticamente na lista do login (Setor Responsável)</p>

            <div id="setores-processo-container" class="space-y-2 mb-2"></div>

            <div class="flex gap-2">
              <input type="text" id="setor_processo_input" placeholder="Ex: CAS, SUAH, Jurídico, Contratos..."
                class="flex-1 px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <button type="button" onclick="adicionarSetorProcesso()"
                class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 flex items-center gap-2 font-semibold">
                <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
              </button>
            </div>
          </div>
        </div>

        <div class="flex gap-3 justify-end pt-4 border-t border-slate-200">
          <button type="button" onclick="closeModal('processo')" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 font-semibold">
            Cancelar
          </button>
          <button type="submit" id="submit-processo-btn" class="bg-slate-800 text-white px-6 py-2 rounded-xl hover:bg-slate-900 font-semibold">
            <span id="submit-processo-text">Salvar Processo</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Export -->
  <div id="modal-export" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-extrabold text-xl text-slate-800">Exportar PDF</h2>
        <button onclick="closeModal('export')" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="p-6 space-y-6">
        <div class="border-2 border-blue-300 bg-blue-50 rounded-2xl p-4">
          <h3 class="font-extrabold text-blue-900 mb-3 text-lg flex items-center gap-2">
            <i data-lucide="clipboard-list" class="w-6 h-6"></i> Plano de Ação (5W2H)
          </h3>
          <div class="space-y-3">
            <div class="bg-white border border-blue-200 rounded-xl p-4 hover:border-blue-400 transition-all cursor-pointer" onclick="exportPDFGeral()">
              <div class="flex items-start gap-4">
                <div class="bg-blue-100 rounded-xl p-3">
                  <i data-lucide="file-text" class="w-7 h-7 text-blue-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-extrabold text-slate-800 mb-1">Relatório Geral</h4>
                  <p class="text-sm text-slate-600">Recomendações e ações (5W2H)</p>
                </div>
                <i data-lucide="download" class="w-5 h-5 text-slate-400"></i>
              </div>
            </div>

            <div class="bg-white border border-blue-200 rounded-xl p-4">
              <div class="flex items-start gap-4 mb-3">
                <div class="bg-blue-100 rounded-xl p-3">
                  <i data-lucide="folder" class="w-7 h-7 text-blue-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-extrabold text-slate-800 mb-1">Por Processo</h4>
                  <p class="text-sm text-slate-600">Plano de ação de um processo específico</p>
                </div>
              </div>
              <div id="processos-plano-list" class="space-y-2 pl-14 max-h-56 overflow-y-auto"></div>
            </div>
          </div>
        </div>

        <div class="border-2 border-purple-300 bg-purple-50 rounded-2xl p-4">
          <h3 class="font-extrabold text-purple-900 mb-3 text-lg flex items-center gap-2">
            <i data-lucide="file-check" class="w-6 h-6"></i> Relatório Formal
          </h3>
          <div class="space-y-3">
            <div class="bg-white border border-purple-200 rounded-xl p-4 hover:border-purple-400 transition-all cursor-pointer" onclick="exportPDFFormalGeral()">
              <div class="flex items-start gap-4">
                <div class="bg-purple-100 rounded-xl p-3">
                  <i data-lucide="file-check-2" class="w-7 h-7 text-purple-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-extrabold text-slate-800 mb-1">Relatório Formal Geral</h4>
                  <p class="text-sm text-slate-600">Evidências, justificativas e resultados</p>
                </div>
                <i data-lucide="download" class="w-5 h-5 text-slate-400"></i>
              </div>
            </div>

            <div class="bg-white border border-purple-200 rounded-xl p-4">
              <div class="flex items-start gap-4 mb-3">
                <div class="bg-purple-100 rounded-xl p-3">
                  <i data-lucide="folder-check" class="w-7 h-7 text-purple-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-extrabold text-slate-800 mb-1">Formal por Processo</h4>
                  <p class="text-sm text-slate-600">Relatório formal de um processo específico</p>
                </div>
              </div>
              <div id="processos-formal-list" class="space-y-2 pl-14 max-h-56 overflow-y-auto"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // 1) CORREÇÃO DO ERRO create undefined + persistência
    // ============================================================
    const STORAGE_KEY = "processos_auditados_v4";
    const AUDIT_KEY = "processos_auditados_audit_v2";
    const SETORES_KEY = "processos_auditados_setores_v1"; // cache dos setores para login

    function safeParse(json, fallback) { try { return JSON.parse(json) ?? fallback; } catch { return fallback; } }
    function getStoredData() { return safeParse(localStorage.getItem(STORAGE_KEY), []); }
    function setStoredData(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function getStoredAudit() { return safeParse(localStorage.getItem(AUDIT_KEY), []); }
    function setStoredAudit(arr) { localStorage.setItem(AUDIT_KEY, JSON.stringify(arr)); }

    function getStoredSetores() { return safeParse(localStorage.getItem(SETORES_KEY), []); }
    function setStoredSetores(arr) { localStorage.setItem(SETORES_KEY, JSON.stringify(arr)); }

    function nowIso() { return new Date().toISOString(); }
    function formatBR(iso) { try { return new Date(iso).toLocaleString("pt-BR"); } catch { return iso; } }

    function getIdFieldByTipo(tipo) {
      if (tipo === "processo") return "processo_id";
      if (tipo === "achado") return "achado_id";
      if (tipo === "recomendacao") return "recomendacao_id";
      return null;
    }

    let userSession = null;
    let allData = [];
    let currentView = "dashboard";

    // Auditoria: somente Admin vê a tela Auditoria, mas o registro acontece para o sistema funcionar
    function auditLog({ action, entityType, entityId, details }) {
      const session = userSession || { nome: "Desconhecido", perfil: "N/A" };
      const entry = {
        id: "aud_" + Date.now() + "_" + Math.random().toString(36).slice(2),
        at: nowIso(),
        user: session.nome || "Desconhecido",
        perfil: session.perfil || "N/A",
        action,
        entityType,
        entityId,
        details: details || ""
      };
      const audit = getStoredAudit();
      audit.unshift(entry);
      if (audit.length > 1000) audit.length = 1000;
      setStoredAudit(audit);

      if (currentView === "auditoria") renderAuditView();
    }

    function summarizeEntity(item) {
      if (!item || typeof item !== "object") return "";
      if (item.tipo === "processo") return `Processo ${item.processo_numero || ""} | Unidade: ${item.unidade || ""}`;
      if (item.tipo === "achado") return `Achado ${item.achado_numero || ""} | Risco: ${item.grau_risco || ""}`;
      if (item.tipo === "recomendacao") return `Rec ${item.recomendacao_numero || ""} | Status: ${item.status || ""} | Progresso: ${item.progresso ?? ""}%`;
      return "";
    }

    // SDK local
    const localSdk = {
      _onDataChanged: null,
      async init({ onDataChanged } = {}) {
        this._onDataChanged = typeof onDataChanged === "function" ? onDataChanged : null;
        const data = getStoredData();
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },
      async create(item) {
        const idField = getIdFieldByTipo(item?.tipo);
        if (!idField || !item?.[idField]) return { isOk: false, error: "ID ausente" };

        const data = getStoredData();
        const already = data.some(d => d.tipo === item.tipo && d[idField] === item[idField]);
        if (already) return { isOk: false, error: "ID já existe" };

        data.push(item);
        setStoredData(data);
        if (this._onDataChanged) this._onDataChanged(data);

        auditLog({ action: "CREATE", entityType: item.tipo, entityId: item[idField], details: summarizeEntity(item) });
        return { isOk: true };
      },
      async update(item) {
        const idField = getIdFieldByTipo(item?.tipo);
        if (!idField || !item?.[idField]) return { isOk: false, error: "ID ausente" };

        const data = getStoredData();
        const idx = data.findIndex(d => d.tipo === item.tipo && d[idField] === item[idField]);
        if (idx === -1) return { isOk: false, error: "Item não encontrado" };

        data[idx] = item;
        setStoredData(data);
        if (this._onDataChanged) this._onDataChanged(data);

        auditLog({ action: "UPDATE", entityType: item.tipo, entityId: item[idField], details: summarizeEntity(item) });
        return { isOk: true };
      },
      async delete(item) {
        const idField = getIdFieldByTipo(item?.tipo);
        if (!idField || !item?.[idField]) return { isOk: false, error: "ID ausente" };

        const data = getStoredData();
        const next = data.filter(d => !(d.tipo === item.tipo && d[idField] === item[idField]));
        setStoredData(next);
        if (this._onDataChanged) this._onDataChanged(next);

        auditLog({ action: "DELETE", entityType: item.tipo, entityId: item[idField], details: summarizeEntity(item) });
        return { isOk: true };
      }
    };

    function ensureDataSdk() {
      if (!window.dataSdk || typeof window.dataSdk.init !== "function") window.dataSdk = localSdk;
      if (typeof window.dataSdk.create !== "function" || typeof window.dataSdk.update !== "function" || typeof window.dataSdk.delete !== "function") {
        window.dataSdk = localSdk;
      }
    }

    function refreshIcons() { try { if (window.lucide?.createIcons) window.lucide.createIcons(); } catch {} }

    // ============================================================
    // 2) SETORES: sincronizar automaticamente com login (lista suspensa)
    // ============================================================
    function getSetoresFromData(data) {
      const processos = (Array.isArray(data) ? data : []).filter(d => d.tipo === "processo");
      const setores = new Set();

      processos.forEach(p => {
        const txt = (p.setores_envolvidos || "");
        txt.split(";").map(s => s.trim()).filter(Boolean).forEach(s => setores.add(s));
      });

      return [...setores].sort();
    }

    function rebuildSetorCatalog() {
      const setores = getSetoresFromData(allData);
      setStoredSetores(setores);
      // se o login estiver aberto e o usuário for Técnico, atualiza a lista na hora
      const loginScreenVisible = document.getElementById("login-screen")?.style?.display !== "none";
      if (loginScreenVisible) popularSetoresLogin();
    }

    function popularSetoresLogin() {
      const setorSelect = document.getElementById("login-setor");
      if (!setorSelect) return;

      const setores = getStoredSetores();
      setorSelect.innerHTML = '<option value="">Selecione seu setor...</option>';

      if (setores.length) {
        setores.forEach(setor => {
          const option = document.createElement("option");
          option.value = setor;
          option.textContent = setor;
          setorSelect.appendChild(option);
        });
      } else {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Nenhum setor cadastrado ainda";
        option.disabled = true;
        setorSelect.appendChild(option);
      }
    }

    // ============================================================
    // 3) LOGIN + CONTROLE DE VISIBILIDADE (somente admin vê Auditoria)
    // ============================================================
    function toggleSetorField() {
      const perfil = document.getElementById("login-perfil").value;
      const setorField = document.getElementById("setor-field");
      const setorSelect = document.getElementById("login-setor");

      if (perfil === "Técnico") {
        setorField.style.display = "block";
        setorSelect.required = true;
        popularSetoresLogin();
      } else {
        setorField.style.display = "none";
        setorSelect.required = false;
      }
    }

    document.getElementById("login-form").addEventListener("submit", function(e) {
      e.preventDefault();

      const perfil = document.getElementById("login-perfil").value;
      const nome = document.getElementById("login-nome").value;
      const setor = document.getElementById("login-setor").value;

      if (!perfil || !nome) { showToast("Preencha os campos obrigatórios", "error"); return; }
      if (perfil === "Técnico" && !setor) { showToast("Selecione seu setor", "error"); return; }

      userSession = { nome, perfil, setor: setor || null, loginTime: nowIso() };
      localStorage.setItem("userSession", JSON.stringify(userSession));

      document.getElementById("login-screen").style.display = "none";
      document.getElementById("app").style.display = "flex";

      updateUserUI();
      refreshIcons();
      renderCurrentView();
    });

    function updateUserUI() {
      if (!userSession) return;

      const iniciais = userSession.nome.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase();

      document.getElementById("user-avatar").textContent = iniciais;
      document.getElementById("user-avatar-header").textContent = iniciais;

      document.getElementById("user-name-sidebar").textContent = userSession.nome;

      const isAdmin = userSession.perfil === "Administrador Geral - CAS ADM";
      document.getElementById("user-role-sidebar").textContent = isAdmin ? "Administrador Geral" : "Técnico";

      // Somente ADMIN enxerga a Auditoria
      document.getElementById("nav-auditoria").style.display = isAdmin ? "flex" : "none";

      if (isAdmin) {
        document.getElementById("user-setor-badge").style.display = "none";
        document.getElementById("page-subtitle").textContent = "Visão completa de todos os processos";
      } else {
        document.getElementById("user-setor-badge").style.display = "block";
        document.getElementById("user-setor-text").textContent = userSession.setor || "";
        document.getElementById("page-subtitle").textContent = "Setor: " + (userSession.setor || "");
      }
    }

    function logout() {
      localStorage.removeItem("userSession");
      userSession = null;
      location.reload();
    }

    // ============================================================
    // 4) INIT
    // ============================================================
    window.addEventListener("DOMContentLoaded", async () => {
      const savedSession = localStorage.getItem("userSession");
      if (savedSession) {
        userSession = JSON.parse(savedSession);
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("app").style.display = "flex";
        updateUserUI();
      } else {
        // Se estiver na tela de login, já carrega setores do cache
        popularSetoresLogin();
      }

      ensureDataSdk();

      await window.dataSdk.init({
        onDataChanged: (data) => {
          allData = Array.isArray(data) ? data : [];
          rebuildSetorCatalog();       // ✅ atualiza setores sempre que algo mudar
          renderCurrentView();
        }
      });

      // no primeiro carregamento, garante o catálogo atualizado
      rebuildSetorCatalog();

      refreshIcons();
      renderCurrentView();
    });

    // ============================================================
    // 5) NAVEGAÇÃO + FILTRO POR USUÁRIO
    // ============================================================
    function showView(view) {
      if (view === "auditoria" && (!userSession || userSession.perfil !== "Administrador Geral - CAS ADM")) {
        showToast("Acesso restrito ao Administrador", "error");
        return;
      }

      currentView = view;

      document.querySelectorAll('[id^="view-"]').forEach(v => v.style.display = "none");
      const viewEl = document.getElementById("view-" + view);
      if (viewEl) viewEl.style.display = "block";

      document.querySelectorAll('[id^="nav-"]').forEach(n => n.classList.remove("active-link"));
      const navElement = document.getElementById("nav-" + view);
      if (navElement) navElement.classList.add("active-link");

      const titles = { dashboard: "Dashboard", processos: "Processos", recomendacoes: "Plano de Ação", auditoria: "Auditoria do Sistema" };
      document.getElementById("page-title").textContent = titles[view] || view;

      renderCurrentView();
    }

    function filterDataByUser(data) {
      if (!userSession || userSession.perfil === "Administrador Geral - CAS ADM") return data;

      const userSetor = userSession.setor || "";
      const processosPermitidos = data.filter(item => item.tipo === "processo" && (item.setores_envolvidos || "").includes(userSetor));
      const processosIds = processosPermitidos.map(p => p.processo_id);

      return data.filter(item => {
        if (item.tipo === "processo") return processosIds.includes(item.processo_id);
        if (item.tipo === "achado" || item.tipo === "recomendacao") return processosIds.includes(item.processo_id);
        return false;
      });
    }

    function renderCurrentView() {
      const filtered = filterDataByUser(allData);

      if (currentView === "dashboard") renderDashboard(filtered);
      else if (currentView === "processos") renderProcessos(filtered);
      else if (currentView === "recomendacoes") renderRecomendacoes(filtered);
      else if (currentView === "auditoria") renderAuditView();
    }

    // ============================================================
    // 6) DASHBOARD (mais interativo)
    // ============================================================
    function getRecDerived(rec) {
      const acoes = Array.isArray(rec?.acoes) ? rec.acoes : [];
      const w = (st) => st === "Concluída" ? 1 : (st === "Em andamento" ? 0.5 : 0);
      const sum = acoes.reduce((acc, a) => acc + w(a.status), 0);
      const progresso = acoes.length ? Math.round((sum / acoes.length) * 100) : (Number.isFinite(Number(rec.progresso)) ? Number(rec.progresso) : 0);

      const today = new Date(); today.setHours(0,0,0,0);
      const anyOverdue = acoes.some(a => a.when && (new Date(a.when).setHours(0,0,0,0) < today.getTime()) && a.status !== "Concluída");
      let status = rec.status || "Pendente";
      if (acoes.length) {
        if (anyOverdue) status = "Atrasado";
        else if (acoes.every(a => a.status === "Concluída")) status = "Concluído";
        else if (acoes.some(a => a.status === "Em andamento" || a.status === "Concluída")) status = "Em Execução";
        else status = "Pendente";
      }
      return { progresso, status };
    }

    function renderDashboard(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const recomendacoes = data.filter(d => d.tipo === "recomendacao").map(r => ({...r, ...getRecDerived(r)}));
      const locais = [...new Set(processos.map(p => p.unidade).filter(Boolean))];

      document.getElementById("dash-total-locais").textContent = locais.length;
      document.getElementById("dash-total-processos").textContent = processos.length;
      document.getElementById("dash-total-recomendacoes").textContent = recomendacoes.length;
      document.getElementById("dash-atrasadas").textContent = recomendacoes.filter(r => r.status === "Atrasado").length;

      const box = document.getElementById("locais-dashboard");
      const empty = document.getElementById("dashboard-empty");

      if (!locais.length) {
        box.innerHTML = "";
        empty.style.display = "block";
        refreshIcons();
        return;
      }

      empty.style.display = "none";

      box.innerHTML = locais.map(local => {
        const recsLocal = recomendacoes.filter(r => {
          const proc = processos.find(p => p.processo_id === r.processo_id);
          return proc && proc.unidade === local;
        });

        const concl = recsLocal.filter(r => r.status === "Concluído").length;
        const total = recsLocal.length || 1;
        const pct = Math.round((concl / total) * 100);

        return `
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 hover:bg-white transition-all card-hover">
            <div class="flex items-start justify-between mb-2">
              <div>
                <div class="font-extrabold text-slate-800">${escapeHtml(local)}</div>
                <div class="text-xs text-slate-500">${recsLocal.length} recomendação(ões)</div>
              </div>
              <i data-lucide="building-2" class="w-6 h-6 text-slate-400"></i>
            </div>

            <div class="mt-3">
              <div class="flex items-center justify-between text-xs text-slate-600 mb-1">
                <span class="font-bold">Conclusão</span><span class="font-extrabold">${pct}%</span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2">
                <div class="h-2 rounded-full bg-emerald-500" style="width:${pct}%"></div>
              </div>
            </div>

            <div class="mt-3 text-xs text-slate-600">
              <span class="font-bold">Processos:</span> ${processos.filter(p => p.unidade === local).length}
            </div>
          </div>
        `;
      }).join("");

      refreshIcons();
    }

    // ============================================================
    // 7) PROCESSOS (resumo)
    // ============================================================
    function renderProcessos(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const container = document.getElementById("processos-list");
      const empty = document.getElementById("processos-empty");

      if (!processos.length) {
        container.innerHTML = "";
        empty.style.display = "block";
        refreshIcons();
        return;
      }

      empty.style.display = "none";

      container.innerHTML = processos
        .sort((a,b) => (a.processo_numero||"").localeCompare(b.processo_numero||""))
        .map(p => `
          <div class="bg-white rounded-2xl border border-slate-200 p-6 card-hover">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-extrabold text-slate-900">${escapeHtml(p.processo_numero || "-")}</div>
                <div class="text-sm text-slate-600">${escapeHtml(p.unidade || "-")} • ${escapeHtml(p.periodo || "-")}</div>
                <div class="text-sm text-slate-500 mt-2">${escapeHtml(p.objeto || "-")}</div>
                <div class="text-xs text-slate-500 mt-3">
                  <span class="font-bold">Setores:</span> ${escapeHtml(p.setores_envolvidos || "-")}
                </div>
              </div>
              <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-extrabold">${escapeHtml(p.eixo || "-")}</span>
            </div>
          </div>
        `).join("");

      refreshIcons();
    }

    // ============================================================
    // 8) RECOMENDAÇÕES (placeholder simples para manter arquivo rodando)
    //    Se você quiser, eu te mando a versão completa com cards, ações 5W2H e agrupamento como no arquivo anterior.
    // ============================================================
    const recFilters = { busca:"", unidade:"", processoId:"", area:"", status:"", prioridade:"", somenteAtrasadas:false };

    function populateRecFilterOptions(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const unidades = [...new Set(processos.map(p => p.unidade).filter(Boolean))].sort();

      const unidadeSel = document.getElementById("filtro-unidade");
      const procSel = document.getElementById("filtro-processo");
      const areaSel = document.getElementById("filtro-area");

      if (!unidadeSel || !procSel || !areaSel) return;

      unidadeSel.innerHTML = `<option value="">Todas</option>` + unidades.map(u => `<option value="${escapeAttr(u)}">${escapeHtml(u)}</option>`).join("");
      procSel.innerHTML = `<option value="">Todos</option>` + processos.map(p => `<option value="${p.processo_id}">${escapeHtml(p.processo_numero || p.processo_id)}</option>`).join("");

      areaSel.innerHTML = `<option value="">Todas</option>`;
    }

    function applyRecFilters() {
      recFilters.busca = (document.getElementById("filtro-busca").value || "").toLowerCase().trim();
      recFilters.unidade = document.getElementById("filtro-unidade").value || "";
      recFilters.processoId = document.getElementById("filtro-processo").value || "";
      recFilters.area = document.getElementById("filtro-area").value || "";
      recFilters.status = document.getElementById("filtro-status").value || "";
      recFilters.prioridade = document.getElementById("filtro-prioridade").value || "";
      recFilters.somenteAtrasadas = !!document.getElementById("filtro-atrasadas").checked;
      renderCurrentView();
    }

    function resetRecFilters() {
      recFilters.busca = "";
      recFilters.unidade = "";
      recFilters.processoId = "";
      recFilters.area = "";
      recFilters.status = "";
      recFilters.prioridade = "";
      recFilters.somenteAtrasadas = false;
      renderCurrentView();
    }

    function renderRecomendacoes(data) {
      populateRecFilterOptions(data);

      const container = document.getElementById("recomendacoes-grouped");
      const empty = document.getElementById("recomendacoes-empty");
      const recs = data.filter(d => d.tipo === "recomendacao");

      if (!recs.length) {
        container.innerHTML = "";
        empty.style.display = "block";
        refreshIcons();
        return;
      }

      empty.style.display = "none";
      container.innerHTML = `
        <div class="bg-white border border-slate-200 rounded-2xl p-6">
          <div class="font-extrabold text-slate-800">Módulo Plano de Ação</div>
          <div class="text-sm text-slate-600 mt-1">Recomendações cadastradas: ${recs.length}</div>
          <div class="text-xs text-slate-500 mt-3">Se você quiser, eu reenvio aqui a versão completa com 5W2H, progresso automático e agrupamento por processo e área.</div>
        </div>
      `;
      refreshIcons();
    }

    // ============================================================
    // 9) AUDITORIA (somente admin)
    // ============================================================
    function renderAuditView() {
      const tbody = document.getElementById("audit-table-body");
      const empty = document.getElementById("audit-empty");
      if (!tbody || !empty) return;

      const audit = getStoredAudit();

      if (!audit.length) {
        tbody.innerHTML = "";
        empty.style.display = "block";
        refreshIcons();
        return;
      }

      empty.style.display = "none";
      tbody.innerHTML = audit.slice(0, 300).map(a => `
        <tr class="hover:bg-slate-50">
          <td class="py-3 pr-4 text-slate-700 font-semibold">${escapeHtml(formatBR(a.at))}</td>
          <td class="py-3 pr-4 text-slate-800 font-extrabold">${escapeHtml(a.user)}</td>
          <td class="py-3 pr-4 text-slate-600">${escapeHtml(a.perfil)}</td>
          <td class="py-3 pr-4">
            <span class="text-[11px] px-2 py-1 rounded-full font-extrabold ${
              a.action === "DELETE" ? "bg-red-100 text-red-700" :
              a.action === "UPDATE" ? "bg-amber-100 text-amber-700" :
              "bg-emerald-100 text-emerald-700"
            }">${escapeHtml(a.action)}</span>
          </td>
          <td class="py-3 pr-4 text-slate-700">${escapeHtml(a.entityType)}</td>
          <td class="py-3 pr-4 text-slate-500 text-xs break-all">${escapeHtml(a.entityId || "")}</td>
          <td class="py-3 text-slate-600 text-xs">${escapeHtml(a.details || "")}</td>
        </tr>
      `).join("");

      refreshIcons();
    }

    function clearAuditLog() {
      if (!userSession || userSession.perfil !== "Administrador Geral - CAS ADM") return;
      showConfirmModal("Limpar auditoria", "Deseja limpar o registro de auditoria? Isso remove o histórico.", () => {
        setStoredAudit([]);
        renderAuditView();
        showToast("Auditoria limpa.", "success");
      });
    }

    function exportAuditCsv() {
      if (!userSession || userSession.perfil !== "Administrador Geral - CAS ADM") return;

      const audit = getStoredAudit();
      if (!audit.length) { showToast("Sem dados para exportar", "error"); return; }

      const headers = ["DataHora","Usuario","Perfil","Acao","Entidade","Identificador","Detalhes"];
      const rows = audit.map(a => [
        formatBR(a.at),
        a.user,
        a.perfil,
        a.action,
        a.entityType,
        a.entityId || "",
        (a.details || "").replaceAll("\n"," ").replaceAll("\r"," ")
      ]);

      const csv = [headers.join(";"), ...rows.map(r => r.map(x => `"${String(x||"").replaceAll('"','""')}"`).join(";"))].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "auditoria_modificacoes.csv";
      a.click();
      URL.revokeObjectURL(url);
      showToast("CSV exportado!", "success");
    }

    // ============================================================
    // 10) MODAL Processo: setores sincronizam com login
    // ============================================================
    function closeModal(type) { document.getElementById("modal-" + type).style.display = "none"; }

    function openNewProcessoModal() {
      setoresProcesso = [];
      renderSetoresProcesso();
      document.getElementById("modal-processo").style.display = "flex";
      document.getElementById("processo-form").reset();
      document.getElementById("eixo_outro").style.display = "none";
      refreshIcons();
    }

    function toggleEixoOutro() {
      const eixo = document.getElementById("eixo").value;
      document.getElementById("eixo_outro").style.display = (eixo === "Outro") ? "block" : "none";
    }

    let setoresProcesso = [];
    function adicionarSetorProcesso() {
      const input = document.getElementById("setor_processo_input");
      const setor = (input.value || "").trim();
      if (!setor) return;

      if (!setoresProcesso.includes(setor)) {
        setoresProcesso.push(setor);
        input.value = "";
        renderSetoresProcesso();
      } else showToast("Este setor já foi adicionado", "error");
    }
    function removerSetorProcesso(index) { setoresProcesso.splice(index, 1); renderSetoresProcesso(); }
    function renderSetoresProcesso() {
      const container = document.getElementById("setores-processo-container");
      container.innerHTML = setoresProcesso.map((setor, index) => `
        <div class="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-xl border border-blue-100">
          <span class="flex-1 text-sm text-blue-900 font-extrabold">${escapeHtml(setor)}</span>
          <button type="button" onclick="removerSetorProcesso(${index})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");
      refreshIcons();
    }

    document.getElementById("processo-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      ensureDataSdk();

      if (setoresProcesso.length === 0) { showToast("Adicione pelo menos um setor envolvido", "error"); return; }

      const btn = document.getElementById("submit-processo-btn");
      const btnText = document.getElementById("submit-processo-text");
      btn.disabled = true; btnText.textContent = "Salvando...";

      try {
        let eixo = document.getElementById("eixo").value;
        if (eixo === "Outro") {
          const eixoOutroValue = (document.getElementById("eixo_outro").value || "").trim();
          if (!eixoOutroValue) { showToast("Especifique o nome do novo eixo", "error"); return; }
          eixo = eixoOutroValue;
        }

        const processoNumero = (document.getElementById("processo_numero").value || "").trim();
        const unidade = (document.getElementById("unidade").value || "").trim();
        const objeto = (document.getElementById("objeto").value || "").trim();
        const periodo = (document.getElementById("periodo").value || "").trim();

        if (!processoNumero || !unidade || !objeto || !periodo || !eixo) {
          showToast("Preencha todos os campos obrigatórios do processo", "error");
          return;
        }

        const processoId = "proc_" + Date.now() + "_" + Math.random().toString(36).slice(2);

        const processo = {
          tipo: "processo",
          processo_id: processoId,
          processo_numero: processoNumero,
          eixo: eixo,
          unidade: unidade,
          objeto: objeto,
          periodo: periodo,
          responsavel: (document.getElementById("responsavel").value || "").trim(),
          auditor: (document.getElementById("auditor").value || "").trim(),
          setores_envolvidos: setoresProcesso.join("; "),
          created_at: nowIso(),
          updated_at: nowIso(),
          updated_by: userSession ? userSession.nome : "Sistema"
        };

        const result = await window.dataSdk.create(processo);

        if (result && result.isOk) {
          // ✅ sincroniza os setores imediatamente para a lista suspensa do login
          rebuildSetorCatalog();
          popularSetoresLogin();

          setoresProcesso = [];
          renderSetoresProcesso();
          document.getElementById("processo-form").reset();
          document.getElementById("eixo_outro").style.display = "none";
          closeModal("processo");
          showToast("Processo cadastrado com sucesso!", "success");
        } else showToast("Erro ao salvar processo: " + (result?.error || "Falha"), "error");
      } catch (error) {
        console.error("Erro no cadastro:", error);
        showToast("Erro inesperado ao cadastrar processo: " + String(error.message || error), "error");
      } finally {
        btn.disabled = false; btnText.textContent = "Salvar Processo";
      }
    });

    // ============================================================
    // 11) EXPORT PDF (mantive menu, você pode plugar seus PDFs do arquivo anterior)
    // ============================================================
    function exportMenuOpen() {
      const filteredData = filterDataByUser(allData);
      const processos = filteredData.filter(d => d.tipo === "processo");

      const planoList = document.getElementById("processos-plano-list");
      const formalList = document.getElementById("processos-formal-list");

      if (!processos.length) {
        planoList.innerHTML = '<p class="text-sm text-slate-400">Nenhum processo cadastrado</p>';
        formalList.innerHTML = '<p class="text-sm text-slate-400">Nenhum processo cadastrado</p>';
      } else {
        planoList.innerHTML = processos.map(p => `
          <button type="button" onclick="exportPDFProcesso('${p.processo_id}')" class="w-full text-left px-3 py-2 rounded-xl hover:bg-blue-100 text-sm text-slate-700 transition-colors font-semibold">
            ${escapeHtml(p.processo_numero)} - ${escapeHtml(p.unidade)}
          </button>
        `).join("");

        formalList.innerHTML = processos.map(p => `
          <button type="button" onclick="exportPDFFormalProcesso('${p.processo_id}')" class="w-full text-left px-3 py-2 rounded-xl hover:bg-purple-100 text-sm text-slate-700 transition-colors font-semibold">
            ${escapeHtml(p.processo_numero)} - ${escapeHtml(p.unidade)}
          </button>
        `).join("");
      }

      document.getElementById("modal-export").style.display = "flex";
      refreshIcons();
    }
    function exportPDFGeral(){ showToast("Conecte aqui o PDF do módulo completo (5W2H).", "error"); }
    function exportPDFProcesso(){ showToast("Conecte aqui o PDF por processo (5W2H).", "error"); }
    function exportPDFFormalGeral(){ showToast("Conecte aqui o PDF formal geral.", "error"); }
    function exportPDFFormalProcesso(){ showToast("Conecte aqui o PDF formal por processo.", "error"); }

    // ============================================================
    // 12) CONFIRM + TOAST + ESCAPE
    // ============================================================
    function showConfirmModal(title, message, onConfirm) {
      const modal = document.createElement("div");
      modal.style.cssText = "position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999;";
      modal.innerHTML = `
        <div style="background:white; padding:24px; border-radius:16px; max-width:420px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
          <h3 style="font-size:18px; font-weight:800; color:#0f172a; margin-bottom:12px;">${escapeHtml(title)}</h3>
          <p style="color:#475569; margin-bottom:24px;">${escapeHtml(message)}</p>
          <div style="display:flex; gap:12px; justify-content:flex-end;">
            <button id="cancel-action" style="padding:10px 16px; border:1px solid #cbd5e1; border-radius:12px; background:white; color:#334155; cursor:pointer; font-weight:700;">Cancelar</button>
            <button id="confirm-action" style="padding:10px 16px; border:none; border-radius:12px; background:#dc2626; color:white; cursor:pointer; font-weight:800;">Confirmar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById("cancel-action").onclick = () => document.body.removeChild(modal);
      document.getElementById("confirm-action").onclick = async () => {
        document.body.removeChild(modal);
        await onConfirm();
      };
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      const bgColor = type === "error" ? "#dc2626" : "#10b981";
      toast.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 14px 18px; border-radius: 14px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.12); z-index: 9999; font-weight: 800; max-width: 360px;`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.transition = "opacity 0.25s";
        toast.style.opacity = "0";
        setTimeout(() => { try { document.body.removeChild(toast); } catch {} }, 260);
      }, 2600);
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function escapeAttr(str) { return escapeHtml(str).replace(/"/g, "&quot;"); }
  </script>
</body>
</html>
