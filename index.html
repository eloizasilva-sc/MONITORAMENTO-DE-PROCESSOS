<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Processos Auditados | Executive View</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SDKs (quando existir no ambiente). Se não existir, cai no localStorage. -->
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --card:#ffffff;
      --border:#e6eaf2;
      --text:#0f172a;
      --muted:#64748b;
      --shadow1:0 6px 16px rgba(0,0,0,0.08);
      --shadow2:0 12px 26px rgba(0,0,0,0.12);
      --blue:#2563eb;
      --green:#16a34a;
      --red:#ef4444;
    }

    body { font-family: 'Plus Jakarta Sans', 'Inter', sans-serif; background-color: #f8fafc; }
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .progress-glow { box-shadow: 0 0 15px rgba(37, 99, 235, 0.3); }
    .step-checkbox:checked + div span { text-decoration: line-through; color: #94a3b8; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    .dash-card:hover{ box-shadow:var(--shadow2); transform:translateY(-2px); transition:0.2s; }
    .active-link { background-color: rgba(37, 99, 235, 0.1); color: #2563eb; font-weight: 600; border-right: 3px solid #2563eb; }
    .badge { display:inline-flex; align-items:center; gap:.375rem; padding:.25rem .6rem; border-radius:999px; font-weight:800; font-size:11px; }
    .badge-slate { background:#f1f5f9; color:#475569; }
    .badge-blue { background:#dbeafe; color:#1d4ed8; }
    .badge-emerald { background:#d1fae5; color:#047857; }
    .badge-amber { background:#fef3c7; color:#b45309; }
    .badge-red { background:#fee2e2; color:#b91c1c; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-full">

  <!-- LOGIN -->
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-gradient-to-r from-slate-600 to-slate-700 p-8 text-white text-center">
        <i data-lucide="shield-check" class="w-16 h-16 mx-auto mb-4"></i>
        <h1 class="text-2xl font-bold mb-2">PROCESSOS AUDITADOS</h1>
        <p class="text-sm opacity-90">SESAP/RN</p>
      </div>
      <div class="p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Selecione seu Perfil</h2>
        <form id="login-form" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Usuário *</label>
            <select id="login-perfil" required onchange="toggleSetorField()"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
              <option value="">Selecione...</option>
              <option value="Administrador Geral - CAS ADM">Administrador Geral - CAS ADM</option>
              <option value="Técnico">Técnico (Por Setor)</option>
            </select>
          </div>

          <div id="setor-field" style="display:none;">
            <label class="block text-sm font-medium text-slate-700 mb-2">Setor Responsável *</label>
            <select id="login-setor"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
              <option value="">Selecione seu setor...</option>
            </select>
            <p class="text-xs text-slate-500 mt-2">Você verá apenas processos do seu setor cadastrados pelo Administrador</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Nome Completo *</label>
            <input type="text" id="login-nome" required placeholder="Digite seu nome"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>

          <button type="submit" id="login-btn"
            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl">
            Entrar no Sistema
          </button>
        </form>

        <div class="mt-6 pt-6 border-t border-slate-200 text-center text-xs text-slate-500">
          <p>Sistema de Gestão de Auditorias</p>
          <p class="mt-1">Desenvolvido por Maria Eloiza da Silva - CAS-Administrativo</p>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;" class="flex h-full overflow-hidden w-full">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col hidden md:flex">
      <div class="p-6 flex items-center gap-3 text-white border-b border-slate-800">
        <i data-lucide="shield-check" class="text-slate-400"></i>
        <span id="system-title" class="font-bold text-lg tracking-tight">AUDITORIA 5W2H</span>
      </div>

      <div class="px-4 py-4 bg-slate-800 border-b border-slate-700">
        <div class="flex items-center gap-3 mb-2">
          <div class="h-10 w-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm" id="user-avatar">AD</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-white truncate" id="user-name-sidebar">Usuário</p>
            <p class="text-xs text-slate-400" id="user-role-sidebar">Carregando...</p>
          </div>
        </div>
        <div id="user-setor-badge" style="display:none;" class="mt-2 px-3 py-1.5 bg-blue-600 bg-opacity-20 border border-blue-500 rounded-lg">
          <p class="text-xs font-semibold text-blue-300 text-center" id="user-setor-text"></p>
        </div>
      </div>

      <nav class="flex-1 px-4 space-y-2 mt-4">
        <a href="#" onclick="showView('dashboard'); return false;" id="nav-dashboard" class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all active-link">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
        </a>
        <a href="#" onclick="showView('processos'); return false;" id="nav-processos" class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all">
          <i data-lucide="clipboard-list" class="w-5 h-5"></i> Processos
        </a>
        <a href="#" onclick="showView('recomendacoes'); return false;" id="nav-recomendacoes" class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all">
          <i data-lucide="list-checks" class="w-5 h-5"></i> Planos de Ação
        </a>
        <a href="#" onclick="showView('auditoria'); return false;" id="nav-auditoria" class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all" style="display:none;">
          <i data-lucide="file-search" class="w-5 h-5"></i> Auditoria Sistema
        </a>
        <a href="#" onclick="exportMenuOpen(); return false;" class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all">
          <i data-lucide="download" class="w-5 h-5"></i> Exportar PDF
        </a>
      </nav>

      <div class="p-4 border-t border-slate-800">
        <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
          <i data-lucide="log-out" class="w-4 h-4"></i> Sair
        </button>
        <div class="mt-3 text-xs text-slate-500 text-center">
          <span id="institution-name">SESAP/RN</span>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto bg-[#f8fafc]">

      <!-- TOPBAR -->
      <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-16 flex items-center justify-between px-8 sticky top-0 z-30">
        <div>
          <h1 id="page-title" class="font-bold text-lg text-slate-800">Dashboard</h1>
          <p id="page-subtitle" class="text-xs text-slate-500"></p>
        </div>

        <div class="flex items-center gap-4">
          <button onclick="openNewProcessModal()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-slate-200 flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
          <div class="h-8 w-8 bg-slate-900 rounded-full flex items-center justify-center text-white font-medium text-sm" id="user-avatar-header">AD</div>
        </div>
      </header>

      <!-- DASHBOARD -->
      <div id="view-dashboard" class="p-8 max-w-[1600px] mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <p class="text-sm font-bold text-slate-500 uppercase tracking-wide">Locais</p>
            <h3 id="dash-total-locais" class="text-4xl font-extrabold mt-2 text-slate-800">0</h3>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <p class="text-sm font-bold text-slate-500 uppercase tracking-wide">Processos</p>
            <h3 id="dash-total-processos" class="text-4xl font-extrabold mt-2 text-slate-800">0</h3>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <p class="text-sm font-bold text-slate-500 uppercase tracking-wide">Planos Ativos</p>
            <h3 id="dash-total-recomendacoes" class="text-4xl font-extrabold mt-2 text-blue-600">0</h3>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <p class="text-sm font-bold text-red-500 uppercase tracking-wide">Atenção</p>
            <h3 id="dash-atrasadas" class="text-4xl font-extrabold mt-2 text-red-600">0</h3>
          </div>
        </div>

        <div class="mb-6">
          <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
            <i data-lucide="map-pin" class="w-7 h-7 text-slate-600"></i> Auditorias por Local
          </h2>
          <p class="text-slate-500 mt-1">Clique em um local para ver os detalhes das recomendações</p>
        </div>

        <div id="locais-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div id="dashboard-empty" style="display:none;" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center">
          <i data-lucide="folder-open" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-bold text-slate-700 mb-2">Nenhuma auditoria cadastrada</h3>
          <p class="text-slate-500 mb-6">Comece criando seu primeiro processo de auditoria</p>
          <button onclick="openNewProcessModal()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 inline-flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
        </div>
      </div>

      <!-- PROCESSOS -->
      <div id="view-processos" style="display:none;" class="p-8 max-w-[1600px] mx-auto">
        <div id="processos-list" class="space-y-6"></div>

        <div id="processos-empty" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center">
          <i data-lucide="folder-open" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-bold text-slate-700 mb-2">Nenhum processo cadastrado</h3>
          <button onclick="openNewProcessModal()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-medium hover:bg-slate-700 inline-flex items-center gap-2 mt-4">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
        </div>
      </div>

      <!-- PLANOS -->
      <div id="view-recomendacoes" style="display:none;" class="p-8 max-w-[1600px] mx-auto">

        <div class="glass-card rounded-2xl shadow-sm border border-slate-200 p-6 mb-8">
          <div class="flex flex-col lg:flex-row gap-4 items-end">
            <div class="flex-1 w-full">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 block">Buscar</label>
              <input id="filtro-busca" type="text" placeholder="Pesquisar por termo..." oninput="applyRecFilters()"
                class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 block">Status</label>
              <select id="filtro-status" onchange="applyRecFilters()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white">
                <option value="">Todos</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Execução">Em Execução</option>
                <option value="Atrasado">Atrasado</option>
                <option value="Concluído">Concluído</option>
              </select>
            </div>

            <button onclick="resetRecFilters()" class="px-4 py-2 text-slate-500 hover:text-blue-600 font-bold text-sm">Limpar</button>
          </div>
        </div>

        <div id="recomendacoes-grouped" class="space-y-10"></div>

        <div id="recomendacoes-empty" style="display:none;" class="text-center py-20">
          <i data-lucide="clipboard-check" class="w-20 h-20 text-slate-200 mx-auto mb-4"></i>
          <h3 class="text-2xl font-bold text-slate-400">Nenhum plano de ação encontrado</h3>
        </div>
      </div>

      <!-- AUDITORIA SISTEMA (ADM GERAL) -->
      <div id="view-auditoria" style="display:none;" class="p-8 max-w-[1600px] mx-auto">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
          <div class="flex items-start justify-between gap-4 flex-col lg:flex-row">
            <div>
              <h2 class="text-xl font-bold text-slate-800">Auditoria do Sistema</h2>
              <p class="text-sm text-slate-600 mt-1">Registro de logs do sistema.</p>
            </div>
            <div class="flex gap-2">
              <button onclick="exportAuditJSON()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 flex items-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i> JSON
              </button>
              <button onclick="clearAuditLog()" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 flex items-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Limpar
              </button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <input id="audit-busca" type="text" placeholder="Buscar..." oninput="renderAuditView()" class="w-full px-3 py-2 border rounded-lg">
            <select id="audit-acao" onchange="renderAuditView()" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Todas Ações</option>
              <option value="LOGIN">LOGIN</option>
              <option value="CREATE">CREATE</option>
              <option value="UPDATE">UPDATE</option>
              <option value="DELETE">DELETE</option>
            </select>
            <select id="audit-tipo" onchange="renderAuditView()" class="w-full px-3 py-2 border rounded-lg">
              <option value="">Todos Tipos</option>
              <option value="processo">Processo</option>
              <option value="achado">Achado</option>
              <option value="recomendacao">Recomendação</option>
            </select>
            <button onclick="resetAuditFilters()" class="border px-3 py-2 rounded-lg">Limpar</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left">Data</th>
                  <th class="px-4 py-3 text-left">Usuário</th>
                  <th class="px-4 py-3 text-left">Ação</th>
                  <th class="px-4 py-3 text-left">Resumo</th>
                </tr>
              </thead>
              <tbody id="audit-table-body"></tbody>
            </table>
          </div>
          <div id="audit-empty" class="p-10 text-center text-slate-500" style="display:none;">Nenhum registro.</div>
        </div>
      </div>

    </main>
  </div>

  <!-- MODAL PROCESSO -->
  <div id="modal-processo" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-bold text-xl text-slate-800" id="modal-processo-title">Novo Processo</h2>
        <button onclick="closeModal('processo')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
      </div>

      <form id="processo-form" class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="processo_numero" required placeholder="Nº Processo SEI" class="w-full px-4 py-2 border rounded-lg">
          <select id="eixo" required onchange="toggleEixoOutro()" class="w-full px-4 py-2 border rounded-lg">
            <option value="">Eixo...</option>
            <option value="Orçamento e Estoques">Orçamento e Estoques</option>
            <option value="Demandas Judiciais">Demandas Judiciais</option>
            <option value="Contratos">Contratos</option>
            <option value="Outro">Outro</option>
          </select>

          <input type="text" id="eixo_outro" placeholder="Novo eixo..." style="display:none;" class="w-full px-4 py-2 border rounded-lg md:col-span-2">
          <input type="text" id="unidade" required placeholder="Unidade/Hospital (Local auditado)" class="w-full px-4 py-2 border rounded-lg">
          <input type="text" id="periodo" required placeholder="Período (ex: Jan/2024)" class="w-full px-4 py-2 border rounded-lg">

          <div class="md:col-span-2">
            <input type="text" id="objeto" required placeholder="Objeto da Auditoria" class="w-full px-4 py-2 border rounded-lg">
          </div>

          <input type="text" id="responsavel" placeholder="Responsável Unidade" class="w-full px-4 py-2 border rounded-lg">
          <input type="text" id="auditor" placeholder="Auditor Responsável" class="w-full px-4 py-2 border rounded-lg">

          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Setores Envolvidos (Técnicos)</label>
            <div id="setores-processo-container" class="space-y-2 mb-2"></div>
            <div class="flex gap-2">
              <input type="text" id="setor_processo_input" placeholder="Ex: CAS, SUAH..." class="flex-1 px-4 py-2 border rounded-lg">
              <button type="button" onclick="adicionarSetorProcesso()" class="bg-blue-600 text-white px-4 rounded-lg">Add</button>
            </div>
          </div>
        </div>

        <div class="flex gap-3 justify-end pt-4 border-t">
          <button type="button" onclick="closeModal('processo')" class="px-4 py-2 border rounded-lg">Cancelar</button>
          <button type="submit" id="submit-processo-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg">
            <span id="submit-processo-text">Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL ACHADO -->
  <div id="modal-achado" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex justify-between">
        <h2 class="font-bold text-xl" id="modal-achado-title">Novo Achado</h2>
        <button onclick="closeModal('achado')"><i data-lucide="x"></i></button>
      </div>

      <form id="achado-form" class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <input id="achado_numero" required placeholder="Nº Achado" class="border px-4 py-2 rounded-lg">
          <input id="achado_subitem" placeholder="Subitem" class="border px-4 py-2 rounded-lg">
          <select id="grau_risco" required class="border px-4 py-2 rounded-lg">
            <option value="">Risco...</option>
            <option value="Alto">Alto</option>
            <option value="Médio">Médio</option>
            <option value="Baixo">Baixo</option>
          </select>
          <select id="impacto" onchange="toggleImpactoOutro()" class="border px-4 py-2 rounded-lg">
            <option value="">Impacto...</option>
            <option value="Financeiro">Financeiro</option>
            <option value="Operacional">Operacional</option>
            <option value="Outro">Outro</option>
          </select>

          <input id="impacto_outro" placeholder="Outro impacto" style="display:none;" class="border px-4 py-2 rounded-lg col-span-2">

          <textarea id="achado_descricao" required rows="3" placeholder="Descrição do Achado" class="border px-4 py-2 rounded-lg col-span-2"></textarea>
          <input id="responsavel_achado" placeholder="Responsável pelo Achado" class="border px-4 py-2 rounded-lg col-span-2">
          <input id="evidencia" placeholder="Evidência" class="border px-4 py-2 rounded-lg col-span-2">
        </div>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal('achado')" class="border px-4 py-2 rounded-lg">Cancelar</button>
          <button type="submit" id="submit-achado-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
            <span id="submit-achado-text">Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL RECOMENDAÇÃO / PLANO -->
  <div id="modal-recomendacao" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex justify-between sticky top-0 bg-white z-10">
        <h2 class="font-bold text-xl">Plano de Ação</h2>
        <button onclick="closeModal('recomendacao')"><i data-lucide="x"></i></button>
      </div>

      <form id="recomendacao-form" class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="recomendacao_numero" required placeholder="Nº Rec" class="border px-4 py-2 rounded-lg">
          <input id="recomendacao_subitem" placeholder="Subitem" class="border px-4 py-2 rounded-lg">

          <!-- VÍNCULO AO ACHADO + NOME DO ACHADO -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Vinculado ao Achado</label>
            <select id="recomendacao_achado_id" class="w-full border px-4 py-2 rounded-lg" onchange="renderAchadoPreviewInRecModal()">
              <option value="">(Opcional) Selecione um achado...</option>
            </select>
            <p id="achado-preview" class="text-xs text-slate-500 mt-2"></p>
          </div>

          <select id="prioridade" required class="border px-4 py-2 rounded-lg">
            <option value="">Prioridade...</option>
            <option value="Alta">Alta</option>
            <option value="Média">Média</option>
            <option value="Baixa">Baixa</option>
          </select>

          <input id="prazo_global" required placeholder="Prazo Global" class="border px-4 py-2 rounded-lg">

          <textarea id="recomendacao_texto" required rows="3" placeholder="O que deve ser feito (Recomendação)" class="border px-4 py-2 rounded-lg md:col-span-2"></textarea>

          <!-- INDICADOR E RESULTADO -->
          <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Indicador</label>
              <input id="indicador" placeholder="Ex: % de recomendações concluídas no prazo" class="w-full border px-4 py-2 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Resultado</label>
              <input id="resultado" placeholder="Ex: redução de 30% no tempo de resposta" class="w-full border px-4 py-2 rounded-lg">
            </div>
          </div>

          <input id="responsavel_recomendacao" placeholder="Responsável Principal" class="border px-4 py-2 rounded-lg">

          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Áreas Responsáveis</label>
            <div id="areas-container" class="space-y-1 mb-2"></div>
            <div class="flex gap-2">
              <input id="area_input" placeholder="Nova área..." class="flex-1 border px-4 py-2 rounded-lg">
              <button type="button" onclick="adicionarArea()" class="bg-blue-600 text-white px-4 rounded-lg">Add</button>
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Áreas Envolvidas</label>
            <div id="areas-envolvidas-container" class="space-y-1 mb-2"></div>
            <div class="flex gap-2">
              <input id="area_envolvida_input" placeholder="Nova área..." class="flex-1 border px-4 py-2 rounded-lg">
              <button type="button" onclick="adicionarAreaEnvolvida()" class="bg-purple-600 text-white px-4 rounded-lg">Add</button>
            </div>
          </div>
        </div>

        <!-- ETAPAS / AÇÕES -->
        <div class="border-t pt-4">
          <h3 class="font-bold text-lg mb-2">Etapas / Ações</h3>

          <div class="flex justify-between items-end mb-4 bg-slate-50 p-3 rounded-lg">
            <div>
              <span class="text-xs text-slate-500 font-bold uppercase">Progresso Calculado</span>
              <div class="text-2xl font-bold"><span id="calc-progresso">0</span>%</div>
            </div>
            <span id="calc-status" class="px-2 py-1 bg-slate-200 rounded text-xs font-bold">Pendente</span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 p-4 border rounded-xl">
            <input id="acao_desc" placeholder="Descrição da etapa" class="border px-3 py-2 rounded-lg md:col-span-2">
            <input id="acao_resp" placeholder="Responsável" class="border px-3 py-2 rounded-lg">
            <input id="acao_prazo" type="date" class="border px-3 py-2 rounded-lg">
            <input id="acao_custo" placeholder="Custo (R$)" class="border px-3 py-2 rounded-lg">
            <select id="acao_status" class="border px-3 py-2 rounded-lg">
              <option value="Não iniciada">Não iniciada</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Concluída">Concluída</option>
            </select>

            <button type="button" onclick="addOrUpdateAcaoTemp()" id="acao_submit_btn"
              class="md:col-span-2 bg-blue-600 text-white py-2 rounded-lg font-bold">
              + Adicionar Etapa
            </button>
            <button type="button" onclick="cancelEditAcaoTemp()" id="acao_cancel_btn"
              class="md:col-span-2 border py-2 rounded-lg font-bold hidden">
              Cancelar edição
            </button>
          </div>

          <div id="acoes-temp-list" class="space-y-2"></div>
          <div id="acoes-temp-empty" class="text-slate-400 text-center text-sm">Nenhuma etapa adicionada.</div>
        </div>

        <!-- RELATÓRIO FORMAL -->
        <div class="border-t pt-4">
          <h3 class="font-bold text-sm text-slate-500 uppercase mb-2">Relatório Formal (Opcional)</h3>
          <textarea id="evidencias_cumprimento" rows="2" placeholder="Evidências..." class="w-full border px-3 py-2 rounded-lg mb-2"></textarea>
          <textarea id="justificativa_nao_cumprimento" rows="2" placeholder="Justificativas..." class="w-full border px-3 py-2 rounded-lg mb-2"></textarea>
          <textarea id="resultados_percebidos" rows="2" placeholder="Resultados..." class="w-full border px-3 py-2 rounded-lg"></textarea>
        </div>

        <div class="flex justify-end gap-3 border-t pt-4">
          <button type="button" onclick="closeModal('recomendacao')" class="border px-6 py-2 rounded-lg">Cancelar</button>
          <button type="submit" id="submit-recomendacao-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">
            <span id="submit-recomendacao-text">Salvar Plano</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL EXPORT (placeholder) -->
  <div id="modal-export" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
      <div class="flex justify-between mb-4">
        <h3 class="font-bold text-xl">Exportar PDF</h3>
        <button onclick="closeModal('export')"><i data-lucide="x"></i></button>
      </div>
      <div class="space-y-4">
        <button onclick="exportPDFGeral()" class="w-full text-left p-4 border rounded-lg hover:bg-blue-50 flex items-center gap-3">
          <i data-lucide="file-text" class="text-blue-600"></i>
          <div>
            <p class="font-bold">Relatório Geral</p>
            <p class="text-xs text-slate-500">Todas as recomendações</p>
          </div>
        </button>

        <div class="border rounded-lg p-4">
          <p class="font-bold mb-2 flex items-center gap-2">
            <i data-lucide="folder" class="text-blue-600 w-4 h-4"></i> Por Processo
          </p>
          <div id="processos-plano-list" class="max-h-32 overflow-y-auto space-y-1 text-sm text-slate-600">
            <p class="text-xs text-slate-400 italic">Em desenvolvimento</p>
          </div>
        </div>

        <button onclick="exportPDFFormalGeral()" class="w-full text-left p-4 border rounded-lg hover:bg-purple-50 flex items-center gap-3">
          <i data-lucide="file-check-2" class="text-purple-600"></i>
          <div>
            <p class="font-bold">Formal Geral</p>
            <p class="text-xs text-slate-500">Com evidências e justificativas</p>
          </div>
        </button>

        <div class="border rounded-lg p-4">
          <p class="font-bold mb-2 flex items-center gap-2">
            <i data-lucide="folder-check" class="text-purple-600 w-4 h-4"></i> Formal por Processo
          </p>
          <div id="processos-formal-list" class="max-h-32 overflow-y-auto space-y-1 text-sm text-slate-600">
            <p class="text-xs text-slate-400 italic">Em desenvolvimento</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // STORAGE & SDK
    // =========================
    const STORAGE_KEY = "processos_auditados_v3";
    const AUDIT_KEY   = "processos_auditados_audit_v1";

    function safeParse(json, fallback) { try { return JSON.parse(json) ?? fallback; } catch { return fallback; } }
    function getStoredData() { return safeParse(localStorage.getItem(STORAGE_KEY), []); }
    function setStoredData(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function getAuditLog() { return safeParse(localStorage.getItem(AUDIT_KEY), []); }
    function setAuditLog(arr) { localStorage.setItem(AUDIT_KEY, JSON.stringify(arr)); }

    function uid(prefix="id") {
      return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function getIdFieldByTipo(tipo) {
      if (tipo === "processo") return "processo_id";
      if (tipo === "achado") return "achado_id";
      if (tipo === "recomendacao") return "recomendacao_id";
      return null;
    }

    // Local SDK fallback
    const localSdk = {
      _onDataChanged: null,
      async init({ onDataChanged } = {}) {
        this._onDataChanged = typeof onDataChanged === "function" ? onDataChanged : null;
        const data = getStoredData();
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },
      async create(item) {
        const idField = getIdFieldByTipo(item?.tipo);
        if (!idField || !item?.[idField]) return { isOk: false, error: "ID ausente" };
        const data = getStoredData();
        if (data.some(d => d.tipo === item.tipo && d[idField] === item[idField])) return { isOk: false, error: "ID já existe" };
        data.push(item);
        setStoredData(data);
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },
      async update(item) {
        const idField = getIdFieldByTipo(item?.tipo);
        const data = getStoredData();
        const idx = data.findIndex(d => d.tipo === item.tipo && d[idField] === item[idField]);
        if (idx === -1) return { isOk: false, error: "Item não encontrado" };
        data[idx] = item;
        setStoredData(data);
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },
      async delete(item) {
        const idField = getIdFieldByTipo(item?.tipo);
        const data = getStoredData();
        const next = data.filter(d => !(d.tipo === item.tipo && d[idField] === item[idField]));
        setStoredData(next);
        if (this._onDataChanged) this._onDataChanged(next);
        return { isOk: true };
      }
    };

    function ensureDataSdk() {
      if (!window.dataSdk || typeof window.dataSdk.create !== "function") {
        window.dataSdk = localSdk;
      }
    }

    // =========================
    // GLOBAL STATE
    // =========================
    let allData = [];
    let currentView = "dashboard";
    let userSession = null;

    // Edit contexts
    let currentProcessoId = null;
    let currentAchadoId = null;
    let currentEditingRec = null;
    let currentEditingProc = null;

    let setoresProcesso = [];
    let areasResponsaveis = [];
    let areasEnvolvidas = [];
    let acoesTemp = [];
    let editingAcaoIndex = null;

    const recFilters = { busca: "", status: "" };

    // =========================
    // UI HELPERS
    // =========================
    function refreshIcons() { try { if (window.lucide) window.lucide.createIcons(); } catch {} }
    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function isAdmin() {
      return !!userSession && userSession.perfil === "Administrador Geral - CAS ADM";
    }
    function fmtDateTime(iso) {
      try { return new Date(iso).toLocaleString("pt-BR"); } catch { return iso || ""; }
    }

    // =========================
    // AUDIT LOG (ADM)
    // =========================
    function auditAdd(action, tipo, summary) {
      const log = getAuditLog();
      log.unshift({
        at: new Date().toISOString(),
        user: userSession?.nome || "N/A",
        action,
        tipo,
        summary: summary || ""
      });
      setAuditLog(log.slice(0, 2000));
    }

    function exportAuditJSON() {
      const log = getAuditLog();
      const blob = new Blob([JSON.stringify(log, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "auditoria_sistema.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function clearAuditLog() {
      if (!confirm("Limpar todos os registros de auditoria?")) return;
      setAuditLog([]);
      renderAuditView();
    }

    function resetAuditFilters() {
      document.getElementById("audit-busca").value = "";
      document.getElementById("audit-acao").value = "";
      document.getElementById("audit-tipo").value = "";
      renderAuditView();
    }

    function renderAuditView() {
      if (!isAdmin()) return;

      const busca = (document.getElementById("audit-busca")?.value || "").toLowerCase();
      const acao = document.getElementById("audit-acao")?.value || "";
      const tipo = document.getElementById("audit-tipo")?.value || "";

      let log = getAuditLog();

      log = log.filter(l => {
        if (acao && l.action !== acao) return false;
        if (tipo && l.tipo !== tipo) return false;
        if (busca) {
          const hay = `${l.user} ${l.action} ${l.tipo} ${l.summary}`.toLowerCase();
          if (!hay.includes(busca)) return false;
        }
        return true;
      });

      const tbody = document.getElementById("audit-table-body");
      const empty = document.getElementById("audit-empty");

      if (log.length === 0) {
        tbody.innerHTML = "";
        empty.style.display = "block";
      } else {
        empty.style.display = "none";
        tbody.innerHTML = log.map(l => `
          <tr class="border-b hover:bg-slate-50">
            <td class="px-4 py-3 whitespace-nowrap text-slate-600">${escapeHtml(fmtDateTime(l.at))}</td>
            <td class="px-4 py-3 whitespace-nowrap font-semibold text-slate-800">${escapeHtml(l.user)}</td>
            <td class="px-4 py-3 whitespace-nowrap">
              <span class="badge ${l.action === 'DELETE' ? 'badge-red' : l.action === 'UPDATE' ? 'badge-amber' : l.action === 'CREATE' ? 'badge-emerald' : 'badge-blue'}">${escapeHtml(l.action)}</span>
              <span class="ml-2 text-xs text-slate-500 font-bold uppercase">${escapeHtml(l.tipo || '')}</span>
            </td>
            <td class="px-4 py-3 text-slate-700">${escapeHtml(l.summary || '')}</td>
          </tr>
        `).join("");
      }
      refreshIcons();
    }

    // =========================
    // FILTER BY USER (TÉCNICO)
    // =========================
    function filterDataByUser(data) {
      if (!userSession || isAdmin()) return data;

      const userSetor = userSession.setor || "";
      const processosPermitidos = data.filter(item => {
        if (item.tipo === "processo") return (item.setores_envolvidos || "").includes(userSetor);
        return true;
      });
      const procsIds = processosPermitidos.filter(p => p.tipo === "processo").map(p => p.processo_id);

      return data.filter(item => {
        if (item.tipo === "processo") return procsIds.includes(item.processo_id);
        if (item.tipo === "achado" || item.tipo === "recomendacao") return procsIds.includes(item.processo_id);
        return false;
      });
    }

    // =========================
    // DERIVED RECOMMENDATION
    // =========================
    function computeProgressFromAcoes(acoes) {
      if (!Array.isArray(acoes) || acoes.length === 0) return 0;
      const sum = acoes.reduce((acc, a) => acc + (a.status === "Concluída" ? 1 : a.status === "Em andamento" ? 0.5 : 0), 0);
      return Math.round((sum / acoes.length) * 100);
    }

    function computeStatusFromAcoes(acoes) {
      if (!Array.isArray(acoes) || acoes.length === 0) return "Pendente";
      const today = new Date(); today.setHours(0,0,0,0);
      const anyOverdue = acoes.some(a => a.prazo && new Date(a.prazo) < today && a.status !== "Concluída");
      if (anyOverdue) return "Atrasado";
      if (acoes.every(a => a.status === "Concluída")) return "Concluído";
      if (acoes.some(a => ["Em andamento", "Concluída"].includes(a.status))) return "Em Execução";
      return "Pendente";
    }

    function getRecDerived(rec) {
      const acoes = rec.acoes || [];
      return {
        progresso: Number.isFinite(Number(rec.progresso)) ? Number(rec.progresso) : computeProgressFromAcoes(acoes),
        status: rec.status || computeStatusFromAcoes(acoes)
      };
    }

    // =========================
    // NAV
    // =========================
    function showView(view) {
      currentView = view;

      document.querySelectorAll('[id^="view-"]').forEach(v => v.style.display = "none");
      const target = document.getElementById("view-" + view);
      if (target) target.style.display = "block";

      document.querySelectorAll('[id^="nav-"]').forEach(n => n.classList.remove("active-link"));
      const nav = document.getElementById("nav-" + view);
      if (nav) nav.classList.add("active-link");

      const titles = {
        dashboard: ["Dashboard", "Visão geral de locais, processos e planos"],
        processos: ["Processos", "Cadastro de processos, achados e recomendações"],
        recomendacoes: ["Planos de Ação", "Acompanhamento 5W2H por recomendação"],
        auditoria: ["Auditoria do Sistema", "Logs e rastreabilidade de ações"]
      };
      document.getElementById("page-title").textContent = titles[view]?.[0] || "Sistema";
      document.getElementById("page-subtitle").textContent = titles[view]?.[1] || "";

      renderCurrentView();
    }

    function renderCurrentView() {
      const filteredData = filterDataByUser(allData);
      if (currentView === "dashboard") renderDashboard(filteredData);
      else if (currentView === "processos") renderProcessos(filteredData);
      else if (currentView === "recomendacoes") renderRecomendacoes(filteredData);
      else if (currentView === "auditoria") renderAuditView();
    }

    // =========================
    // DASHBOARD
    // =========================
    function renderDashboard(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const recs = data.filter(d => d.tipo === "recomendacao").map(r => ({...r, ...getRecDerived(r)}));
      const locais = [...new Set(processos.map(p => p.unidade).filter(Boolean))];

      document.getElementById("dash-total-locais").textContent = locais.length;
      document.getElementById("dash-total-processos").textContent = processos.length;
      document.getElementById("dash-total-recomendacoes").textContent = recs.length;
      document.getElementById("dash-atrasadas").textContent = recs.filter(r => r.status === "Atrasado").length;

      const container = document.getElementById("locais-dashboard");
      if (locais.length === 0) {
        container.innerHTML = "";
        document.getElementById("dashboard-empty").style.display = "block";
      } else {
        document.getElementById("dashboard-empty").style.display = "none";
        container.innerHTML = locais.map(local => {
          const pLocal = processos.filter(p => p.unidade === local);
          const pIds = pLocal.map(p => p.processo_id);
          const rLocal = recs.filter(r => pIds.includes(r.processo_id));
          const pendentes = rLocal.filter(r => r.status === "Pendente" || r.status === "Em Execução").length;
          const concluidas = rLocal.filter(r => r.status === "Concluído").length;

          return `
            <div class="glass-card p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-all cursor-pointer"
                 onclick="goToLocal('${escapeHtml(local)}')">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="font-bold text-lg text-slate-800">${escapeHtml(local)}</h3>
                  <p class="text-xs text-slate-500 font-bold uppercase">${pLocal.length} Processos</p>
                </div>
                <div class="bg-blue-100 p-2 rounded-lg"><i data-lucide="building-2" class="text-blue-600 w-5 h-5"></i></div>
              </div>
              <div class="space-y-3">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-500">Planos Totais</span>
                  <span class="font-bold text-slate-800">${rLocal.length}</span>
                </div>
                <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden flex">
                  <div class="bg-emerald-500 h-full" style="width: ${(concluidas/rLocal.length*100)||0}%"></div>
                  <div class="bg-amber-400 h-full" style="width: ${(pendentes/rLocal.length*100)||0}%"></div>
                </div>
                <div class="flex gap-4 text-xs font-bold mt-2">
                  <span class="flex items-center gap-1 text-emerald-600"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> ${concluidas} OK</span>
                  <span class="flex items-center gap-1 text-amber-500"><span class="w-2 h-2 rounded-full bg-amber-500"></span> ${pendentes} Pend.</span>
                </div>
              </div>
            </div>
          `;
        }).join("");
      }
      refreshIcons();
    }

    function goToLocal(local) {
      // filtra visualmente indo para Processos (simples)
      showView("processos");
      const el = document.querySelector(`[data-local="${CSS.escape(local)}"]`);
      if (el) el.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    // =========================
    // PROCESSOS (COM Nº PROCESSO, LOCAL, ACHADOS, RECOMENDAÇÕES)
    // =========================
    function renderProcessos(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const achados = data.filter(d => d.tipo === "achado");
      const recs = data.filter(d => d.tipo === "recomendacao").map(r => ({...r, ...getRecDerived(r)}));

      const list = document.getElementById("processos-list");
      const empty = document.getElementById("processos-empty");

      if (processos.length === 0) {
        list.innerHTML = "";
        empty.style.display = "block";
        refreshIcons();
        return;
      }
      empty.style.display = "none";

      list.innerHTML = processos.map(p => {
        const aProc = achados.filter(a => a.processo_id === p.processo_id);
        const rProc = recs.filter(r => r.processo_id === p.processo_id);

        const pend = rProc.filter(r => r.status !== "Concluído").length;
        const ok = rProc.filter(r => r.status === "Concluído").length;

        return `
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden" data-local="${escapeHtml(p.unidade || '')}">
            <div class="p-6 border-b border-slate-100 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <h3 class="text-xl font-extrabold text-slate-800">Processo ${escapeHtml(p.processo_numero || p.processo_id)}</h3>
                  <span class="badge badge-slate"><i data-lucide="map-pin" class="w-3 h-3"></i> ${escapeHtml(p.unidade || "Sem local")}</span>
                  <span class="badge badge-blue"><i data-lucide="calendar" class="w-3 h-3"></i> ${escapeHtml(p.periodo || "S/ período")}</span>
                </div>
                <p class="text-sm text-slate-500 mt-2">${escapeHtml(p.objeto || "")}</p>
                <div class="mt-2 text-xs text-slate-500 flex flex-wrap gap-2">
                  <span><b>Eixo:</b> ${escapeHtml(p.eixo || "")}</span>
                  <span><b>Auditor:</b> ${escapeHtml(p.auditor || "-")}</span>
                  <span><b>Resp. Unidade:</b> ${escapeHtml(p.responsavel || "-")}</span>
                </div>
              </div>

              <div class="flex gap-2 flex-wrap">
                <button onclick="openNewAchadoModal('${p.processo_id}')" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold text-sm hover:bg-blue-600 inline-flex items-center gap-2">
                  <i data-lucide="plus" class="w-4 h-4"></i> Novo Achado
                </button>
                <button onclick="openNewRecomendacaoModal('${p.processo_id}')" class="px-4 py-2 rounded-xl border font-bold text-sm hover:bg-slate-50 inline-flex items-center gap-2">
                  <i data-lucide="list-plus" class="w-4 h-4"></i> Novo Plano
                </button>
                ${isAdmin() ? `
                  <button onclick="deleteProcesso('${p.processo_id}')" class="px-4 py-2 rounded-xl border border-red-300 text-red-600 font-bold text-sm hover:bg-red-50 inline-flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Excluir
                  </button>
                ` : ``}
              </div>
            </div>

            <div class="p-6 grid grid-cols-1 xl:grid-cols-2 gap-6">
              <div class="bg-slate-50 rounded-2xl border border-slate-200 p-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="font-extrabold text-slate-800 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i> Achados</h4>
                  <span class="text-xs font-bold text-slate-500">${aProc.length}</span>
                </div>

                ${aProc.length ? `
                  <div class="space-y-2">
                    ${aProc.map(a => `
                      <div class="bg-white rounded-xl border border-slate-200 p-3">
                        <div class="flex items-start justify-between gap-3">
                          <div class="min-w-0">
                            <p class="font-extrabold text-slate-800">
                              Achado ${escapeHtml(a.achado_numero)}${a.achado_subitem ? "-"+escapeHtml(a.achado_subitem) : ""}
                              <span class="ml-2 badge ${a.grau_risco === 'Alto' ? 'badge-red' : a.grau_risco === 'Médio' ? 'badge-amber' : 'badge-emerald'}">${escapeHtml(a.grau_risco || '')}</span>
                            </p>
                            <p class="text-sm text-slate-600 mt-1 line-clamp-2">${escapeHtml(a.achado_descricao || "")}</p>
                            <p class="text-xs text-slate-500 mt-1">
                              <b>Impacto:</b> ${escapeHtml(a.impacto || a.impacto_outro || "-")}
                              <span class="mx-2">•</span>
                              <b>Responsável:</b> ${escapeHtml(a.responsavel_achado || "-")}
                            </p>
                          </div>

                          ${isAdmin() ? `
                            <button onclick="deleteAchado('${a.achado_id}')" class="p-2 rounded-lg hover:bg-red-50 text-red-600" title="Excluir Achado">
                              <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                          ` : ``}
                        </div>
                      </div>
                    `).join("")}
                  </div>
                ` : `<p class="text-sm text-slate-400 italic">Nenhum achado cadastrado neste processo.</p>`}
              </div>

              <div class="bg-slate-50 rounded-2xl border border-slate-200 p-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="font-extrabold text-slate-800 flex items-center gap-2"><i data-lucide="list-checks" class="w-4 h-4 text-blue-600"></i> Planos / Recomendações</h4>
                  <div class="text-xs font-bold text-slate-500">
                    <span class="badge badge-emerald">${ok} OK</span>
                    <span class="badge badge-amber ml-2">${pend} Pend.</span>
                  </div>
                </div>

                ${rProc.length ? `
                  <div class="space-y-2">
                    ${rProc.map(r => {
                      const ach = getAchadoById(r.achado_id);
                      const achName = ach ? `Achado ${ach.achado_numero}${ach.achado_subitem ? "-"+ach.achado_subitem : ""}` : "";
                      const statusBadge = r.status === "Concluído" ? "badge-emerald" : r.status === "Atrasado" ? "badge-red" : r.status === "Em Execução" ? "badge-blue" : "badge-slate";
                      return `
                        <div class="bg-white rounded-xl border border-slate-200 p-3">
                          <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                              <p class="font-extrabold text-slate-800">
                                Rec. ${escapeHtml(r.recomendacao_numero)}${r.recomendacao_subitem ? "-"+escapeHtml(r.recomendacao_subitem) : ""}
                                <span class="ml-2 badge ${statusBadge}">${escapeHtml(r.status)}</span>
                                ${achName ? `<span class="ml-2 badge badge-slate"><i data-lucide="link" class="w-3 h-3"></i> ${escapeHtml(achName)}</span>` : ``}
                              </p>
                              <p class="text-sm text-slate-600 mt-1 line-clamp-2">${escapeHtml(r.recomendacao_texto || "")}</p>
                              <p class="text-xs text-slate-500 mt-1">
                                <b>Prazo:</b> ${escapeHtml(r.prazo_global || "-")}
                                <span class="mx-2">•</span>
                                <b>Responsável:</b> ${escapeHtml(r.responsavel_recomendacao || "-")}
                                <span class="mx-2">•</span>
                                <b>Progresso:</b> ${Number(r.progresso||0)}%
                              </p>
                            </div>
                            <div class="flex gap-1 shrink-0">
                              <button onclick="openEditRecomendacao('${r.recomendacao_id}')" class="p-2 rounded-lg hover:bg-slate-100 text-blue-600" title="Editar Plano">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                              </button>
                              ${isAdmin() ? `
                                <button onclick="deleteRecomendacao('${r.recomendacao_id}')" class="p-2 rounded-lg hover:bg-red-50 text-red-600" title="Excluir Plano">
                                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                              ` : ``}
                            </div>
                          </div>
                        </div>
                      `;
                    }).join("")}
                  </div>
                ` : `<p class="text-sm text-slate-400 italic">Nenhum plano cadastrado neste processo.</p>`}
              </div>
            </div>
          </div>
        `;
      }).join("");

      refreshIcons();
    }

    // =========================
    // RECOMENDAÇÕES (CARDS EXECUTIVE + NOME DO ACHADO)
    // =========================
    function applyRecFilters() {
      recFilters.busca = document.getElementById("filtro-busca").value;
      recFilters.status = document.getElementById("filtro-status").value;
      renderCurrentView();
    }
    function resetRecFilters() {
      document.getElementById("filtro-busca").value = "";
      document.getElementById("filtro-status").value = "";
      applyRecFilters();
    }

    function renderRecomendacoes(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const recsRaw = data.filter(d => d.tipo === "recomendacao");

      const recs = recsRaw.map(r => ({...r, ...getRecDerived(r)})).filter(r => {
        const proc = processos.find(p => p.processo_id === r.processo_id);
        if (recFilters.status && r.status !== recFilters.status) return false;
        if (recFilters.busca) {
          const ach = getAchadoById(r.achado_id);
          const achName = ach ? `Achado ${ach.achado_numero}${ach.achado_subitem ? "-"+ach.achado_subitem : ""}` : "";
          const hay = [
            r.recomendacao_texto, r.recomendacao_numero, r.indicador, r.resultado,
            proc?.unidade, r.responsavel_recomendacao, achName
          ].join(" ").toLowerCase();
          if (!hay.includes(recFilters.busca.toLowerCase())) return false;
        }
        return true;
      });

      const container = document.getElementById("recomendacoes-grouped");
      const empty = document.getElementById("recomendacoes-empty");

      if (recs.length === 0) {
        container.innerHTML = "";
        empty.style.display = "block";
        refreshIcons();
        return;
      }

      empty.style.display = "none";

      const byProcess = {};
      recs.forEach(r => {
        if (!byProcess[r.processo_id]) byProcess[r.processo_id] = [];
        byProcess[r.processo_id].push(r);
      });

      container.innerHTML = Object.keys(byProcess).map(procId => {
        const proc = processos.find(p => p.processo_id === procId);
        const list = byProcess[procId];
        return `
          <div class="mb-12">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-200 pb-2">
              <h2 class="text-2xl font-bold text-slate-800">Processo ${escapeHtml(proc?.processo_numero || procId)}</h2>
              <span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-500">${escapeHtml(proc?.unidade || "")}</span>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
              ${list.map(r => recCardHtml(r, proc)).join("")}
            </div>
          </div>
        `;
      }).join("");

      refreshIcons();
    }

    function recCardHtml(r, proc) {
      const isAdminOrTech = !!userSession;

      // custo total
      let totalCusto = 0;
      let temCusto = false;
      (r.acoes || []).forEach(a => {
        if (a.custo) {
          const num = parseFloat(String(a.custo).replace(/[^0-9.,]/g, "").replace(",", "."));
          if (!isNaN(num)) { totalCusto += num; temCusto = true; }
        }
      });
      const custoDisplay = temCusto ? `R$ ${totalCusto.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}` : "Não estimado";

      // progress gradient
      let progressGradient = "from-blue-400 via-blue-600 to-indigo-700";
      if (r.progresso >= 100) progressGradient = "from-emerald-400 via-emerald-500 to-emerald-600";
      else if (r.status === "Atrasado") progressGradient = "from-red-400 via-red-500 to-red-600";
      else if (r.progresso > 50) progressGradient = "from-blue-400 via-blue-500 to-indigo-600";
      else progressGradient = "from-amber-400 via-amber-500 to-amber-600";

      const statusColors = {
        "Pendente": "text-slate-500",
        "Em Execução": "text-blue-600",
        "Concluído": "text-emerald-600",
        "Atrasado": "text-red-600"
      };
      const statusClass = statusColors[r.status] || "text-slate-500";

      const actionsHtml = (r.acoes || []).map(a => {
        const isDone = a.status === "Concluída";
        return `
          <div class="flex items-center gap-4 p-3 rounded-2xl ${isDone ? 'bg-slate-50 border border-slate-100' : 'bg-white border border-slate-200'} transition-all group/item">
            <input type="checkbox" disabled ${isDone ? 'checked' : ''} class="step-checkbox w-5 h-5 rounded-lg border-slate-300 text-blue-600 focus:ring-blue-500">
            <div class="flex-1">
              <span class="text-sm font-semibold text-slate-700 block">${escapeHtml(a.desc)}</span>
              <span class="text-[10px] text-slate-400 font-bold uppercase">${escapeHtml(a.responsavel || "Sem resp.")} • ${a.prazo ? new Date(a.prazo).toLocaleDateString('pt-BR').slice(0,5) : "S/ Prazo"}</span>
            </div>
            ${isDone ? '<i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i>' : ''}
          </div>
        `;
      }).join("");

      // nome do achado (quando vinculado)
      const ach = getAchadoById(r.achado_id);
      const achName = ach ? `Achado ${ach.achado_numero}${ach.achado_subitem ? "-"+ach.achado_subitem : ""}` : "";

      return `
        <div class="glass-card border border-slate-200 rounded-[2.5rem] shadow-xl shadow-slate-200/50 overflow-hidden flex flex-col group h-full">
          <div class="p-8 pb-4 flex-1">
            <div class="flex justify-between items-start mb-6">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full ${r.status==='Em Execução' ? 'bg-blue-500 animate-pulse' : r.status==='Atrasado' ? 'bg-red-500' : 'bg-emerald-500'}"></span>
                <span class="text-[10px] font-black uppercase tracking-widest ${statusClass}">${escapeHtml(r.status)}</span>
              </div>
              <div class="flex gap-2 text-slate-400">
                <button onclick="openEditRecomendacao('${r.recomendacao_id}')" class="p-2 hover:bg-slate-100 rounded-lg transition-colors text-blue-600" title="Editar"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                ${isAdminOrTech && isAdmin() ? `<button onclick="deleteRecomendacao('${r.recomendacao_id}')" class="p-2 hover:bg-red-50 rounded-lg transition-colors text-red-400 hover:text-red-600" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
              </div>
            </div>

            <div class="flex flex-wrap gap-2 mb-3">
              <h2 class="text-xl font-bold text-slate-800 leading-tight">
                Rec. ${escapeHtml(r.recomendacao_numero)}${r.recomendacao_subitem ? '-'+escapeHtml(r.recomendacao_subitem) : ''}
              </h2>
              ${achName ? `<span class="badge badge-slate"><i data-lucide="link" class="w-3 h-3"></i> ${escapeHtml(achName)}</span>` : ``}
            </div>

            <p class="text-slate-500 text-sm leading-relaxed mb-4 line-clamp-3">${escapeHtml(r.recomendacao_texto)}</p>

            ${(r.indicador || r.resultado) ? `
              <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 mb-5">
                ${r.indicador ? `<p class="text-xs text-slate-700"><span class="font-black">Indicador:</span> ${escapeHtml(r.indicador)}</p>` : ``}
                ${r.resultado ? `<p class="text-xs text-slate-700 mt-1"><span class="font-black">Resultado:</span> ${escapeHtml(r.resultado)}</p>` : ``}
              </div>
            ` : ``}

            <div class="relative pt-2">
              <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-black text-slate-400 uppercase italic">Eficácia / Progresso</span>
                <span class="text-sm font-black text-slate-800">${Number(r.progresso||0)}%</span>
              </div>
              <div class="h-3 w-full bg-slate-100 rounded-full p-0.5">
                <div class="h-full bg-gradient-to-r ${progressGradient} rounded-full transition-all duration-1000 progress-glow shadow-inner" style="width: ${Number(r.progresso||0)}%"></div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-3 bg-slate-50/80 border-y border-slate-100 p-6 gap-2">
            <div class="space-y-1">
              <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest block">Quem</span>
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] text-slate-600 font-bold">${escapeHtml((r.responsavel_recomendacao||"SR").substring(0,2).toUpperCase())}</div>
                <span class="text-xs font-bold text-slate-700 truncate block max-w-[120px]" title="${escapeHtml(r.responsavel_recomendacao || '')}">${escapeHtml(r.responsavel_recomendacao || "N/A")}</span>
              </div>
            </div>
            <div class="space-y-1 border-x border-slate-200 px-3">
              <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest block">Quando</span>
              <div class="flex items-center gap-2 text-slate-700">
                <i data-lucide="calendar" class="w-3 h-3 text-blue-500"></i>
                <span class="text-xs font-bold uppercase tracking-tighter truncate">${escapeHtml(r.prazo_global || "S/ Prazo")}</span>
              </div>
            </div>
            <div class="space-y-1 pl-2">
              <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest block">Custo Est.</span>
              <div class="flex items-center gap-1 text-emerald-600">
                <span class="text-xs font-black truncate">${escapeHtml(custoDisplay)}</span>
              </div>
            </div>
          </div>

          <div class="p-6 bg-white flex-1 max-h-64 flex flex-col">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-xs font-black text-slate-800 uppercase flex items-center gap-2">
                <i data-lucide="list-checks" class="text-blue-500 w-4 h-4"></i> Etapas (5W2H)
              </h4>
              <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${(r.acoes||[]).length} etapa(s)</span>
            </div>
            <div class="space-y-2 custom-scrollbar overflow-y-auto pr-2 flex-1">
              ${actionsHtml.length ? actionsHtml : '<p class="text-xs text-slate-400 italic">Nenhuma etapa cadastrada.</p>'}
            </div>
            <button onclick="openEditRecomendacao('${r.recomendacao_id}')" class="w-full mt-4 py-3 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-xs font-bold hover:border-blue-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2">
              <i data-lucide="plus" class="w-3 h-3"></i> Gerenciar Etapas
            </button>
          </div>
        </div>
      `;
    }

    // =========================
    // ACHADO LOOKUP (NOME DO ACHADO)
    // =========================
    function getAchadoById(achado_id) {
      if (!achado_id) return null;
      return allData.find(d => d.tipo === "achado" && d.achado_id === achado_id) || null;
    }

    // =========================
    // MODALS
    // =========================
    function openNewProcessModal() {
      currentEditingProc = null;
      currentProcessoId = null;
      setoresProcesso = [];
      document.getElementById("modal-processo-title").textContent = "Novo Processo";
      document.getElementById("submit-processo-text").textContent = "Salvar";

      document.getElementById("processo-form").reset();
      document.getElementById("eixo_outro").style.display = "none";
      document.getElementById("setores-processo-container").innerHTML = "";
      document.getElementById("modal-processo").style.display = "flex";
      refreshIcons();
    }

    function openNewAchadoModal(processoId) {
      currentProcessoId = processoId;
      currentAchadoId = null;
      document.getElementById("modal-achado-title").textContent = "Novo Achado";
      document.getElementById("submit-achado-text").textContent = "Salvar";
      document.getElementById("achado-form").reset();
      document.getElementById("impacto_outro").style.display = "none";
      document.getElementById("modal-achado").style.display = "flex";
      refreshIcons();
    }

    function openNewRecomendacaoModal(processoId) {
      currentProcessoId = processoId;
      currentEditingRec = null;

      // reset
      document.getElementById("recomendacao-form").reset();
      acoesTemp = [];
      areasResponsaveis = [];
      areasEnvolvidas = [];
      editingAcaoIndex = null;

      document.getElementById("areas-container").innerHTML = "";
      document.getElementById("areas-envolvidas-container").innerHTML = "";
      renderAcoesTemp();
      setAcaoFormMode(false);

      // populate achados do processo (para mostrar nome do achado)
      populateAchadoSelect(processoId);
      renderAchadoPreviewInRecModal();

      document.getElementById("modal-recomendacao").style.display = "flex";
      refreshIcons();
    }

    function closeModal(id) {
      document.getElementById("modal-" + id).style.display = "none";
    }

    function toggleEixoOutro() {
      document.getElementById("eixo_outro").style.display = document.getElementById("eixo").value === "Outro" ? "block" : "none";
    }

    function toggleImpactoOutro() {
      document.getElementById("impacto_outro").style.display = document.getElementById("impacto").value === "Outro" ? "block" : "none";
    }

    // =========================
    // SETORES DO PROCESSO
    // =========================
    function adicionarSetorProcesso() {
      const input = document.getElementById("setor_processo_input");
      const val = (input.value || "").trim();
      if (!val) return;
      if (!setoresProcesso.includes(val)) setoresProcesso.push(val);
      input.value = "";
      renderSetoresProcesso();
    }

    function removerSetorProcesso(i) {
      setoresProcesso.splice(i, 1);
      renderSetoresProcesso();
    }

    function renderSetoresProcesso() {
      const container = document.getElementById("setores-processo-container");
      container.innerHTML = setoresProcesso.map((s, i) => `
        <div class="flex items-center justify-between bg-slate-50 border rounded-lg px-3 py-2">
          <span class="text-sm font-semibold text-slate-700">${escapeHtml(s)}</span>
          <button type="button" onclick="removerSetorProcesso(${i})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");
      refreshIcons();
    }

    // =========================
    // ÁREAS RESPONSÁVEIS / ENVOLVIDAS
    // =========================
    function adicionarArea() {
      const input = document.getElementById("area_input");
      const val = (input.value || "").trim();
      if (!val) return;
      if (!areasResponsaveis.includes(val)) areasResponsaveis.push(val);
      input.value = "";
      renderAreas();
    }

    function removerArea(i) {
      areasResponsaveis.splice(i, 1);
      renderAreas();
    }

    function renderAreas() {
      const c = document.getElementById("areas-container");
      c.innerHTML = areasResponsaveis.map((a, i) => `
        <div class="flex items-center justify-between bg-slate-50 border rounded-lg px-3 py-2">
          <span class="text-sm font-semibold text-slate-700">${escapeHtml(a)}</span>
          <button type="button" onclick="removerArea(${i})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");
      refreshIcons();
    }

    function adicionarAreaEnvolvida() {
      const input = document.getElementById("area_envolvida_input");
      const val = (input.value || "").trim();
      if (!val) return;
      if (!areasEnvolvidas.includes(val)) areasEnvolvidas.push(val);
      input.value = "";
      renderAreasEnvolvidas();
    }

    function removerAreaEnvolvida(i) {
      areasEnvolvidas.splice(i, 1);
      renderAreasEnvolvidas();
    }

    function renderAreasEnvolvidas() {
      const c = document.getElementById("areas-envolvidas-container");
      c.innerHTML = areasEnvolvidas.map((a, i) => `
        <div class="flex items-center justify-between bg-slate-50 border rounded-lg px-3 py-2">
          <span class="text-sm font-semibold text-slate-700">${escapeHtml(a)}</span>
          <button type="button" onclick="removerAreaEnvolvida(${i})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");
      refreshIcons();
    }

    // =========================
    // AÇÕES TEMP (EDITAR / GERENCIAR)
    // =========================
    function setAcaoFormMode(isEditing) {
      const btn = document.getElementById("acao_submit_btn");
      const cancel = document.getElementById("acao_cancel_btn");
      if (!btn || !cancel) return;

      if (isEditing) {
        btn.textContent = "Atualizar Etapa";
        cancel.classList.remove("hidden");
      } else {
        btn.textContent = "+ Adicionar Etapa";
        cancel.classList.add("hidden");
      }
    }

    function clearAcaoInputs() {
      document.getElementById("acao_desc").value = "";
      document.getElementById("acao_resp").value = "";
      document.getElementById("acao_prazo").value = "";
      document.getElementById("acao_custo").value = "";
      document.getElementById("acao_status").value = "Não iniciada";
    }

    function addOrUpdateAcaoTemp() {
      const desc = (document.getElementById("acao_desc").value || "").trim();
      if (!desc) return alert("Descrição da etapa é obrigatória.");

      const payload = {
        id: (editingAcaoIndex !== null && acoesTemp[editingAcaoIndex]?.id) ? acoesTemp[editingAcaoIndex].id : uid("acao"),
        desc,
        responsavel: document.getElementById("acao_resp").value,
        prazo: document.getElementById("acao_prazo").value,
        custo: document.getElementById("acao_custo").value,
        status: document.getElementById("acao_status").value
      };

      if (editingAcaoIndex !== null) {
        acoesTemp[editingAcaoIndex] = payload;
        editingAcaoIndex = null;
        setAcaoFormMode(false);
      } else {
        acoesTemp.push(payload);
      }

      clearAcaoInputs();
      renderAcoesTemp();
    }

    function editAcaoTemp(i) {
      const a = acoesTemp[i];
      if (!a) return;

      editingAcaoIndex = i;

      document.getElementById("acao_desc").value = a.desc || "";
      document.getElementById("acao_resp").value = a.responsavel || "";
      document.getElementById("acao_prazo").value = a.prazo || "";
      document.getElementById("acao_custo").value = a.custo || "";
      document.getElementById("acao_status").value = a.status || "Não iniciada";

      setAcaoFormMode(true);
      document.getElementById("acao_desc").scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function cancelEditAcaoTemp() {
      editingAcaoIndex = null;
      clearAcaoInputs();
      setAcaoFormMode(false);
    }

    function removeAcaoTemp(i) {
      const a = acoesTemp[i];
      if (!a) return;
      if (!confirm("Remover esta etapa?")) return;

      acoesTemp.splice(i, 1);

      if (editingAcaoIndex === i) cancelEditAcaoTemp();
      if (editingAcaoIndex !== null && editingAcaoIndex > i) editingAcaoIndex--;

      renderAcoesTemp();
    }

    function renderAcoesTemp() {
      const list = document.getElementById("acoes-temp-list");
      if (acoesTemp.length === 0) {
        list.innerHTML = "";
        document.getElementById("acoes-temp-empty").style.display = "block";
      } else {
        document.getElementById("acoes-temp-empty").style.display = "none";
        list.innerHTML = acoesTemp.map((a, i) => `
          <div class="bg-slate-50 p-3 rounded border flex justify-between items-center gap-3">
            <div class="min-w-0">
              <p class="font-bold text-sm text-slate-800 truncate">${escapeHtml(a.desc)}</p>
              <p class="text-xs text-slate-500">
                ${escapeHtml(a.status)} • ${escapeHtml(a.responsavel || '-')} • ${escapeHtml(a.prazo ? new Date(a.prazo).toLocaleDateString('pt-BR') : 'S/ prazo')} • ${escapeHtml(a.custo || '-')}
              </p>
            </div>

            <div class="flex gap-1 shrink-0">
              <button type="button" onclick="editAcaoTemp(${i})" class="p-2 rounded-lg hover:bg-slate-200 text-blue-600" title="Editar etapa">
                <i data-lucide="pencil" class="w-4 h-4"></i>
              </button>
              <button type="button" onclick="removeAcaoTemp(${i})" class="p-2 rounded-lg hover:bg-red-100 text-red-600" title="Remover etapa">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        `).join("");
      }

      const prog = computeProgressFromAcoes(acoesTemp);
      document.getElementById("calc-progresso").textContent = prog;
      document.getElementById("calc-status").textContent = computeStatusFromAcoes(acoesTemp);
      refreshIcons();
    }

    // =========================
    // ACHADO SELECT (NOME DO ACHADO)
    // =========================
    function populateAchadoSelect(processoId) {
      const sel = document.getElementById("recomendacao_achado_id");
      const achados = allData.filter(d => d.tipo === "achado" && d.processo_id === processoId);

      sel.innerHTML = `<option value="">(Opcional) Selecione um achado...</option>` + achados.map(a => {
        const label = `Achado ${a.achado_numero}${a.achado_subitem ? "-"+a.achado_subitem : ""} - ${String(a.achado_descricao || "").slice(0, 80)}${String(a.achado_descricao||"").length > 80 ? "..." : ""}`;
        return `<option value="${escapeHtml(a.achado_id)}">${escapeHtml(label)}</option>`;
      }).join("");
    }

    function renderAchadoPreviewInRecModal() {
      const sel = document.getElementById("recomendacao_achado_id");
      const preview = document.getElementById("achado-preview");
      const id = sel.value;
      if (!id) {
        preview.textContent = "";
        return;
      }
      const a = getAchadoById(id);
      if (!a) {
        preview.textContent = "";
        return;
      }
      const name = `Achado ${a.achado_numero}${a.achado_subitem ? "-"+a.achado_subitem : ""}`;
      preview.textContent = `${name} • ${a.grau_risco || ""} • ${String(a.achado_descricao || "").slice(0, 140)}${String(a.achado_descricao||"").length > 140 ? "..." : ""}`;
    }

    // =========================
    // CRUD: PROCESSO / ACHADO / RECOMENDAÇÃO
    // =========================
    async function deleteProcesso(processoId) {
      if (!confirm("Excluir este processo e todos os achados/planos vinculados?")) return;

      // apaga processo
      const proc = allData.find(d => d.tipo === "processo" && d.processo_id === processoId);
      if (proc) {
        await window.dataSdk.delete(proc);
        auditAdd("DELETE", "processo", `Processo ${proc.processo_numero || proc.processo_id}`);
      }

      // apaga dependências
      const deps = allData.filter(d => (d.tipo === "achado" || d.tipo === "recomendacao") && d.processo_id === processoId);
      for (const item of deps) {
        await window.dataSdk.delete(item);
        auditAdd("DELETE", item.tipo, `Vinculado ao processo ${proc?.processo_numero || processoId}`);
      }

      renderCurrentView();
    }

    async function deleteAchado(achadoId) {
      if (!confirm("Excluir este achado? (recomendações vinculadas manterão o vínculo vazio)")) return;
      const a = allData.find(d => d.tipo === "achado" && d.achado_id === achadoId);
      if (!a) return;

      await window.dataSdk.delete(a);
      auditAdd("DELETE", "achado", `Achado ${a.achado_numero}${a.achado_subitem ? "-"+a.achado_subitem : ""}`);

      // remove vínculo em recomendações que apontam para esse achado
      const recs = allData.filter(d => d.tipo === "recomendacao" && d.achado_id === achadoId);
      for (const r of recs) {
        const next = { ...r, achado_id: "" , updated_at: new Date().toISOString() };
        await window.dataSdk.update(next);
        auditAdd("UPDATE", "recomendacao", `Removido vínculo ao achado em Rec ${r.recomendacao_numero}`);
      }

      renderCurrentView();
    }

    async function deleteRecomendacao(recId) {
      if (!confirm("Excluir este plano de ação?")) return;
      const rec = allData.find(d => d.tipo === "recomendacao" && d.recomendacao_id === recId);
      if (!rec) return;
      await window.dataSdk.delete(rec);
      auditAdd("DELETE", "recomendacao", `Rec ${rec.recomendacao_numero}${rec.recomendacao_subitem ? "-"+rec.recomendacao_subitem : ""}`);
      renderCurrentView();
    }

    // =========================
    // EDITAR RECOMENDAÇÃO
    // =========================
    function openEditRecomendacao(recId) {
      currentEditingRec = recId;
      const rec = allData.find(d => d.tipo === "recomendacao" && d.recomendacao_id === recId);
      if (!rec) return;

      currentProcessoId = rec.processo_id;

      // popular selects de achado do processo
      populateAchadoSelect(currentProcessoId);

      // campos base
      document.getElementById("recomendacao_numero").value = rec.recomendacao_numero || "";
      document.getElementById("recomendacao_subitem").value = rec.recomendacao_subitem || "";
      document.getElementById("recomendacao_texto").value = rec.recomendacao_texto || "";
      document.getElementById("prioridade").value = rec.prioridade || "";
      document.getElementById("prazo_global").value = rec.prazo_global || "";
      document.getElementById("responsavel_recomendacao").value = rec.responsavel_recomendacao || "";

      // indicador e resultado
      document.getElementById("indicador").value = rec.indicador || "";
      document.getElementById("resultado").value = rec.resultado || "";

      // vínculo ao achado
      document.getElementById("recomendacao_achado_id").value = rec.achado_id || "";
      renderAchadoPreviewInRecModal();

      // áreas
      areasResponsaveis = Array.isArray(rec.areas_responsaveis) ? [...rec.areas_responsaveis] : [];
      areasEnvolvidas = Array.isArray(rec.areas_envolvidas) ? [...rec.areas_envolvidas] : [];
      renderAreas();
      renderAreasEnvolvidas();

      // ações
      acoesTemp = Array.isArray(rec.acoes) ? JSON.parse(JSON.stringify(rec.acoes)) : [];
      editingAcaoIndex = null;
      setAcaoFormMode(false);
      renderAcoesTemp();

      // relatório formal
      document.getElementById("evidencias_cumprimento").value = rec.evidencias_cumprimento || "";
      document.getElementById("justificativa_nao_cumprimento").value = rec.justificativa_nao_cumprimento || "";
      document.getElementById("resultados_percebidos").value = rec.resultados_percebidos || "";

      document.getElementById("modal-recomendacao").style.display = "flex";
      refreshIcons();
    }

    // =========================
    // SUBMITS (SALVAR FUNCIONANDO)
    // =========================
    document.getElementById("processo-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const eixoVal = document.getElementById("eixo").value === "Outro"
        ? (document.getElementById("eixo_outro").value || "Outro")
        : document.getElementById("eixo").value;

      const obj = {
        tipo: "processo",
        processo_id: currentEditingProc || uid("proc"),
        processo_numero: document.getElementById("processo_numero").value,
        eixo: eixoVal,
        unidade: document.getElementById("unidade").value,
        periodo: document.getElementById("periodo").value,
        objeto: document.getElementById("objeto").value,
        responsavel: document.getElementById("responsavel").value,
        auditor: document.getElementById("auditor").value,
        setores_envolvidos: setoresProcesso.join(", "),
        updated_at: new Date().toISOString()
      };

      const res = currentEditingProc
        ? await window.dataSdk.update(obj)
        : await window.dataSdk.create({ ...obj, created_at: new Date().toISOString() });

      if (!res?.isOk) return alert("Falha ao salvar processo: " + (res?.error || "erro"));

      auditAdd(currentEditingProc ? "UPDATE" : "CREATE", "processo", `Processo ${obj.processo_numero}`);
      closeModal("processo");
      renderCurrentView();
    });

    document.getElementById("achado-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentProcessoId) return alert("Processo não definido. Abra o achado a partir do processo.");

      const obj = {
        tipo: "achado",
        processo_id: currentProcessoId,
        achado_id: currentAchadoId || uid("ach"),
        achado_numero: document.getElementById("achado_numero").value,
        achado_subitem: document.getElementById("achado_subitem").value,
        grau_risco: document.getElementById("grau_risco").value,
        impacto: document.getElementById("impacto").value,
        impacto_outro: document.getElementById("impacto_outro").value,
        achado_descricao: document.getElementById("achado_descricao").value,
        responsavel_achado: document.getElementById("responsavel_achado").value,
        evidencia: document.getElementById("evidencia").value,
        updated_at: new Date().toISOString()
      };

      const res = currentAchadoId
        ? await window.dataSdk.update(obj)
        : await window.dataSdk.create({ ...obj, created_at: new Date().toISOString() });

      if (!res?.isOk) return alert("Falha ao salvar achado: " + (res?.error || "erro"));

      auditAdd(currentAchadoId ? "UPDATE" : "CREATE", "achado", `Achado ${obj.achado_numero}${obj.achado_subitem ? "-"+obj.achado_subitem : ""}`);
      closeModal("achado");
      renderCurrentView();
    });

    document.getElementById("recomendacao-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentProcessoId) return alert("Processo não definido. Abra o plano a partir do processo.");

      const base = {
        tipo: "recomendacao",
        processo_id: currentProcessoId,
        recomendacao_id: currentEditingRec || uid("rec"),
        achado_id: document.getElementById("recomendacao_achado_id").value || "",

        recomendacao_numero: document.getElementById("recomendacao_numero").value,
        recomendacao_subitem: document.getElementById("recomendacao_subitem").value,
        recomendacao_texto: document.getElementById("recomendacao_texto").value,

        indicador: document.getElementById("indicador").value,
        resultado: document.getElementById("resultado").value,

        prioridade: document.getElementById("prioridade").value,
        prazo_global: document.getElementById("prazo_global").value,
        responsavel_recomendacao: document.getElementById("responsavel_recomendacao").value,

        areas_responsaveis: areasResponsaveis,
        areas_envolvidas: areasEnvolvidas,

        acoes: acoesTemp,

        evidencias_cumprimento: document.getElementById("evidencias_cumprimento").value,
        justificativa_nao_cumprimento: document.getElementById("justificativa_nao_cumprimento").value,
        resultados_percebidos: document.getElementById("resultados_percebidos").value,

        updated_at: new Date().toISOString()
      };

      const derived = getRecDerived(base);
      const finalObj = { ...base, ...derived };

      const res = currentEditingRec
        ? await window.dataSdk.update(finalObj)
        : await window.dataSdk.create({ ...finalObj, created_at: new Date().toISOString() });

      if (!res?.isOk) return alert("Falha ao salvar plano: " + (res?.error || "erro"));

      const ach = getAchadoById(finalObj.achado_id);
      const achName = ach ? ` (vinculado ao Achado ${ach.achado_numero}${ach.achado_subitem ? "-"+ach.achado_subitem : ""})` : "";
      auditAdd(currentEditingRec ? "UPDATE" : "CREATE", "recomendacao", `Rec ${finalObj.recomendacao_numero}${finalObj.recomendacao_subitem ? "-"+finalObj.recomendacao_subitem : ""}${achName}`);

      closeModal("recomendacao");
      renderCurrentView();
    });

    // =========================
    // LOGIN / SESSION
    // =========================
    function toggleSetorField() {
      const val = document.getElementById("login-perfil").value;
      document.getElementById("setor-field").style.display = val === "Técnico" ? "block" : "none";

      // exemplo simples de setores
      const sel = document.getElementById("login-setor");
      sel.innerHTML = `<option value="">Selecione...</option>
        <option>CAS</option><option>SUAH</option><option>NAO</option><option>Financeiro</option><option>RH</option>`;
    }

    document.getElementById("login-form").addEventListener("submit", (e) => {
      e.preventDefault();

      const perfil = document.getElementById("login-perfil").value;
      const nome = document.getElementById("login-nome").value;
      const setor = document.getElementById("login-setor").value;

      if (perfil === "Técnico" && !setor) return alert("Selecione o setor.");

      userSession = { nome, perfil, setor };
      localStorage.setItem("userSession", JSON.stringify(userSession));

      auditAdd("LOGIN", "processo", `Login: ${perfil}${setor ? " ("+setor+")" : ""}`);

      document.getElementById("login-screen").style.display = "none";
      document.getElementById("app").style.display = "flex";
      updateUserUI();
      showView("dashboard");
    });

    function updateUserUI() {
      if (!userSession) return;

      document.getElementById("user-name-sidebar").textContent = userSession.nome;
      document.getElementById("user-role-sidebar").textContent = userSession.perfil;

      const initials = (userSession.nome || "U").trim().split(/\s+/).slice(0,2).map(s => s[0]?.toUpperCase() || "").join("");
      document.getElementById("user-avatar").textContent = initials || "U";
      document.getElementById("user-avatar-header").textContent = initials || "U";

      // badge setor
      if (userSession.perfil === "Técnico" && userSession.setor) {
        document.getElementById("user-setor-badge").style.display = "block";
        document.getElementById("user-setor-text").textContent = userSession.setor;
      } else {
        document.getElementById("user-setor-badge").style.display = "none";
      }

      // auditoria menu para ADM
      document.getElementById("nav-auditoria").style.display = isAdmin() ? "flex" : "none";
    }

    function logout() {
      localStorage.removeItem("userSession");
      location.reload();
    }

    // =========================
    // EXPORTS (placeholders)
    // =========================
    function exportMenuOpen() { document.getElementById("modal-export").style.display = "flex"; }
    function exportPDFGeral() { alert("Exportação PDF: em desenvolvimento."); }
    function exportPDFFormalGeral() { alert("Exportação PDF formal: em desenvolvimento."); }

    // =========================
    // INIT
    // =========================
    window.addEventListener("DOMContentLoaded", async () => {
      // session
      const session = localStorage.getItem("userSession");
      if (session) {
        userSession = safeParse(session, null);
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("app").style.display = "flex";
        updateUserUI();
      }

      ensureDataSdk();

      await window.dataSdk.init({
        onDataChanged: (d) => {
          allData = Array.isArray(d) ? d : [];
          renderCurrentView();
          // se modal de rec estiver aberto, atualiza achados do processo
          const recModalOpen = document.getElementById("modal-recomendacao").style.display === "flex";
          if (recModalOpen && currentProcessoId) populateAchadoSelect(currentProcessoId);
        }
      });

      // primeiro render
      if (userSession) showView("dashboard");
      refreshIcons();
    });
  </script>

</body>
</html>
