<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Processos Auditados | Gestão de Auditoria</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Se você NÃO usa o SDK do ambiente (_sdk), pode deixar essas 2 linhas removidas.
       Se deixar e estiver no GitHub Pages, elas podem dar 404 e tudo bem: o código abaixo faz fallback automático. -->
  <!-- <script src="/_sdk/data_sdk.js"></script> -->
  <!-- <script src="/_sdk/element_sdk.js"></script> -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    body { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    .sidebar-item:hover { background-color: #1e293b; }
    .active-link { background-color: #64748b; color: white; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in { animation: fadeIn 0.2s ease-out; }

    /* Tailwind "line-clamp-3" não vem por padrão via CDN */
    .line-clamp-3{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-full">

  <!-- TELA DE LOGIN -->
  <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-gradient-to-r from-slate-600 to-slate-700 p-8 text-white text-center">
        <i data-lucide="shield-check" class="w-16 h-16 mx-auto mb-4"></i>
        <h1 class="text-2xl font-bold mb-2">PROCESSOS AUDITADOS</h1>
        <p class="text-sm opacity-90">SESAP/RN</p>
      </div>

      <div class="p-8">
        <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Selecione seu Perfil</h2>

        <form id="login-form" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Usuário *</label>
            <select id="login-perfil" required onchange="toggleSetorField()"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
              <option value="">Selecione...</option>
              <option value="Administrador Geral - CAS ADM">Administrador Geral - CAS ADM</option>
              <option value="Técnico">Técnico (Por Setor)</option>
            </select>
          </div>

          <div id="setor-field" style="display: none;">
            <label class="block text-sm font-medium text-slate-700 mb-2">Setor Responsável *</label>
            <select id="login-setor"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base">
              <option value="">Selecione seu setor...</option>
            </select>
            <p class="text-xs text-slate-500 mt-2">Você verá apenas processos do seu setor cadastrados pelo Administrador</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Nome Completo *</label>
            <input type="text" id="login-nome" required placeholder="Digite seu nome"
              class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <button type="submit" id="login-btn"
            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl">
            Entrar no Sistema
          </button>
        </form>

        <div class="mt-6 pt-6 border-t border-slate-200 text-center text-xs text-slate-500">
          <p>Sistema de Gestão de Auditorias</p>
          <p class="mt-1">Desenvolvido por Maria Eloiza da Silva - CAS-Administrativo</p>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display: none;" class="flex h-full overflow-hidden w-full">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col hidden md:flex">
      <div class="p-6 flex items-center gap-3 text-white border-b border-slate-800">
        <i data-lucide="shield-check" class="text-slate-400"></i>
        <span id="system-title" class="font-bold text-xl tracking-tight">PROCESSOS AUDITADOS</span>
      </div>

      <!-- INFO DO USUÁRIO -->
      <div class="px-4 py-4 bg-slate-800 border-b border-slate-700">
        <div class="flex items-center gap-3 mb-2">
          <div class="h-10 w-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm" id="user-avatar">AD</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-white truncate" id="user-name-sidebar">Usuário</p>
            <p class="text-xs text-slate-400" id="user-role-sidebar">Carregando...</p>
          </div>
        </div>

        <div id="user-setor-badge" style="display: none;" class="mt-2 px-3 py-1.5 bg-blue-600 bg-opacity-20 border border-blue-500 rounded-lg">
          <p class="text-xs font-semibold text-blue-300 text-center" id="user-setor-text"></p>
        </div>
      </div>

      <nav class="flex-1 px-4 space-y-2 mt-4">
        <a href="#" onclick="showView('dashboard'); return false;" id="nav-dashboard"
          class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all active-link">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
        </a>

        <a href="#" onclick="showView('processos'); return false;" id="nav-processos"
          class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all">
          <i data-lucide="clipboard-list" class="w-5 h-5"></i> Processos
        </a>

        <a href="#" onclick="showView('recomendacoes'); return false;" id="nav-recomendacoes"
          class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all">
          <i data-lucide="alert-circle" class="w-5 h-5"></i> Recomendações
        </a>

        <a href="#" onclick="exportMenuOpen(); return false;"
          class="sidebar-item flex items-center gap-3 p-3 rounded-lg transition-all">
          <i data-lucide="download" class="w-5 h-5"></i> Exportar PDF
        </a>
      </nav>

      <div class="p-4 border-t border-slate-800">
        <button onclick="logout()"
          class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
          <i data-lucide="log-out" class="w-4 h-4"></i> Sair
        </button>

        <div class="mt-3 text-xs text-slate-500 text-center">
          <span id="institution-name">SESAP/RN</span>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto">

      <!-- HEADER -->
      <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 sticky top-0 z-10">
        <div>
          <h1 id="page-title" class="font-semibold text-lg text-slate-800">Dashboard</h1>
          <p id="page-subtitle" class="text-xs text-slate-500"></p>
        </div>

        <div class="flex items-center gap-4">
          <button onclick="openNewProcessModal()" class="bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700 flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>

          <div class="h-8 w-8 bg-slate-600 rounded-full flex items-center justify-center text-white font-medium text-sm" id="user-avatar-header">AD</div>
        </div>
      </header>

      <!-- DASHBOARD -->
      <div id="view-dashboard" class="p-8 max-w-7xl mx-auto">

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <p class="text-sm font-medium text-slate-500">Total de Locais</p>
            <h3 id="dash-total-locais" class="text-3xl font-bold mt-2">0</h3>
            <p class="text-xs text-slate-400 mt-2">Unidades auditadas</p>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <p class="text-sm font-medium text-slate-500">Total de Processos</p>
            <h3 id="dash-total-processos" class="text-3xl font-bold mt-2">0</h3>
            <p class="text-xs text-slate-400 mt-2">Processos cadastrados</p>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <p class="text-sm font-medium text-slate-500">Total de Recomendações</p>
            <h3 id="dash-total-recomendacoes" class="text-3xl font-bold mt-2">0</h3>
            <p class="text-xs text-emerald-600 font-medium mt-2">Recomendações ativas</p>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <p class="text-sm font-medium text-red-600">Atrasadas</p>
            <h3 id="dash-atrasadas" class="text-3xl font-bold mt-2 text-red-600">0</h3>
            <p class="text-xs text-slate-400 mt-2">Requerem atenção urgente</p>
          </div>
        </div>

        <div class="mb-6">
          <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
            <i data-lucide="map-pin" class="w-7 h-7 text-slate-600"></i> Auditorias por Local
          </h2>
          <p class="text-slate-500 mt-1">Clique em um local para ver os detalhes das recomendações</p>
        </div>

        <div id="locais-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div id="dashboard-empty" style="display: none;" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center">
          <i data-lucide="folder-open" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-bold text-slate-700 mb-2">Nenhuma auditoria cadastrada</h3>
          <p class="text-slate-500 mb-6">Comece criando seu primeiro processo de auditoria</p>
          <button onclick="openNewProcessModal()" class="bg-slate-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-slate-700 inline-flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
        </div>
      </div>

      <!-- PROCESSOS -->
      <div id="view-processos" style="display: none;" class="p-8 max-w-7xl mx-auto">
        <div id="processos-list" class="space-y-6"></div>

        <div id="processos-empty" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center">
          <i data-lucide="folder-open" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-bold text-slate-700 mb-2">Nenhum processo cadastrado</h3>
          <p class="text-slate-500 mb-6">Comece criando seu primeiro processo de auditoria</p>
          <button onclick="openNewProcessModal()" class="bg-slate-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-slate-700 inline-flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> Novo Processo
          </button>
        </div>
      </div>

      <!-- RECOMENDAÇÕES -->
      <div id="view-recomendacoes" style="display: none;" class="p-8 max-w-7xl mx-auto">
        <div id="recomendacoes-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div id="recomendacoes-empty" style="display: none;" class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center">
          <i data-lucide="clipboard-check" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
          <h3 class="text-xl font-bold text-slate-700 mb-2">Nenhuma recomendação encontrada</h3>
          <p class="text-slate-500">As recomendações atribuídas ao seu setor aparecerão aqui</p>
        </div>
      </div>

    </main>
  </div>

  <!-- MODAL PROCESSO -->
  <div id="modal-processo" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-bold text-xl text-slate-800">Novo Processo</h2>
        <button onclick="closeModal('processo')" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <form id="processo-form" class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Nº do Processo SEI *</label>
            <input type="text" id="processo_numero" required
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Eixo *</label>
            <select id="eixo" onchange="toggleEixoOutro()" required
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Selecione...</option>
              <option value="Orçamento e Estoques">Orçamento e Estoques</option>
              <option value="Demandas Judiciais">Demandas Judiciais</option>
              <option value="Contratos">Contratos</option>
              <option value="Outro">Outro</option>
            </select>

            <input type="text" id="eixo_outro" placeholder="Digite o nome do novo eixo..." style="display: none;"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mt-2" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Unidade *</label>
            <input type="text" id="unidade" required placeholder="Hospital/Setor"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Período *</label>
            <input type="text" id="periodo" required placeholder="Janeiro/2024"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-2">Objeto da Auditoria *</label>
            <input type="text" id="objeto" required
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Responsável</label>
            <input type="text" id="responsavel" placeholder="Gestor da unidade"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Auditor Responsável</label>
            <input type="text" id="auditor"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-2">Setores/Áreas Envolvidos *</label>
            <p class="text-xs text-blue-600 mb-2">Técnicos destes setores poderão acessar e editar este processo</p>

            <div id="setores-processo-container" class="space-y-2 mb-2"></div>

            <div class="flex gap-2">
              <input type="text" id="setor_processo_input" placeholder="Ex: CAS, SUAH, Hospital Walfredo Gurgel..."
                class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              <button type="button" onclick="adicionarSetorProcesso()"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
              </button>
            </div>
          </div>

        </div>

        <div class="flex gap-3 justify-end pt-4 border-t border-slate-200">
          <button type="button" onclick="closeModal('processo')"
            class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
            Cancelar
          </button>
          <button type="submit" id="submit-processo-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
            <span id="submit-processo-text">Salvar Processo</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL ACHADO -->
  <div id="modal-achado" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-bold text-xl text-slate-800">Novo Achado</h2>
        <button onclick="closeModal('achado')" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <form id="achado-form" class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Nº do Achado *</label>
            <input type="text" id="achado_numero" required placeholder="001"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Subitem</label>
            <input type="text" id="achado_subitem" placeholder="a, b, c..."
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Grau de Risco *</label>
            <select id="grau_risco" required
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Selecione...</option>
              <option value="Alto">Alto</option>
              <option value="Médio">Médio</option>
              <option value="Baixo">Baixo</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-2">Descrição do Achado *</label>
            <textarea id="achado_descricao" required rows="4"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Impacto</label>
            <select id="impacto" onchange="toggleImpactoOutro()"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Selecione...</option>
              <option value="Financeiro">Financeiro</option>
              <option value="Operacional">Operacional</option>
              <option value="Legal">Legal</option>
              <option value="Reputacional">Reputacional</option>
              <option value="Outro">Outro</option>
            </select>

            <input type="text" id="impacto_outro" placeholder="Especifique o impacto..." style="display: none;"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mt-2" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Evidência</label>
            <input type="text" id="evidencia" placeholder="Número do documento"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>

        </div>

        <div class="flex gap-3 justify-end pt-4 border-t border-slate-200">
          <button type="button" onclick="closeModal('achado')"
            class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
            Cancelar
          </button>

          <button type="submit" id="submit-achado-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
            <span id="submit-achado-text">Salvar Achado</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL EXPORT -->
  <div id="modal-export" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-bold text-xl text-slate-800">Exportar Plano de Ação em PDF</h2>
        <button onclick="closeModal('export')" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="p-6 space-y-6">

        <div class="border-2 border-blue-300 bg-blue-50 rounded-xl p-4 mb-4">
          <h3 class="font-bold text-blue-900 mb-3 text-lg flex items-center gap-2">
            <i data-lucide="clipboard-list" class="w-6 h-6"></i> Plano de Ação 5W2H
          </h3>

          <div class="space-y-3">
            <div class="bg-white border border-blue-200 rounded-lg p-4 hover:border-blue-400 transition-all cursor-pointer" onclick="exportPDFGeral()">
              <div class="flex items-start gap-4">
                <div class="bg-blue-100 rounded-lg p-3">
                  <i data-lucide="file-text" class="w-7 h-7 text-blue-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-slate-800 mb-1">Relatório Geral - Todas as Recomendações</h4>
                  <p class="text-sm text-slate-600">Exporta todas as recomendações com plano 5W2H completo</p>
                </div>
                <i data-lucide="download" class="w-5 h-5 text-slate-400"></i>
              </div>
            </div>

            <div class="bg-white border border-blue-200 rounded-lg p-4">
              <div class="flex items-start gap-4 mb-3">
                <div class="bg-blue-100 rounded-lg p-3">
                  <i data-lucide="folder" class="w-7 h-7 text-blue-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-slate-800 mb-1">Por Processo - Plano 5W2H</h4>
                  <p class="text-sm text-slate-600">Exporta recomendações de um processo específico com 5W2H</p>
                </div>
              </div>

              <div id="processos-plano-list" class="space-y-2 pl-14 max-h-48 overflow-y-auto"></div>
            </div>
          </div>
        </div>

        <div class="border-2 border-purple-300 bg-purple-50 rounded-xl p-4">
          <h3 class="font-bold text-purple-900 mb-3 text-lg flex items-center gap-2">
            <i data-lucide="file-check" class="w-6 h-6"></i> Relatório Formal de Acompanhamento
          </h3>

          <div class="space-y-3">
            <div class="bg-white border border-purple-200 rounded-lg p-4 hover:border-purple-400 transition-all cursor-pointer" onclick="exportPDFFormalGeral()">
              <div class="flex items-start gap-4">
                <div class="bg-purple-100 rounded-lg p-3">
                  <i data-lucide="file-check-2" class="w-7 h-7 text-purple-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-slate-800 mb-1">Relatório Formal - Todas as Recomendações</h4>
                  <p class="text-sm text-slate-600">Relatório completo com evidências, justificativas e resultados</p>
                </div>
                <i data-lucide="download" class="w-5 h-5 text-slate-400"></i>
              </div>
            </div>

            <div class="bg-white border border-purple-200 rounded-lg p-4">
              <div class="flex items-start gap-4 mb-3">
                <div class="bg-purple-100 rounded-lg p-3">
                  <i data-lucide="folder-check" class="w-7 h-7 text-purple-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-slate-800 mb-1">Por Processo - Relatório Formal</h4>
                  <p class="text-sm text-slate-600">Relatório formal de um processo específico</p>
                </div>
              </div>

              <div id="processos-formal-list" class="space-y-2 pl-14 max-h-48 overflow-y-auto"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL RECOMENDAÇÃO -->
  <div id="modal-recomendacao" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white p-6 border-b border-slate-200 flex items-center justify-between">
        <h2 class="font-bold text-xl text-slate-800">Nova Recomendação e Plano 5W2H</h2>
        <button onclick="closeModal('recomendacao')" class="text-slate-400 hover:text-slate-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <form id="recomendacao-form" class="p-6 space-y-6">

        <div>
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Dados da Recomendação</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Nº da Recomendação *</label>
              <input type="text" id="recomendacao_numero" required placeholder="R-001"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Subitem</label>
              <input type="text" id="recomendacao_subitem" placeholder="a, b, c..."
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Prioridade *</label>
              <select id="prioridade" required
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Selecione...</option>
                <option value="Alta">Alta</option>
                <option value="Média">Média</option>
                <option value="Baixa">Baixa</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 mb-2">Texto da Recomendação *</label>
              <textarea id="recomendacao_texto" required rows="3"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Responsável pela Recomendação</label>
              <input type="text" id="responsavel_recomendacao" placeholder="Nome do responsável direto"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              <p class="text-xs text-slate-500 mt-1">Responsável direto pela execução</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Prazo Global *</label>
              <input type="text" id="prazo_global" required placeholder="60 dias"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 mb-2">Áreas/Setores Responsáveis *</label>
              <div id="areas-container" class="space-y-2 mb-2"></div>

              <div class="flex gap-2">
                <input type="text" id="area_input" placeholder="Digite o nome da área ou setor..."
                  class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                <button type="button" onclick="adicionarArea()"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                  <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
                </button>
              </div>

              <p class="text-xs text-slate-500 mt-2">Exemplos: CAS, SUAH, Hospital Walfredo Gurgel, etc.</p>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-700 mb-2">Áreas Envolvidas no Plano de Ação</label>
              <div id="areas-envolvidas-container" class="space-y-2 mb-2"></div>

              <div class="flex gap-2">
                <input type="text" id="area_envolvida_input" placeholder="Digite o nome da área envolvida..."
                  class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" />
                <button type="button" onclick="adicionarAreaEnvolvida()"
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                  <i data-lucide="plus" class="w-4 h-4"></i> Adicionar
                </button>
              </div>

              <p class="text-xs text-slate-500 mt-2">Áreas que participam da execução do plano</p>
            </div>

          </div>
        </div>

        <div class="border-t border-slate-200 pt-6">
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Plano de Ação 5W2H</h3>
          <p class="text-xs text-amber-600 mb-4 bg-amber-50 p-3 rounded-lg flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i>
            <span>Os campos do plano de ação são opcionais. As áreas responsáveis podem preencher posteriormente.</span>
          </p>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                <span class="text-slate-600 font-bold">O QUE</span> - O que será feito?
              </label>
              <textarea id="what" rows="2" placeholder="Descreva a ação corretiva"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                <span class="text-slate-600 font-bold">POR QUÊ</span> - Por quê?
              </label>
              <textarea id="why" rows="2" placeholder="Justificativa da ação"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  <span class="text-slate-600 font-bold">ONDE</span> - Onde?
                </label>
                <input type="text" id="where" placeholder="Local ou setor"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  <span class="text-slate-600 font-bold">QUANDO</span> - Quando?
                </label>
                <input type="date" id="when"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  <span class="text-slate-600 font-bold">QUEM</span> - Quem?
                </label>
                <input type="text" id="who" placeholder="Nome do responsável"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500" />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                  <span class="text-slate-600 font-bold">QUANTO</span> - Quanto custa?
                </label>
                <input type="text" id="how_much" placeholder="R$ 0,00 ou sem custo"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                <span class="text-slate-600 font-bold">COMO</span> - Como?
              </label>
              <textarea id="how" rows="3" placeholder="Descreva como será executado"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">
                <span class="text-slate-600 font-bold">INDICADOR</span> - Indicador de Acompanhamento
              </label>
              <textarea id="indicador" rows="2" placeholder="Como será medido/acompanhado o progresso?"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 pt-6">
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Status e Observações</h3>

          <div class="grid grid-cols-1 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Status *</label>
              <select id="status" required
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="Pendente">Pendente</option>
                <option value="Em Execução">Em Execução</option>
                <option value="Atrasado">Atrasado</option>
                <option value="Concluído">Concluído</option>
                <option value="Não Atendido">Não Atendido</option>
                <option value="Parcialmente Atendido">Parcialmente Atendido</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Observações</label>
              <textarea id="observacao" rows="3" placeholder="Notas adicionais..."
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-200 pt-6">
          <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Informações para Relatório Formal</h3>
          <p class="text-xs text-blue-600 mb-4 bg-blue-50 p-3 rounded-lg flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i>
            <span>Estes campos são usados no Relatório Formal e podem ser preenchidos posteriormente.</span>
          </p>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Evidências do Cumprimento (Total ou Parcial)</label>
              <textarea id="evidencias_cumprimento" rows="3" placeholder="Descreva as evidências..."
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Justificativa do Não Cumprimento Total ou Cumprimento Parcial</label>
              <textarea id="justificativa_nao_cumprimento" rows="4" placeholder="Explique os motivos..."
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Resultados Percebidos (por conta do cumprimento parcial ou total)</label>
              <textarea id="resultados_percebidos" rows="3" placeholder="Descreva os benefícios..."
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-slate-500"></textarea>
            </div>
          </div>
        </div>

        <div class="flex gap-3 justify-end pt-4 border-t border-slate-200">
          <button type="button" onclick="closeModal('recomendacao')"
            class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">
            Cancelar
          </button>

          <button type="submit" id="submit-recomendacao-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
            <span id="submit-recomendacao-text">Salvar Recomendação</span>
          </button>
        </div>

      </form>
    </div>
  </div>

  <script>
    /* ============================================================
       CAMADA DE DADOS (FALLBACK PARA GITHUB PAGES)
       - Se existir window.dataSdk com create/update/delete reais, usa.
       - Se não existir, usa localStorage automaticamente.
    ============================================================ */

    const STORAGE_KEY = "processos_auditados_v1";

    function safeParse(json, fallback) {
      try { return JSON.parse(json) ?? fallback; } catch { return fallback; }
    }

    function getStoredData() {
      return safeParse(localStorage.getItem(STORAGE_KEY), []);
    }

    function setStoredData(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function getIdFieldByTipo(tipo) {
      if (tipo === "processo") return "processo_id";
      if (tipo === "achado") return "achado_id";
      if (tipo === "recomendacao") return "recomendacao_id";
      return null;
    }

    const localSdk = {
      _onDataChanged: null,

      async init({ onDataChanged } = {}) {
        this._onDataChanged = typeof onDataChanged === "function" ? onDataChanged : null;
        const data = getStoredData();
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },

      async create(item) {
        if (!item || !item.tipo) return { isOk: false, error: "Item inválido" };

        const idField = getIdFieldByTipo(item.tipo);
        if (!idField || !item[idField]) return { isOk: false, error: "ID ausente" };

        const data = getStoredData();

        const already = data.some(d => d.tipo === item.tipo && d[idField] === item[idField]);
        if (already) return { isOk: false, error: "ID já existe" };

        data.push(item);
        setStoredData(data);
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },

      async update(item) {
        if (!item || !item.tipo) return { isOk: false, error: "Item inválido" };

        const idField = getIdFieldByTipo(item.tipo);
        if (!idField || !item[idField]) return { isOk: false, error: "ID ausente" };

        const data = getStoredData();
        const idx = data.findIndex(d => d.tipo === item.tipo && d[idField] === item[idField]);
        if (idx === -1) return { isOk: false, error: "Item não encontrado" };

        data[idx] = item;
        setStoredData(data);
        if (this._onDataChanged) this._onDataChanged(data);
        return { isOk: true };
      },

      async delete(item) {
        if (!item || !item.tipo) return { isOk: false, error: "Item inválido" };

        const idField = getIdFieldByTipo(item.tipo);
        if (!idField || !item[idField]) return { isOk: false, error: "ID ausente" };

        const data = getStoredData();
        const next = data.filter(d => !(d.tipo === item.tipo && d[idField] === item[idField]));
        setStoredData(next);
        if (this._onDataChanged) this._onDataChanged(next);
        return { isOk: true };
      }
    };

    function ensureDataSdk() {
      const hasAll =
        window.dataSdk &&
        typeof window.dataSdk.init === "function" &&
        typeof window.dataSdk.create === "function" &&
        typeof window.dataSdk.update === "function" &&
        typeof window.dataSdk.delete === "function";

      if (!hasAll) {
        window.dataSdk = localSdk;
        return;
      }

      const original = window.dataSdk;
      const oldInit = original.init.bind(original);

      original.init = async function(args) {
        try {
          const res = await oldInit(args);
          if (!res || res.isOk === false) throw new Error(res?.error || "init falhou");
          return res;
        } catch (e) {
          console.warn("dataSdk.init falhou, usando localStorage.", e);
          window.dataSdk = localSdk;
          return localSdk.init(args);
        }
      };
    }

    /* ============================================================
       VARIÁVEIS GLOBAIS
    ============================================================ */
    let allData = [];
    let currentView = "dashboard";
    let currentProcessoId = null;
    let currentAchadoId = null;
    let userSession = null;
    let areasResponsaveis = [];
    let areasEnvolvidas = [];
    let setoresProcesso = [];
    let currentEditingRec = null;

    /* ============================================================
       LOGIN
    ============================================================ */
    function toggleSetorField() {
      const perfil = document.getElementById("login-perfil").value;
      const setorField = document.getElementById("setor-field");
      const setorSelect = document.getElementById("login-setor");

      if (perfil === "Técnico") {
        setorField.style.display = "block";
        setorSelect.required = true;
        popularSetoresLogin();
      } else {
        setorField.style.display = "none";
        setorSelect.required = false;
      }
    }

    function popularSetoresLogin() {
      const setorSelect = document.getElementById("login-setor");
      setorSelect.innerHTML = '<option value="">Selecione seu setor...</option>';

      const processos = allData.filter(d => d.tipo === "processo");
      const setoresUnicos = new Set();

      processos.forEach(p => {
        if (p.setores_envolvidos) {
          const setores = p.setores_envolvidos.split(";").map(s => s.trim()).filter(Boolean);
          setores.forEach(s => setoresUnicos.add(s));
        }
      });

      if (setoresUnicos.size > 0) {
        [...setoresUnicos].sort().forEach(setor => {
          const option = document.createElement("option");
          option.value = setor;
          option.textContent = setor;
          setorSelect.appendChild(option);
        });
      } else {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Nenhum setor cadastrado ainda";
        option.disabled = true;
        setorSelect.appendChild(option);
      }
    }

    document.getElementById("login-form").addEventListener("submit", function(e) {
      e.preventDefault();

      const perfil = document.getElementById("login-perfil").value;
      const nome = document.getElementById("login-nome").value.trim();
      const setor = document.getElementById("login-setor").value;

      if (!perfil || !nome) {
        showToast("Por favor, preencha todos os campos obrigatórios", "error");
        return;
      }

      if (perfil === "Técnico" && !setor) {
        showToast("Por favor, selecione seu setor", "error");
        return;
      }

      userSession = {
        nome,
        perfil,
        setor: setor || null,
        loginTime: new Date().toISOString()
      };

      localStorage.setItem("userSession", JSON.stringify(userSession));

      document.getElementById("login-screen").style.display = "none";
      document.getElementById("app").style.display = "flex";

      updateUserUI();
      lucide.createIcons();
      renderCurrentView();
    });

    function updateUserUI() {
      if (!userSession) return;

      const iniciais = userSession.nome.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase();
      document.getElementById("user-avatar").textContent = iniciais;
      document.getElementById("user-avatar-header").textContent = iniciais;
      document.getElementById("user-name-sidebar").textContent = userSession.nome;

      if (userSession.perfil === "Administrador Geral - CAS ADM") {
        document.getElementById("user-role-sidebar").textContent = "Administrador Geral - CAS ADM";
        document.getElementById("user-setor-badge").style.display = "none";
        document.getElementById("page-subtitle").textContent = "Visão completa de todos os processos";
      } else {
        document.getElementById("user-role-sidebar").textContent = "Técnico";
        document.getElementById("user-setor-badge").style.display = "block";
        document.getElementById("user-setor-text").textContent = userSession.setor || "";
        document.getElementById("page-subtitle").textContent = "Processos do setor: " + (userSession.setor || "");
      }
    }

    function logout() {
      const modal = document.createElement("div");
      modal.style.cssText = "position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;";
      modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 12px; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
          <h3 style="font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 12px;">Confirmar Saída</h3>
          <p style="color: #64748b; margin-bottom: 24px;">Deseja realmente sair do sistema?</p>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="cancel-logout" style="padding: 8px 16px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #475569; cursor: pointer; font-weight: 500;">Cancelar</button>
            <button id="confirm-logout" style="padding: 8px 16px; border: none; border-radius: 8px; background: #dc2626; color: white; cursor: pointer; font-weight: 500;">Sair</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById("cancel-logout").onclick = () => document.body.removeChild(modal);
      document.getElementById("confirm-logout").onclick = () => {
        localStorage.removeItem("userSession");
        userSession = null;
        location.reload();
      };
    }

    /* ============================================================
       STARTUP
    ============================================================ */
    window.addEventListener("DOMContentLoaded", async () => {
      const savedSession = localStorage.getItem("userSession");
      if (savedSession) {
        userSession = safeParse(savedSession, null);
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("app").style.display = "flex";
        updateUserUI();
      }

      ensureDataSdk();

      const initResult = await window.dataSdk.init({
        onDataChanged: (data) => {
          allData = Array.isArray(data) ? data : [];
          if (document.getElementById("login-perfil")?.value === "Técnico") popularSetoresLogin();
          renderCurrentView();
        }
      });

      if (!initResult?.isOk) {
        console.error("Erro ao inicializar SDK:", initResult?.error);
        showToast("Erro ao inicializar dados. Usando modo local.", "error");
        window.dataSdk = localSdk;
        await window.dataSdk.init({
          onDataChanged: (data) => {
            allData = Array.isArray(data) ? data : [];
            renderCurrentView();
          }
        });
      }

      lucide.createIcons();
      renderCurrentView();
    });

    /* ============================================================
       NAVEGAÇÃO
    ============================================================ */
    function showView(view) {
      currentView = view;

      document.querySelectorAll('[id^="view-"]').forEach(v => v.style.display = "none");
      const viewEl = document.getElementById("view-" + view);
      if (viewEl) viewEl.style.display = "block";

      document.querySelectorAll('[id^="nav-"]').forEach(n => n.classList.remove("active-link"));
      const navEl = document.getElementById("nav-" + view);
      if (navEl) navEl.classList.add("active-link");

      const titles = { dashboard: "Dashboard", processos: "Processos", recomendacoes: "Recomendações" };
      document.getElementById("page-title").textContent = titles[view] || view;

      renderCurrentView();
    }

    function renderCurrentView() {
      const filteredData = filterDataByUser(allData);

      if (currentView === "dashboard") renderDashboard(filteredData);
      else if (currentView === "processos") renderProcessos(filteredData);
      else if (currentView === "recomendacoes") renderRecomendacoes(filteredData);

      lucide.createIcons();
    }

    function filterDataByUser(data) {
      if (!userSession || userSession.perfil === "Administrador Geral - CAS ADM") return data;

      const userSetor = userSession.setor || "";

      const processosPermitidos = data.filter(item => {
        if (item.tipo !== "processo") return false;
        const setores = item.setores_envolvidos || "";
        return setores.includes(userSetor);
      });

      const processosIds = processosPermitidos.map(p => p.processo_id);

      return data.filter(item => {
        if (item.tipo === "processo") return processosIds.includes(item.processo_id);
        if (item.tipo === "achado" || item.tipo === "recomendacao") return processosIds.includes(item.processo_id);
        return false;
      });
    }

    /* ============================================================
       RENDER: DASHBOARD / PROCESSOS / RECOMENDAÇÕES
    ============================================================ */
    function renderDashboard(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const recomendacoes = data.filter(d => d.tipo === "recomendacao");

      const locaisUnicos = [...new Set(processos.map(p => p.unidade).filter(Boolean))];

      document.getElementById("dash-total-locais").textContent = locaisUnicos.length;
      document.getElementById("dash-total-processos").textContent = processos.length;
      document.getElementById("dash-total-recomendacoes").textContent = recomendacoes.length;

      const atrasadas = recomendacoes.filter(r => r.status === "Atrasado").length;
      document.getElementById("dash-atrasadas").textContent = atrasadas;

      const locaisContainer = document.getElementById("locais-dashboard");
      const emptyState = document.getElementById("dashboard-empty");

      if (locaisUnicos.length === 0) {
        locaisContainer.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      locaisContainer.innerHTML = locaisUnicos.map(local => {
        const processosLocal = processos.filter(p => p.unidade === local);
        const recsLocal = recomendacoes.filter(r => {
          const proc = processos.find(p => p.processo_id === r.processo_id);
          return proc && proc.unidade === local;
        });

        const pendentes = recsLocal.filter(r => r.status === "Pendente" || r.status === "Em Execução").length;
        const concluidas = recsLocal.filter(r => r.status === "Concluído").length;
        const atrasadasLocal = recsLocal.filter(r => r.status === "Atrasado").length;

        return `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-bold text-lg text-slate-800 mb-1">${escapeHtml(local)}</h3>
                <p class="text-sm text-slate-500">${processosLocal.length} processo(s)</p>
              </div>
              <i data-lucide="building-2" class="w-8 h-8 text-slate-400"></i>
            </div>

            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-slate-600">Total de Recomendações</span>
                <span class="font-bold text-slate-800">${recsLocal.length}</span>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-amber-600">Pendentes/Em Execução</span>
                <span class="font-bold text-amber-600">${pendentes}</span>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-emerald-600">Concluídas</span>
                <span class="font-bold text-emerald-600">${concluidas}</span>
              </div>

              ${atrasadasLocal > 0 ? `
                <div class="flex justify-between items-center">
                  <span class="text-sm text-red-600">Atrasadas</span>
                  <span class="font-bold text-red-600">${atrasadasLocal}</span>
                </div>
              ` : ""}
            </div>
          </div>
        `;
      }).join("");

      lucide.createIcons();
    }

    function renderProcessos(data) {
      const processos = data.filter(d => d.tipo === "processo");
      const container = document.getElementById("processos-list");
      const emptyState = document.getElementById("processos-empty");

      if (processos.length === 0) {
        container.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      container.innerHTML = processos.map(p => {
        const achados = data.filter(d => d.tipo === "achado" && d.processo_id === p.processo_id);
        const recs = data.filter(d => d.tipo === "recomendacao" && d.processo_id === p.processo_id);

        return `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="font-bold text-lg text-slate-800">${escapeHtml(p.processo_numero || "")}</h3>
                  <p class="text-sm text-slate-500">${escapeHtml(p.unidade || "")} - ${escapeHtml(p.periodo || "")}</p>
                </div>
                <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">${escapeHtml(p.eixo || "")}</span>
              </div>

              <p class="text-sm text-slate-600 mb-4">${escapeHtml(p.objeto || "")}</p>

              <div class="flex gap-6 text-sm text-slate-500 mb-4">
                <span><strong>${achados.length}</strong> achados</span>
                <span><strong>${recs.length}</strong> recomendações</span>
              </div>

              <div class="flex gap-2">
                <button onclick="openNewAchadoModal('${p.processo_id}')" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 text-sm font-medium">
                  + Achado
                </button>

                <button onclick="deleteProcesso('${p.processo_id}', this)" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm font-medium">
                  Excluir
                </button>
              </div>
            </div>

            ${achados.length > 0 ? `
              <div class="border-t border-slate-200 bg-slate-50 p-4">
                <h4 class="font-semibold text-sm text-slate-700 mb-3">Achados e Recomendações</h4>
                <div class="space-y-3">
                  ${achados.map(a => {
                    const recsAchado = recs.filter(r => r.achado_id === a.achado_id);

                    return `
                      <div class="bg-white rounded-lg p-4 border border-slate-200">
                        <div class="flex items-start justify-between mb-2">
                          <div class="flex-1">
                            <span class="font-bold text-slate-800">Achado ${escapeHtml(a.achado_numero || "")}${a.achado_subitem ? " - " + escapeHtml(a.achado_subitem) : ""}</span>
                            <span class="ml-2 px-2 py-1 text-xs font-semibold rounded ${
                              a.grau_risco === "Alto" ? "bg-red-100 text-red-700" :
                              a.grau_risco === "Médio" ? "bg-amber-100 text-amber-700" :
                              "bg-emerald-100 text-emerald-700"
                            }">Risco ${escapeHtml(a.grau_risco || "")}</span>
                          </div>

                          <div class="flex gap-2">
                            <button onclick="openNewRecomendacaoModal('${p.processo_id}', '${a.achado_id}')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                              + Recomendação
                            </button>

                            <button onclick="deleteAchado('${a.achado_id}')" class="text-red-600 hover:text-red-700 text-sm font-medium">
                              Excluir
                            </button>
                          </div>
                        </div>

                        <p class="text-sm text-slate-600 mb-3">${escapeHtml(a.achado_descricao || "")}</p>

                        ${recsAchado.length > 0 ? `
                          <div class="pl-4 border-l-2 border-blue-200 space-y-2">
                            ${recsAchado.map(r => `
                              <div class="flex items-start justify-between bg-blue-50 p-3 rounded">
                                <div class="flex-1">
                                  <span class="font-medium text-blue-900 text-sm">Rec. ${escapeHtml(r.recomendacao_numero || "")}${r.recomendacao_subitem ? "-" + escapeHtml(r.recomendacao_subitem) : ""}</span>
                                  <p class="text-xs text-slate-600 mt-1">${escapeHtml((r.recomendacao_texto || "").substring(0, 100))}...</p>

                                  <div class="flex gap-3 mt-2 text-xs">
                                    <span class="px-2 py-1 rounded ${getStatusColor(r.status)}">${escapeHtml(r.status || "")}</span>
                                    <span class="text-slate-500">Prioridade: ${escapeHtml(r.prioridade || "")}</span>
                                  </div>
                                </div>

                                <button onclick="deleteRecomendacao('${r.recomendacao_id}')" class="text-red-600 hover:text-red-700 text-sm ml-3">
                                  Excluir
                                </button>
                              </div>
                            `).join("")}
                          </div>
                        ` : '<p class="text-xs text-slate-400 pl-4">Nenhuma recomendação cadastrada</p>'}
                      </div>
                    `;
                  }).join("")}
                </div>
              </div>
            ` : ""}
          </div>
        `;
      }).join("");

      lucide.createIcons();
    }

    function renderRecomendacoes(data) {
      const recomendacoes = data.filter(d => d.tipo === "recomendacao");
      const processos = data.filter(d => d.tipo === "processo");
      const container = document.getElementById("recomendacoes-cards");
      const emptyState = document.getElementById("recomendacoes-empty");

      if (recomendacoes.length === 0) {
        container.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      container.innerHTML = recomendacoes.map(r => {
        const processo = processos.find(p => p.processo_id === r.processo_id);
        const progresso = Number.isFinite(+r.progresso) ? +r.progresso : 0;
        const isTecnico = userSession && userSession.perfil === "Técnico";

        return `
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-shadow">
            <div class="p-6">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <span class="text-lg font-bold text-slate-800">Rec. ${escapeHtml(r.recomendacao_numero || "")}${r.recomendacao_subitem ? "-" + escapeHtml(r.recomendacao_subitem) : ""}</span>
                  <p class="text-xs text-slate-500 mt-1">${processo ? escapeHtml(processo.unidade || "-") : "-"}</p>
                </div>

                <span class="px-3 py-1 text-xs font-semibold rounded ${
                  r.prioridade === "Alta" ? "bg-red-100 text-red-700" :
                  r.prioridade === "Média" ? "bg-amber-100 text-amber-700" :
                  "bg-emerald-100 text-emerald-700"
                }">${escapeHtml(r.prioridade || "")}</span>
              </div>

              <p class="text-sm text-slate-600 mb-4 line-clamp-3">${escapeHtml(r.recomendacao_texto || "")}</p>

              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium text-slate-600">Progresso</span>
                  <span class="text-xs font-bold ${getProgressColor(progresso)}">${progresso}%</span>
                </div>

                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div class="h-2 rounded-full transition-all ${getProgressBarColor(progresso)}" style="width: ${progresso}%"></div>
                </div>
              </div>

              <div class="mb-4">
                <span class="px-3 py-1 text-xs font-semibold rounded ${getStatusColor(r.status)}">${escapeHtml(r.status || "")}</span>
              </div>

              <div class="space-y-2 text-xs text-slate-600 mb-4">
                ${r.prazo_fim ? `
                  <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                    <span>Prazo: ${formatDate(r.prazo_fim)}</span>
                  </div>
                ` : ""}

                ${r.area_responsavel ? `
                  <div class="flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4 text-slate-400"></i>
                    <span>${escapeHtml(r.area_responsavel)}</span>
                  </div>
                ` : ""}
              </div>

              <div class="flex gap-2">
                ${isTecnico ? `
                  <button onclick="openEditRecomendacao('${r.recomendacao_id}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                    Atualizar
                  </button>
                ` : `
                  <button onclick="openEditRecomendacao('${r.recomendacao_id}')" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 text-sm font-medium">
                    Ver Detalhes
                  </button>

                  <button onclick="deleteRecomendacao('${r.recomendacao_id}')" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm font-medium">
                    Excluir
                  </button>
                `}
              </div>
            </div>
          </div>
        `;
      }).join("");

      lucide.createIcons();
    }

    function getProgressColor(progresso) {
      if (progresso >= 75) return "text-emerald-600";
      if (progresso >= 50) return "text-blue-600";
      if (progresso >= 25) return "text-amber-600";
      return "text-slate-600";
    }

    function getProgressBarColor(progresso) {
      if (progresso >= 75) return "bg-emerald-500";
      if (progresso >= 50) return "bg-blue-500";
      if (progresso >= 25) return "bg-amber-500";
      return "bg-slate-400";
    }

    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return "-";
      return date.toLocaleDateString("pt-BR");
    }

    function getStatusColor(status) {
      const colors = {
        "Pendente": "bg-slate-100 text-slate-700",
        "Em Execução": "bg-blue-100 text-blue-700",
        "Atrasado": "bg-red-100 text-red-700",
        "Concluído": "bg-emerald-100 text-emerald-700",
        "Não Atendido": "bg-orange-100 text-orange-700",
        "Parcialmente Atendido": "bg-amber-100 text-amber-700"
      };
      return colors[status] || "bg-slate-100 text-slate-700";
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    /* ============================================================
       MODAIS
       - Corrigido: openNewProcessModal existe e chama o modal certo.
    ============================================================ */
    function openNewProcessModal() { openNewProcessoModal(); }

    function openNewProcessoModal() {
      setoresProcesso = [];
      renderSetoresProcesso();
      document.getElementById("modal-processo").style.display = "flex";
      document.getElementById("processo-form").reset();
      document.getElementById("eixo_outro").style.display = "none";
      lucide.createIcons();
    }

    function openNewAchadoModal(processoId) {
      currentProcessoId = processoId;
      document.getElementById("modal-achado").style.display = "flex";
      document.getElementById("achado-form").reset();
      document.getElementById("impacto_outro").style.display = "none";
      lucide.createIcons();
    }

    function openNewRecomendacaoModal(processoId, achadoId) {
      currentEditingRec = null;
      currentProcessoId = processoId;
      currentAchadoId = achadoId;
      areasResponsaveis = [];
      areasEnvolvidas = [];
      document.getElementById("recomendacao-form").reset();
      renderAreas();

      // Se existir slider de progresso de outra edição, remove para não duplicar
      const progressEl = document.getElementById("progresso")?.closest("div");
      if (progressEl && progressEl.querySelector("#progresso")) {
        // deixa, porque foi inserido dentro do layout; vamos apenas resetar depois
      }

      document.getElementById("modal-recomendacao").style.display = "flex";
      lucide.createIcons();
    }

    function closeModal(type) {
      const el = document.getElementById("modal-" + type);
      if (el) el.style.display = "none";
    }

    function toggleEixoOutro() {
      const eixo = document.getElementById("eixo").value;
      const eixoOutro = document.getElementById("eixo_outro");
      eixoOutro.style.display = eixo === "Outro" ? "block" : "none";
    }

    function toggleImpactoOutro() {
      const impacto = document.getElementById("impacto").value;
      const impactoOutro = document.getElementById("impacto_outro");
      impactoOutro.style.display = impacto === "Outro" ? "block" : "none";
    }

    function adicionarSetorProcesso() {
      const input = document.getElementById("setor_processo_input");
      const setor = (input.value || "").trim();

      if (!setor) return;

      if (setoresProcesso.includes(setor)) {
        showToast("Este setor já foi adicionado", "error");
        return;
      }

      setoresProcesso.push(setor);
      input.value = "";
      renderSetoresProcesso();
    }

    function removerSetorProcesso(index) {
      setoresProcesso.splice(index, 1);
      renderSetoresProcesso();
    }

    function renderSetoresProcesso() {
      const container = document.getElementById("setores-processo-container");
      container.innerHTML = setoresProcesso.map((setor, index) => `
        <div class="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg">
          <span class="flex-1 text-sm text-blue-900 font-medium">${escapeHtml(setor)}</span>
          <button type="button" onclick="removerSetorProcesso(${index})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");
      lucide.createIcons();
    }

    function adicionarArea() {
      const input = document.getElementById("area_input");
      const area = (input.value || "").trim();
      if (!area) return;

      if (!areasResponsaveis.includes(area)) {
        areasResponsaveis.push(area);
        input.value = "";
        renderAreas();
      }
    }

    function adicionarAreaEnvolvida() {
      const input = document.getElementById("area_envolvida_input");
      const area = (input.value || "").trim();
      if (!area) return;

      if (!areasEnvolvidas.includes(area)) {
        areasEnvolvidas.push(area);
        input.value = "";
        renderAreas();
      }
    }

    function removerArea(index) {
      areasResponsaveis.splice(index, 1);
      renderAreas();
    }

    function removerAreaEnvolvida(index) {
      areasEnvolvidas.splice(index, 1);
      renderAreas();
    }

    function renderAreas() {
      const container = document.getElementById("areas-container");
      container.innerHTML = areasResponsaveis.map((area, index) => `
        <div class="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg">
          <span class="flex-1 text-sm text-blue-900">${escapeHtml(area)}</span>
          <button type="button" onclick="removerArea(${index})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");

      const containerEnv = document.getElementById("areas-envolvidas-container");
      containerEnv.innerHTML = areasEnvolvidas.map((area, index) => `
        <div class="flex items-center gap-2 bg-purple-50 px-3 py-2 rounded-lg">
          <span class="flex-1 text-sm text-purple-900">${escapeHtml(area)}</span>
          <button type="button" onclick="removerAreaEnvolvida(${index})" class="text-red-600 hover:text-red-700">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join("");

      lucide.createIcons();
    }

    /* ============================================================
       SUBMITS (PROCESSO / ACHADO / RECOMENDAÇÃO)
       - Corrigido: mensagens mostram o erro real (não fica "inesperado")
    ============================================================ */
    document.getElementById("processo-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (setoresProcesso.length === 0) {
        showToast("Por favor, adicione pelo menos um setor envolvido", "error");
        return;
      }

      const btn = document.getElementById("submit-processo-btn");
      const btnText = document.getElementById("submit-processo-text");
      btn.disabled = true;
      btnText.textContent = "Salvando...";

      try {
        let eixo = document.getElementById("eixo").value;
        if (eixo === "Outro") {
          const eixoOutroValue = document.getElementById("eixo_outro").value.trim();
          if (!eixoOutroValue) {
            showToast("Por favor, especifique o nome do novo eixo", "error");
            return;
          }
          eixo = eixoOutroValue;
        }

        const processoNumero = document.getElementById("processo_numero").value.trim();
        const unidade = document.getElementById("unidade").value.trim();
        const periodo = document.getElementById("periodo").value.trim();
        const objeto = document.getElementById("objeto").value.trim();

        if (!processoNumero || !unidade || !periodo || !objeto || !eixo) {
          showToast("Preencha todos os campos obrigatórios do processo", "error");
          return;
        }

        const processoId = "proc_" + Date.now() + "_" + Math.random().toString(36).slice(2);

        const processo = {
          tipo: "processo",
          processo_id: processoId,
          processo_numero: processoNumero,
          eixo: eixo,
          unidade: unidade,
          objeto: objeto,
          periodo: periodo,
          responsavel: document.getElementById("responsavel").value.trim(),
          auditor: document.getElementById("auditor").value.trim(),
          setores_envolvidos: setoresProcesso.join("; "),
          created_at: new Date().toISOString(),
          updated_by: userSession ? userSession.nome : "Administrador"
        };

        const result = await window.dataSdk.create(processo);

        if (result?.isOk) {
          setoresProcesso = [];
          renderSetoresProcesso();
          document.getElementById("processo-form").reset();
          document.getElementById("eixo_outro").style.display = "none";
          closeModal("processo");
          showToast("✓ Processo cadastrado com sucesso!", "success");
          popularSetoresLogin();
        } else {
          showToast("Erro ao salvar processo: " + (result?.error || "falha"), "error");
        }
      } catch (err) {
        console.error("Erro no cadastro:", err);
        showToast("Erro ao cadastrar: " + (err?.message || String(err)), "error");
      } finally {
        btn.disabled = false;
        btnText.textContent = "Salvar Processo";
      }
    });

    document.getElementById("achado-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentProcessoId) {
        showToast("Selecione um processo antes de cadastrar achado", "error");
        return;
      }

      const btn = document.getElementById("submit-achado-btn");
      const btnText = document.getElementById("submit-achado-text");
      btn.disabled = true;
      btnText.textContent = "Salvando...";

      try {
        let impacto = document.getElementById("impacto").value;
        if (impacto === "Outro") impacto = document.getElementById("impacto_outro").value.trim() || "Outro";

        const achado = {
          tipo: "achado",
          processo_id: currentProcessoId,
          achado_id: "achado_" + Date.now() + "_" + Math.random().toString(36).slice(2),
          achado_numero: document.getElementById("achado_numero").value.trim(),
          achado_subitem: document.getElementById("achado_subitem").value.trim(),
          achado_descricao: document.getElementById("achado_descricao").value.trim(),
          grau_risco: document.getElementById("grau_risco").value,
          impacto: impacto,
          evidencia: document.getElementById("evidencia").value.trim(),
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.create(achado);
        if (result?.isOk) {
          closeModal("achado");
          showToast("Achado cadastrado com sucesso!", "success");
        } else {
          showToast("Erro ao salvar achado: " + (result?.error || "falha"), "error");
        }
      } catch (err) {
        console.error(err);
        showToast("Erro ao cadastrar achado: " + (err?.message || String(err)), "error");
      } finally {
        btn.disabled = false;
        btnText.textContent = "Salvar Achado";
      }
    });

    document.getElementById("recomendacao-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentProcessoId || !currentAchadoId) {
        showToast("Abra uma recomendação a partir de um achado", "error");
        return;
      }

      if (areasResponsaveis.length === 0) {
        showToast("Por favor, adicione pelo menos uma área/setor responsável", "error");
        return;
      }

      const btn = document.getElementById("submit-recomendacao-btn");
      const btnText = document.getElementById("submit-recomendacao-text");
      btn.disabled = true;
      btnText.textContent = "Salvando...";

      try {
        const prazoFim = document.getElementById("when").value || "";

        const recomendacaoBase = {
          tipo: "recomendacao",
          processo_id: currentProcessoId,
          achado_id: currentAchadoId,
          recomendacao_id: currentEditingRec || ("rec_" + Date.now() + "_" + Math.random().toString(36).slice(2)),
          recomendacao_numero: document.getElementById("recomendacao_numero").value.trim(),
          recomendacao_subitem: document.getElementById("recomendacao_subitem").value.trim(),
          recomendacao_texto: document.getElementById("recomendacao_texto").value.trim(),
          area_responsavel: areasResponsaveis.join("; "),
          responsavel_recomendacao: document.getElementById("responsavel_recomendacao").value.trim(),
          areas_envolvidas: areasEnvolvidas.join("; "),
          prioridade: document.getElementById("prioridade").value,
          prazo_global: document.getElementById("prazo_global").value.trim(),
          prazo_fim: prazoFim,
          what: document.getElementById("what").value.trim(),
          why: document.getElementById("why").value.trim(),
          where: document.getElementById("where").value.trim(),
          when: prazoFim,
          who: document.getElementById("who").value.trim(),
          how: document.getElementById("how").value.trim(),
          how_much: document.getElementById("how_much").value.trim(),
          indicador: document.getElementById("indicador").value.trim(),
          status: document.getElementById("status").value,
          progresso: parseInt(document.getElementById("progresso")?.value || "0", 10) || 0,
          observacao: document.getElementById("observacao").value.trim(),
          evidencias_cumprimento: document.getElementById("evidencias_cumprimento").value.trim(),
          justificativa_nao_cumprimento: document.getElementById("justificativa_nao_cumprimento").value.trim(),
          resultados_percebidos: document.getElementById("resultados_percebidos").value.trim(),
          ultima_atualizacao: new Date().toISOString(),
          updated_by: userSession ? userSession.nome : "Sistema"
        };

        let result;

        if (currentEditingRec) {
          const existing = allData.find(d => d.tipo === "recomendacao" && d.recomendacao_id === currentEditingRec);
          if (!existing) {
            showToast("Recomendação não encontrada para atualizar", "error");
            return;
          }
          result = await window.dataSdk.update({ ...existing, ...recomendacaoBase });
        } else {
          recomendacaoBase.created_at = new Date().toISOString();
          result = await window.dataSdk.create(recomendacaoBase);
        }

        if (result?.isOk) {
          closeModal("recomendacao");
          showToast(currentEditingRec ? "Recomendação atualizada com sucesso!" : "Recomendação salva com sucesso!", "success");
          currentEditingRec = null;
        } else {
          showToast("Erro ao salvar recomendação: " + (result?.error || "falha"), "error");
        }
      } catch (err) {
        console.error(err);
        showToast("Erro ao salvar recomendação: " + (err?.message || String(err)), "error");
      } finally {
        btn.disabled = false;
        btnText.textContent = "Salvar Recomendação";
      }
    });

    function openEditRecomendacao(recId) {
      const rec = allData.find(d => d.tipo === "recomendacao" && d.recomendacao_id === recId);
      if (!rec) return;

      currentEditingRec = recId;
      currentProcessoId = rec.processo_id;
      currentAchadoId = rec.achado_id;

      areasResponsaveis = rec.area_responsavel ? rec.area_responsavel.split(";").map(s => s.trim()).filter(Boolean) : [];
      areasEnvolvidas = rec.areas_envolvidas ? rec.areas_envolvidas.split(";").map(s => s.trim()).filter(Boolean) : [];

      document.getElementById("recomendacao_numero").value = rec.recomendacao_numero || "";
      document.getElementById("recomendacao_subitem").value = rec.recomendacao_subitem || "";
      document.getElementById("recomendacao_texto").value = rec.recomendacao_texto || "";
      document.getElementById("responsavel_recomendacao").value = rec.responsavel_recomendacao || "";
      document.getElementById("prioridade").value = rec.prioridade || "";
      document.getElementById("prazo_global").value = rec.prazo_global || "";
      document.getElementById("what").value = rec.what || "";
      document.getElementById("why").value = rec.why || "";
      document.getElementById("where").value = rec.where || "";
      document.getElementById("when").value = rec.prazo_fim || rec.when || "";
      document.getElementById("who").value = rec.who || "";
      document.getElementById("how").value = rec.how || "";
      document.getElementById("how_much").value = rec.how_much || "";
      document.getElementById("indicador").value = rec.indicador || "";
      document.getElementById("status").value = rec.status || "Pendente";
      document.getElementById("observacao").value = rec.observacao || "";
      document.getElementById("evidencias_cumprimento").value = rec.evidencias_cumprimento || "";
      document.getElementById("justificativa_nao_cumprimento").value = rec.justificativa_nao_cumprimento || "";
      document.getElementById("resultados_percebidos").value = rec.resultados_percebidos || "";

      // Slider progresso
      if (!document.getElementById("progresso")) {
        const statusDiv = document.querySelector("#status").closest("div");
        const progressDiv = document.createElement("div");
        progressDiv.innerHTML = `
          <label class="block text-sm font-medium text-slate-700 mb-2">Progresso (%)</label>
          <input type="range" id="progresso" min="0" max="100" value="${rec.progresso || 0}"
            oninput="document.getElementById('progresso-value').textContent = this.value + '%'" class="w-full">
          <div class="flex justify-between text-xs text-slate-500 mt-1">
            <span>0%</span>
            <span id="progresso-value" class="font-bold text-blue-600">${rec.progresso || 0}%</span>
            <span>100%</span>
          </div>
        `;
        statusDiv.parentNode.insertBefore(progressDiv, statusDiv.nextSibling);
      } else {
        document.getElementById("progresso").value = rec.progresso || 0;
        const val = document.getElementById("progresso-value");
        if (val) val.textContent = (rec.progresso || 0) + "%";
      }

      renderAreas();

      const isTecnico = userSession && userSession.perfil === "Técnico";
      document.getElementById("recomendacao_numero").disabled = !!isTecnico;
      document.getElementById("recomendacao_subitem").disabled = !!isTecnico;
      document.getElementById("recomendacao_texto").disabled = !!isTecnico;
      document.getElementById("prioridade").disabled = !!isTecnico;

      document.getElementById("modal-recomendacao").style.display = "flex";
      lucide.createIcons();
    }

    /* ============================================================
       DELETE
       - Corrigido: deleteProcesso recebe o botão corretamente
    ============================================================ */
    async function deleteProcesso(processoId, btnEl) {
      const item = allData.find(d => d.tipo === "processo" && d.processo_id === processoId);
      if (!item) return;

      showConfirmModal(
        "Excluir Processo",
        "Deseja realmente excluir este processo? Esta ação não pode ser desfeita.",
        async () => {
          if (btnEl) {
            btnEl.disabled = true;
            btnEl.textContent = "Excluindo...";
          }

          // Excluir processo, achados e recomendações relacionados
          const achados = allData.filter(d => d.tipo === "achado" && d.processo_id === processoId);
          const recs = allData.filter(d => d.tipo === "recomendacao" && d.processo_id === processoId);

          await window.dataSdk.delete(item);
          for (const a of achados) await window.dataSdk.delete(a);
          for (const r of recs) await window.dataSdk.delete(r);

          showToast("Processo excluído com sucesso!", "success");
        }
      );
    }

    async function deleteAchado(achadoId) {
      const item = allData.find(d => d.tipo === "achado" && d.achado_id === achadoId);
      if (!item) return;

      showConfirmModal("Excluir Achado", "Deseja realmente excluir este achado?", async () => {
        const recs = allData.filter(d => d.tipo === "recomendacao" && d.achado_id === achadoId);
        await window.dataSdk.delete(item);
        for (const r of recs) await window.dataSdk.delete(r);
        showToast("Achado excluído com sucesso!", "success");
      });
    }

    async function deleteRecomendacao(recomendacaoId) {
      const item = allData.find(d => d.tipo === "recomendacao" && d.recomendacao_id === recomendacaoId);
      if (!item) return;

      showConfirmModal("Excluir Recomendação", "Deseja realmente excluir esta recomendação?", async () => {
        await window.dataSdk.delete(item);
        showToast("Recomendação excluída com sucesso!", "success");
      });
    }

    function showConfirmModal(title, message, onConfirm) {
      const modal = document.createElement("div");
      modal.style.cssText = "position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;";
      modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 12px; max-width: 420px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
          <h3 style="font-size: 18px; font-weight: bold; color: #1e293b; margin-bottom: 12px;">${escapeHtml(title)}</h3>
          <p style="color: #64748b; margin-bottom: 24px;">${escapeHtml(message)}</p>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="cancel-action" style="padding: 8px 16px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #475569; cursor: pointer; font-weight: 500;">Cancelar</button>
            <button id="confirm-action" style="padding: 8px 16px; border: none; border-radius: 8px; background: #dc2626; color: white; cursor: pointer; font-weight: 500;">Confirmar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById("cancel-action").onclick = () => document.body.removeChild(modal);
      document.getElementById("confirm-action").onclick = async () => {
        document.body.removeChild(modal);
        await onConfirm();
      };
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      const bgColor = type === "error" ? "#dc2626" : "#10b981";
      toast.style.cssText = "position: fixed; top: 20px; right: 20px; background: " + bgColor + "; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 9999; font-weight: 500;";
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.transition = "opacity 0.3s";
        toast.style.opacity = "0";
        setTimeout(() => {
          if (toast.parentNode) document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    /* ============================================================
       EXPORT PDF
       - Funciona no GitHub Pages (jsPDF CDN)
    ============================================================ */
    function exportMenuOpen() {
      const filteredData = filterDataByUser(allData);
      const processos = filteredData.filter(d => d.tipo === "processo");

      const planoList = document.getElementById("processos-plano-list");
      const formalList = document.getElementById("processos-formal-list");

      if (processos.length === 0) {
        planoList.innerHTML = '<p class="text-sm text-slate-400">Nenhum processo cadastrado</p>';
        formalList.innerHTML = '<p class="text-sm text-slate-400">Nenhum processo cadastrado</p>';
      } else {
        planoList.innerHTML = processos.map(p => `
          <button type="button" onclick="exportPDFProcesso('${p.processo_id}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-100 text-sm text-slate-700 transition-colors">
            ${escapeHtml(p.processo_numero || "")} - ${escapeHtml(p.unidade || "")}
          </button>
        `).join("");

        formalList.innerHTML = processos.map(p => `
          <button type="button" onclick="exportPDFFormalProcesso('${p.processo_id}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-purple-100 text-sm text-slate-700 transition-colors">
            ${escapeHtml(p.processo_numero || "")} - ${escapeHtml(p.unidade || "")}
          </button>
        `).join("");
      }

      document.getElementById("modal-export").style.display = "flex";
      lucide.createIcons();
    }

    async function exportPDFGeral() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const filteredData = filterDataByUser(allData);
        const recomendacoes = filteredData.filter(d => d.tipo === "recomendacao");
        const processos = filteredData.filter(d => d.tipo === "processo");

        if (recomendacoes.length === 0) {
          showToast("Nenhuma recomendação para exportar", "error");
          return;
        }

        let yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, "bold");
        doc.text("PLANO DE AÇÃO 5W2H - RELATÓRIO GERAL", 105, yPos, { align: "center" });
        yPos += 10;

        doc.setFontSize(10);
        doc.setFont(undefined, "normal");
        doc.text("SESAP/RN - Secretaria de Estado da Saúde Pública", 105, yPos, { align: "center" });
        yPos += 5;
        doc.text("Data de Geração: " + new Date().toLocaleDateString("pt-BR"), 105, yPos, { align: "center" });
        yPos += 15;

        recomendacoes.forEach(rec => {
          const processo = processos.find(p => p.processo_id === rec.processo_id);

          if (yPos > 250) { doc.addPage(); yPos = 20; }

          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("Recomendação " + (rec.recomendacao_numero || "") + (rec.recomendacao_subitem ? "-" + rec.recomendacao_subitem : ""), 20, yPos);
          yPos += 7;

          doc.setFontSize(9);
          doc.setFont(undefined, "italic");
          if (processo) {
            doc.text("Processo: " + (processo.processo_numero || "") + " | Unidade: " + (processo.unidade || ""), 20, yPos);
            yPos += 5;
          }

          doc.setFont(undefined, "normal");
          const textoSplit = doc.splitTextToSize(rec.recomendacao_texto || "Não informado", 170);
          doc.text(textoSplit, 20, yPos);
          yPos += (textoSplit.length * 5) + 5;

          doc.setFontSize(10);
          doc.setFont(undefined, "bold");
          doc.text("PLANO 5W2H:", 20, yPos);
          yPos += 6;

          doc.setFontSize(9);
          doc.setFont(undefined, "normal");

          const campos5W2H = [
            { label: "O QUÊ:", valor: rec.what },
            { label: "POR QUÊ:", valor: rec.why },
            { label: "ONDE:", valor: rec.where },
            { label: "QUANDO:", valor: rec.when ? formatDate(rec.when) : "" },
            { label: "QUEM:", valor: rec.who },
            { label: "COMO:", valor: rec.how },
            { label: "QUANTO:", valor: rec.how_much }
          ];

          campos5W2H.forEach(campo => {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFont(undefined, "bold");
            doc.text(campo.label, 25, yPos);
            doc.setFont(undefined, "normal");
            const valorSplit = doc.splitTextToSize(campo.valor || "Não informado", 150);
            doc.text(valorSplit, 50, yPos);
            yPos += Math.max(valorSplit.length * 5, 5) + 3;
          });

          doc.setFont(undefined, "bold");
          doc.text("STATUS:", 25, yPos);
          doc.setFont(undefined, "normal");
          doc.text(rec.status || "Pendente", 50, yPos);
          yPos += 5;

          doc.setFont(undefined, "bold");
          doc.text("PROGRESSO:", 25, yPos);
          doc.setFont(undefined, "normal");
          doc.text((rec.progresso || 0) + "%", 50, yPos);
          yPos += 10;

          doc.setDrawColor(200, 200, 200);
          doc.line(20, yPos, 190, yPos);
          yPos += 10;
        });

        doc.save("Plano_5W2H_Geral.pdf");
        showToast("✓ PDF gerado com sucesso!", "success");
        closeModal("export");
      } catch (err) {
        console.error(err);
        showToast("Erro ao gerar PDF: " + (err?.message || String(err)), "error");
      }
    }

    async function exportPDFProcesso(processoId) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const processo = allData.find(d => d.tipo === "processo" && d.processo_id === processoId);
        const recomendacoes = allData.filter(d => d.tipo === "recomendacao" && d.processo_id === processoId);

        if (!processo) { showToast("Processo não encontrado", "error"); return; }
        if (recomendacoes.length === 0) { showToast("Este processo não possui recomendações", "error"); return; }

        let yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, "bold");
        doc.text("PLANO DE AÇÃO 5W2H", 105, yPos, { align: "center" });
        yPos += 8;

        doc.setFontSize(12);
        doc.text("Processo: " + (processo.processo_numero || ""), 105, yPos, { align: "center" });
        yPos += 15;

        doc.setFontSize(10);
        doc.setFont(undefined, "bold");
        doc.text("DADOS DO PROCESSO:", 20, yPos);
        yPos += 7;

        doc.setFont(undefined, "normal");
        doc.text("Unidade: " + (processo.unidade || ""), 20, yPos); yPos += 5;
        doc.text("Eixo: " + (processo.eixo || ""), 20, yPos); yPos += 5;
        doc.text("Período: " + (processo.periodo || ""), 20, yPos); yPos += 5;

        const objetoSplit = doc.splitTextToSize("Objeto: " + (processo.objeto || ""), 170);
        doc.text(objetoSplit, 20, yPos);
        yPos += (objetoSplit.length * 5) + 10;

        recomendacoes.forEach(rec => {
          if (yPos > 250) { doc.addPage(); yPos = 20; }

          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("Recomendação " + (rec.recomendacao_numero || "") + (rec.recomendacao_subitem ? "-" + rec.recomendacao_subitem : ""), 20, yPos);
          yPos += 7;

          doc.setFontSize(9);
          doc.setFont(undefined, "normal");
          const textoSplit = doc.splitTextToSize(rec.recomendacao_texto || "Não informado", 170);
          doc.text(textoSplit, 20, yPos);
          yPos += (textoSplit.length * 5) + 5;

          doc.setFontSize(10);
          doc.setFont(undefined, "bold");
          doc.text("PLANO 5W2H:", 20, yPos);
          yPos += 6;

          doc.setFontSize(9);
          const campos = [
            { label: "O QUÊ:", valor: rec.what },
            { label: "POR QUÊ:", valor: rec.why },
            { label: "ONDE:", valor: rec.where },
            { label: "QUANDO:", valor: rec.when ? formatDate(rec.when) : "" },
            { label: "QUEM:", valor: rec.who },
            { label: "COMO:", valor: rec.how },
            { label: "QUANTO:", valor: rec.how_much }
          ];

          campos.forEach(campo => {
            if (yPos > 270) { doc.addPage(); yPos = 20; }
            doc.setFont(undefined, "bold");
            doc.text(campo.label, 25, yPos);
            doc.setFont(undefined, "normal");
            const valorSplit = doc.splitTextToSize(campo.valor || "Não informado", 150);
            doc.text(valorSplit, 50, yPos);
            yPos += Math.max(valorSplit.length * 5, 5) + 3;
          });

          doc.setFont(undefined, "bold");
          doc.text("STATUS:", 25, yPos);
          doc.setFont(undefined, "normal");
          doc.text(rec.status || "Pendente", 50, yPos);
          yPos += 10;

          doc.setDrawColor(200, 200, 200);
          doc.line(20, yPos, 190, yPos);
          yPos += 10;
        });

        doc.save("Plano_5W2H_" + (processo.processo_numero || "processo") + ".pdf");
        showToast("✓ PDF gerado com sucesso!", "success");
        closeModal("export");
      } catch (err) {
        console.error(err);
        showToast("Erro ao gerar PDF: " + (err?.message || String(err)), "error");
      }
    }

    async function exportPDFFormalGeral() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const filteredData = filterDataByUser(allData);
        const recomendacoes = filteredData.filter(d => d.tipo === "recomendacao");
        const processos = filteredData.filter(d => d.tipo === "processo");

        if (recomendacoes.length === 0) {
          showToast("Nenhuma recomendação para exportar", "error");
          return;
        }

        let yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, "bold");
        doc.text("RELATÓRIO FORMAL DE ACOMPANHAMENTO", 105, yPos, { align: "center" });
        yPos += 10;

        doc.setFontSize(10);
        doc.setFont(undefined, "normal");
        doc.text("SESAP/RN - Secretaria de Estado da Saúde Pública", 105, yPos, { align: "center" });
        yPos += 5;
        doc.text("Data de Geração: " + new Date().toLocaleDateString("pt-BR"), 105, yPos, { align: "center" });
        yPos += 15;

        recomendacoes.forEach(rec => {
          const processo = processos.find(p => p.processo_id === rec.processo_id);

          if (yPos > 240) { doc.addPage(); yPos = 20; }

          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("Recomendação " + (rec.recomendacao_numero || "") + (rec.recomendacao_subitem ? "-" + rec.recomendacao_subitem : ""), 20, yPos);
          yPos += 7;

          if (processo) {
            doc.setFontSize(9);
            doc.setFont(undefined, "italic");
            doc.text("Processo: " + (processo.processo_numero || "") + " | Unidade: " + (processo.unidade || ""), 20, yPos);
            yPos += 5;
          }

          doc.setFont(undefined, "normal");
          const textoSplit = doc.splitTextToSize(rec.recomendacao_texto || "Não informado", 170);
          doc.text(textoSplit, 20, yPos);
          yPos += (textoSplit.length * 5) + 7;

          doc.setFont(undefined, "bold");
          doc.text("EVIDÊNCIAS DO CUMPRIMENTO:", 20, yPos);
          yPos += 5;
          doc.setFont(undefined, "normal");
          const evidSplit = doc.splitTextToSize(rec.evidencias_cumprimento || "Não informado", 170);
          doc.text(evidSplit, 20, yPos);
          yPos += (evidSplit.length * 5) + 5;

          doc.setFont(undefined, "bold");
          doc.text("JUSTIFICATIVA DO NÃO CUMPRIMENTO:", 20, yPos);
          yPos += 5;
          doc.setFont(undefined, "normal");
          const justSplit = doc.splitTextToSize(rec.justificativa_nao_cumprimento || "Não informado", 170);
          doc.text(justSplit, 20, yPos);
          yPos += (justSplit.length * 5) + 5;

          doc.setFont(undefined, "bold");
          doc.text("RESULTADOS PERCEBIDOS:", 20, yPos);
          yPos += 5;
          doc.setFont(undefined, "normal");
          const resSplit = doc.splitTextToSize(rec.resultados_percebidos || "Não informado", 170);
          doc.text(resSplit, 20, yPos);
          yPos += (resSplit.length * 5) + 5;

          doc.setFont(undefined, "bold");
          doc.text("STATUS:", 20, yPos);
          doc.setFont(undefined, "normal");
          doc.text(rec.status || "Pendente", 45, yPos);
          yPos += 5;

          doc.setFont(undefined, "bold");
          doc.text("PROGRESSO:", 20, yPos);
          doc.setFont(undefined, "normal");
          doc.text((rec.progresso || 0) + "%", 45, yPos);
          yPos += 10;

          doc.setDrawColor(200, 200, 200);
          doc.line(20, yPos, 190, yPos);
          yPos += 10;
        });

        doc.save("Relatorio_Formal_Geral.pdf");
        showToast("✓ PDF gerado com sucesso!", "success");
        closeModal("export");
      } catch (err) {
        console.error(err);
        showToast("Erro ao gerar PDF: " + (err?.message || String(err)), "error");
      }
    }

    async function exportPDFFormalProcesso(processoId) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const processo = allData.find(d => d.tipo === "processo" && d.processo_id === processoId);
        const recomendacoes = allData.filter(d => d.tipo === "recomendacao" && d.processo_id === processoId);

        if (!processo) { showToast("Processo não encontrado", "error"); return; }
        if (recomendacoes.length === 0) { showToast("Este processo não possui recomendações", "error"); return; }

        let yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, "bold");
        doc.text("RELATÓRIO FORMAL DE ACOMPANHAMENTO", 105, yPos, { align: "center" });
        yPos += 8;

        doc.setFontSize(12);
        doc.text("Processo: " + (processo.processo_numero || ""), 105, yPos, { align: "center" });
        yPos += 15;

        doc.setFontSize(10);
        doc.setFont(undefined, "bold");
        doc.text("DADOS DO PROCESSO:", 20, yPos);
        yPos += 7;

        doc.setFont(undefined, "normal");
        doc.text("Unidade: " + (processo.unidade || ""), 20, yPos); yPos += 5;
        doc.text("Eixo: " + (processo.eixo || ""), 20, yPos); yPos += 5;
        doc.text("Período: " + (processo.periodo || ""), 20, yPos); yPos += 10;

        recomendacoes.forEach(rec => {
          if (yPos > 230) { doc.addPage(); yPos = 20; }

          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("Recomendação " + (rec.recomendacao_numero || "") + (rec.recomendacao_subitem ? "-" + rec.recomendacao_subitem : ""), 20, yPos);
          yPos += 7;

          doc.setFontSize(9);
          doc.setFont(undefined, "normal");
          const textoSplit = doc.splitTextToSize(rec.recomendacao_texto || "Não informado", 170);
          doc.text(textoSplit, 20, yPos);
          yPos += (textoSplit.length * 5) + 7;

          doc.setFont(undefined, "bold");
          doc.text("EVIDÊNCIAS DO CUMPRIMENTO:", 20, yPos);
          yPos += 5;
          doc.setFont(undefined, "normal");
          const evidSplit = doc.splitTextToSize(rec.evidencias_cumprimento || "Não informado", 170);
          doc.text(evidSplit, 20, yPos);
          yPos += (evidSplit.length * 5) + 5;

          doc.setFont(undefined, "bold");
          doc.text("JUSTIFICATIVA:", 20, yPos);
          yPos += 5;
          doc.setFont(undefined, "normal");
          const justSplit = doc.splitTextToSize(rec.justificativa_nao_cumprimento || "Não informado", 170);
          doc.text(justSplit, 20, yPos);
          yPos += (justSplit.length * 5) + 5;

          doc.setFont(undefined, "bold");
          doc.text("RESULTADOS:", 20, yPos);
          yPos += 5;
          doc.setFont(undefined, "normal");
          const resSplit = doc.splitTextToSize(rec.resultados_percebidos || "Não informado", 170);
          doc.text(resSplit, 20, yPos);
          yPos += (resSplit.length * 5) + 10;

          doc.setDrawColor(200, 200, 200);
          doc.line(20, yPos, 190, yPos);
          yPos += 10;
        });

        doc.save("Relatorio_Formal_" + (processo.processo_numero || "processo") + ".pdf");
        showToast("✓ PDF gerado com sucesso!", "success");
        closeModal("export");
      } catch (err) {
        console.error(err);
        showToast("Erro ao gerar PDF: " + (err?.message || String(err)), "error");
      }
    }
  </script>

</body>
</html>
