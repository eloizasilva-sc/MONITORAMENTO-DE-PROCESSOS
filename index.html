<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIGR 5W2H | Plano de Ação por Processo</title>

  <style>
    :root{
      /* CLEAN LIGHT THEME */
      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface2:#fbfcff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --primary:#2563eb;     /* azul institucional */
      --primary2:#1d4ed8;
      --danger:#dc2626;

      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;

      --radius:14px;
      --shadow: 0 10px 25px rgba(17,24,39,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background: var(--bg);
      min-height:100vh;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:22px 16px 56px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:14px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .brand h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
      font-weight:800;
    }

    .brand p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:760px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      border:1px solid var(--line);
      background: var(--surface);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .10s ease, background .10s ease, border-color .10s ease;
      font-weight:700;
      font-size:13px;
    }

    button:hover{
      transform: translateY(-1px);
      border-color:#cbd5e1;
      background: #f9fafb;
    }

    button.primary{
      border-color: rgba(37,99,235,.25);
      background: rgba(37,99,235,.10);
      color: var(--primary2);
    }
    button.primary:hover{
      background: rgba(37,99,235,.14);
      border-color: rgba(37,99,235,.35);
    }

    button.danger{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.08);
      color: var(--danger);
    }
    button.danger:hover{
      background: rgba(220,38,38,.12);
      border-color: rgba(220,38,38,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .actions{justify-content:flex-start;}
    }

    .panel{
      background: var(--surface);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: var(--surface2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .panelHeader h2{
      margin:0;
      font-size:12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color: var(--muted);
      font-weight:800;
    }

    .panelBody{ padding:14px; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:12px 0 6px;
      font-weight:700;
    }

    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: var(--surface);
      color: var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.10);
    }

    textarea{ min-height: 86px; resize: vertical; }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card{
      background: var(--surface);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:12px;
      box-shadow: var(--shadow);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .badge{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      background: #f9fafb;
      white-space:nowrap;
      font-weight:800;
    }

    .badge.good{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); color: var(--good); }
    .badge.warn{ border-color: rgba(217,119,6,.25); background: rgba(217,119,6,.10); color: var(--warn); }
    .badge.bad{  border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.10); color: var(--bad); }

    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .title{
      margin:0 0 6px;
      font-size:14px;
      line-height:1.35;
      font-weight:900;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    @media (max-width: 520px){
      .kpis{grid-template-columns:1fr;}
    }

    .kpi{
      padding:12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--surface2);
    }

    .kpi .v{
      font-size:18px;
      font-weight:900;
      margin-top:4px;
    }

    .kpi .l{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.25px;
      font-weight:800;
    }

    .divider{
      height:1px;
      background: var(--line);
      margin:14px 0;
    }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .twoCols{grid-template-columns:1fr;}
    }

    .foot{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
    }

    /* PRINT */
    @media print {
      body{
        background:#fff !important;
        color:#111 !important;
      }
      .noPrint{ display:none !important; }
      .panel, .card, .kpi{
        box-shadow:none !important;
      }
      .panel{
        border:1px solid #ddd !important;
        background:#fff !important;
      }
      .panelHeader{
        border-bottom:1px solid #ddd !important;
        background:#fff !important;
      }
      input, select, textarea{
        border:1px solid #ccc !important;
        background:#fff !important;
        color:#111 !important;
      }
      .badge{
        border:1px solid #ddd !important;
        background:#f6f6f6 !important;
        color:#111 !important;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar noPrint">
      <div class="brand">
        <h1>SIGR 5W2H | Plano de Ação por Processo</h1>
        <p>
          Sistema clean para organizar recomendações por processo SEI, registrar plano 5W2H e imprimir o plano consolidado do processo selecionado.
        </p>
      </div>
      <div class="actions">
        <button class="primary" id="btnPrint">Imprimir plano do processo</button>
        <button id="btnExport">Exportar JSON</button>
        <button class="danger" id="btnReset">Limpar dados</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Processos -->
      <section class="panel noPrint" aria-label="Processos">
        <div class="panelHeader">
          <h2>Processos</h2>
          <span class="badge" id="countProc">0</span>
        </div>
        <div class="panelBody">
          <label for="procSelect">Selecionar processo</label>
          <select id="procSelect"></select>

          <div class="divider"></div>

          <h3 style="margin:0;font-size:13px;letter-spacing:.2px;font-weight:900;">Novo processo</h3>

          <label for="p_num">Nº do Processo (SEI)</label>
          <input id="p_num" placeholder="Ex.: 02510051.001062/2025-57" />

          <div class="twoCols">
            <div>
              <label for="p_eixo">Eixo</label>
              <input id="p_eixo" placeholder="Ex.: Contratos" />
            </div>
            <div>
              <label for="p_unidade">Unidade / Setor</label>
              <input id="p_unidade" placeholder="Ex.: Hospital Deoclécio Marques de Lucena" />
            </div>
          </div>

          <label for="p_objeto">Objeto</label>
          <textarea id="p_objeto" placeholder="Resumo do objeto da auditoria"></textarea>

          <button class="primary" id="btnAddProcess" style="margin-top:12px;width:100%;">Adicionar processo</button>

          <p class="hint">
            Dica: selecione um processo e cadastre as recomendações. Cada recomendação terá seu 5W2H.
          </p>
        </div>
      </section>

      <!-- RIGHT: Detalhe -->
      <section class="panel" aria-label="Detalhes do Processo" id="printArea">
        <div class="panelHeader">
          <h2 id="procTitle">Plano de Ação</h2>
          <span class="badge" id="procEixo">Eixo</span>
        </div>
        <div class="panelBody">
          <div class="kpis">
            <div class="kpi">
              <div class="l">Total de recomendações</div>
              <div class="v" id="kpiTotal">0</div>
            </div>
            <div class="kpi">
              <div class="l">Concluídas</div>
              <div class="v" id="kpiDone">0</div>
            </div>
            <div class="kpi">
              <div class="l">Em atraso</div>
              <div class="v" id="kpiLate">0</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="card">
            <div class="row">
              <div>
                <p class="small" style="margin:0 0 4px;">Unidade / Setor</p>
                <p style="margin:0;font-weight:900;" id="procUnidade">-</p>
              </div>
              <div>
                <p class="small" style="margin:0 0 4px;">Processo SEI</p>
                <p style="margin:0;font-weight:900;" id="procSei">-</p>
              </div>
            </div>
            <div class="divider"></div>
            <p class="small" style="margin:0 0 6px;">Objeto</p>
            <p style="margin:0;line-height:1.45" id="procObjeto">-</p>
          </div>

          <div class="divider"></div>

          <!-- Add recommendation -->
          <div class="card noPrint">
            <div class="row">
              <div>
                <h3 style="margin:0;font-size:14px;font-weight:900;">Nova recomendação</h3>
                <p class="small" style="margin:6px 0 0;">Cadastre e depois preencha o 5W2H.</p>
              </div>
              <span class="badge" style="border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.10);color:var(--primary2)">5W2H</span>
            </div>

            <label for="r_text">Texto da recomendação</label>
            <textarea id="r_text" placeholder="Ex.: Instituir POP para todas as etapas do processo..."></textarea>

            <div class="twoCols">
              <div>
                <label for="r_area">Área responsável</label>
                <input id="r_area" placeholder="Ex.: Hospital e SUAH" />
              </div>
              <div>
                <label for="r_prioridade">Prioridade</label>
                <select id="r_prioridade">
                  <option value="Alta">Alta</option>
                  <option value="Média" selected>Média</option>
                  <option value="Baixa">Baixa</option>
                </select>
              </div>
            </div>

            <div class="twoCols">
              <div>
                <label for="r_prazo">Prazo final (When)</label>
                <input id="r_prazo" type="date" />
              </div>
              <div>
                <label for="r_status">Status</label>
                <select id="r_status">
                  <option value="Pendente" selected>Pendente</option>
                  <option value="Em execução">Em execução</option>
                  <option value="Parcialmente atendido">Parcialmente atendido</option>
                  <option value="Concluído">Concluído</option>
                  <option value="Não atendido">Não atendido</option>
                </select>
              </div>
            </div>

            <button class="primary" id="btnAddRec" style="margin-top:12px;width:100%;">Adicionar recomendação</button>
          </div>

          <h3 style="margin:0 0 10px;font-size:14px;letter-spacing:.2px;font-weight:900;">Recomendações e Plano 5W2H</h3>
          <div class="list" id="recList"></div>

          <p class="foot">
            Impressão: use “Imprimir plano do processo”. O sistema imprime apenas o processo selecionado, com recomendações e 5W2H.
          </p>
        </div>
      </section>
    </div>
  </div>

<script>
  const STORAGE_KEY = "sigr_5w2h_v1";

  const STATUS_META = {
    "Pendente": { cls:"warn", label:"Pendente" },
    "Em execução": { cls:"warn", label:"Em execução" },
    "Parcialmente atendido": { cls:"warn", label:"Parcialmente atendido" },
    "Concluído": { cls:"good", label:"Concluído" },
    "Não atendido": { cls:"bad", label:"Não atendido" }
  };

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function loadDB(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return seedDB();
  }

  function saveDB(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

  function seedDB(){
    const p1 = {
      id: uid(),
      sei: "02510051.001062/2025-57",
      eixo: "Contratos",
      unidade: "Hospital Deoclécio Marques de Lucena",
      objeto: "Avaliação da gestão dos contratos de OPME e fluxos internos.",
      recs: [
        {
          id: uid(),
          texto: "Instituir POP para todas as etapas do processo (solicitação, recebimento, esterilização, dispensação e uso de OPMEs).",
          area: "Hospital e SUAH",
          prioridade: "Alta",
          prazo: "",
          status: "Pendente",
          updatedAt: todayISO(),
          w2h: {
            what: "Elaborar, validar e implantar POP do fluxo de OPME.",
            why: "Padronizar e garantir rastreabilidade.",
            where: "Centro Cirúrgico, CME e setores correlatos.",
            when: "",
            who: "Direção + Coordenação CME + Qualidade",
            how: "Grupo técnico, mapeamento do fluxo, minuta POP, validação e treinamento.",
            howMuch: "Sem custo direto (esforço interno)."
          }
        }
      ]
    };

    const db = { processes: [p1], selectedProcessId: p1.id };
    saveDB(db);
    return db;
  }

  const elProcSelect = document.getElementById("procSelect");
  const elCountProc = document.getElementById("countProc");

  const elProcTitle = document.getElementById("procTitle");
  const elProcEixo = document.getElementById("procEixo");
  const elProcUnidade = document.getElementById("procUnidade");
  const elProcSei = document.getElementById("procSei");
  const elProcObjeto = document.getElementById("procObjeto");

  const elKpiTotal = document.getElementById("kpiTotal");
  const elKpiDone = document.getElementById("kpiDone");
  const elKpiLate = document.getElementById("kpiLate");

  const elRecList = document.getElementById("recList");

  const btnAddProcess = document.getElementById("btnAddProcess");
  const btnAddRec = document.getElementById("btnAddRec");
  const btnPrint = document.getElementById("btnPrint");
  const btnReset = document.getElementById("btnReset");
  const btnExport = document.getElementById("btnExport");

  const p_num = document.getElementById("p_num");
  const p_eixo = document.getElementById("p_eixo");
  const p_unidade = document.getElementById("p_unidade");
  const p_objeto = document.getElementById("p_objeto");

  const r_text = document.getElementById("r_text");
  const r_area = document.getElementById("r_area");
  const r_prioridade = document.getElementById("r_prioridade");
  const r_prazo = document.getElementById("r_prazo");
  const r_status = document.getElementById("r_status");

  let DB = loadDB();

  function getSelectedProcess(){
    return DB.processes.find(p => p.id === DB.selectedProcessId) || DB.processes[0] || null;
  }

  function isLate(prazoISO, status){
    if(!prazoISO) return false;
    if(status === "Concluído") return false;
    const now = new Date();
    const due = new Date(prazoISO + "T23:59:59");
    return due < now;
  }

  function badgeForStatus(status){
    const meta = STATUS_META[status] || {cls:"warn", label:status || "Pendente"};
    return `<span class="badge ${meta.cls}">${meta.label}</span>`;
  }

  function escapeHTML(str){
    return (str ?? "")
      .toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    elProcSelect.innerHTML = "";
    DB.processes.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.sei} | ${p.unidade}`;
      elProcSelect.appendChild(opt);
    });
    elCountProc.textContent = DB.processes.length;
    if(DB.selectedProcessId){
      elProcSelect.value = DB.selectedProcessId;
    }

    const proc = getSelectedProcess();
    if(!proc){
      elProcTitle.textContent = "Nenhum processo";
      elProcEixo.textContent = "Eixo";
      elProcUnidade.textContent = "-";
      elProcSei.textContent = "-";
      elProcObjeto.textContent = "-";
      elRecList.innerHTML = `<div class="card"><p class="small" style="margin:0">Cadastre um processo para começar.</p></div>`;
      elKpiTotal.textContent = "0";
      elKpiDone.textContent = "0";
      elKpiLate.textContent = "0";
      return;
    }

    elProcTitle.textContent = "Plano de Ação";
    elProcEixo.textContent = proc.eixo || "Eixo";
    elProcUnidade.textContent = proc.unidade || "-";
    elProcSei.textContent = proc.sei || "-";
    elProcObjeto.textContent = proc.objeto || "-";

    const total = proc.recs.length;
    const done = proc.recs.filter(r => r.status === "Concluído").length;
    const late = proc.recs.filter(r => isLate(r.prazo, r.status)).length;

    elKpiTotal.textContent = total;
    elKpiDone.textContent = done;
    elKpiLate.textContent = late;

    if(total === 0){
      elRecList.innerHTML = `<div class="card"><p class="small" style="margin:0">Sem recomendações neste processo. Cadastre a primeira.</p></div>`;
      return;
    }

    elRecList.innerHTML = "";
    proc.recs.forEach((r, idx) => {
      const lateFlag = isLate(r.prazo, r.status);
      const lateBadge = lateFlag ? `<span class="badge bad">Atrasado</span>` : "";

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="row">
          <div style="min-width:220px;flex:1">
            <p class="title">Recomendação ${idx+1}</p>
            <p style="margin:0 0 8px;line-height:1.45">${escapeHTML(r.texto || "")}</p>
            <p class="small" style="margin:0">
              <strong>Área:</strong> ${escapeHTML(r.area || "-")} &nbsp;|&nbsp;
              <strong>Prioridade:</strong> ${escapeHTML(r.prioridade || "-")}
            </p>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            ${badgeForStatus(r.status)}
            ${lateBadge}
            <span class="badge" title="Última atualização">${escapeHTML(r.updatedAt || "")}</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="twoCols noPrint">
          <div>
            <label>Status</label>
            <select data-act="status" data-id="${r.id}">
              ${Object.keys(STATUS_META).map(s => `<option value="${s}" ${s===r.status?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>Prazo final (When)</label>
            <input data-act="prazo" data-id="${r.id}" type="date" value="${r.prazo || ""}" />
          </div>
        </div>

        <div class="divider"></div>

        <h4 style="margin:0 0 8px;font-size:13px;font-weight:900;">Plano 5W2H</h4>

        <div class="twoCols">
          <div>
            <label>What (O que será feito)</label>
            <textarea data-act="w2h.what" data-id="${r.id}">${escapeHTML(r.w2h?.what || "")}</textarea>
          </div>
          <div>
            <label>Why (Por quê)</label>
            <textarea data-act="w2h.why" data-id="${r.id}">${escapeHTML(r.w2h?.why || "")}</textarea>
          </div>

          <div>
            <label>Where (Onde)</label>
            <textarea data-act="w2h.where" data-id="${r.id}">${escapeHTML(r.w2h?.where || "")}</textarea>
          </div>
          <div>
            <label>When (Quando)</label>
            <textarea data-act="w2h.when" data-id="${r.id}">${escapeHTML(r.w2h?.when || "")}</textarea>
          </div>

          <div>
            <label>Who (Quem)</label>
            <textarea data-act="w2h.who" data-id="${r.id}">${escapeHTML(r.w2h?.who || "")}</textarea>
          </div>
          <div>
            <label>How (Como)</label>
            <textarea data-act="w2h.how" data-id="${r.id}">${escapeHTML(r.w2h?.how || "")}</textarea>
          </div>

          <div style="grid-column:1/-1">
            <label>How much (Quanto custa)</label>
            <textarea data-act="w2h.howMuch" data-id="${r.id}">${escapeHTML(r.w2h?.howMuch || "")}</textarea>
          </div>
        </div>

        <div class="divider noPrint"></div>

        <div class="row noPrint" style="justify-content:space-between;align-items:center">
          <p class="small" style="margin:0">Salva automaticamente enquanto você digita.</p>
          <button class="danger" data-act="deleteRec" data-id="${r.id}">Excluir recomendação</button>
        </div>
      `;

      elRecList.appendChild(card);
    });
  }

  elProcSelect.addEventListener("change", (e) => {
    DB.selectedProcessId = e.target.value;
    saveDB(DB);
    render();
  });

  btnAddProcess.addEventListener("click", () => {
    const sei = (p_num.value || "").trim();
    const eixo = (p_eixo.value || "").trim();
    const unidade = (p_unidade.value || "").trim();
    const objeto = (p_objeto.value || "").trim();

    if(!sei || !unidade){
      alert("Informe pelo menos o Nº do Processo (SEI) e a Unidade.");
      return;
    }
    const exists = DB.processes.some(p => p.sei === sei);
    if(exists){
      alert("Já existe um processo com esse número. Selecione-o na lista.");
      return;
    }

    const proc = { id: uid(), sei, eixo, unidade, objeto, recs: [] };
    DB.processes.unshift(proc);
    DB.selectedProcessId = proc.id;
    saveDB(DB);

    p_num.value = "";
    p_eixo.value = "";
    p_unidade.value = "";
    p_objeto.value = "";
    render();
  });

  btnAddRec.addEventListener("click", () => {
    const proc = getSelectedProcess();
    if(!proc){
      alert("Cadastre ou selecione um processo primeiro.");
      return;
    }

    const texto = (r_text.value || "").trim();
    const area = (r_area.value || "").trim();
    const prioridade = r_prioridade.value;
    const prazo = r_prazo.value || "";
    const status = r_status.value;

    if(!texto){
      alert("Informe o texto da recomendação.");
      return;
    }

    const rec = {
      id: uid(),
      texto,
      area,
      prioridade,
      prazo,
      status,
      updatedAt: todayISO(),
      w2h: { what:"", why:"", where:"", when:"", who:"", how:"", howMuch:"" }
    };

    proc.recs.unshift(rec);
    saveDB(DB);

    r_text.value = "";
    r_area.value = "";
    r_prioridade.value = "Média";
    r_prazo.value = "";
    r_status.value = "Pendente";

    render();
  });

  document.addEventListener("input", (e) => {
    const t = e.target;
    const act = t.getAttribute("data-act");
    const id = t.getAttribute("data-id");
    if(!act || !id) return;

    const proc = getSelectedProcess();
    if(!proc) return;

    const rec = proc.recs.find(r => r.id === id);
    if(!rec) return;

    if(act === "prazo"){
      rec.prazo = t.value || "";
      rec.updatedAt = todayISO();
    }

    if(act.startsWith("w2h.")){
      const key = act.split(".")[1];
      rec.w2h = rec.w2h || {};
      rec.w2h[key] = t.value || "";
      rec.updatedAt = todayISO();
    }

    saveDB(DB);
    render();
  });

  document.addEventListener("change", (e) => {
    const t = e.target;
    const act = t.getAttribute("data-act");
    const id = t.getAttribute("data-id");
    if(!act || !id) return;

    const proc = getSelectedProcess();
    if(!proc) return;

    const rec = proc.recs.find(r => r.id === id);
    if(!rec) return;

    if(act === "status"){
      rec.status = t.value;
      rec.updatedAt = todayISO();
      saveDB(DB);
      render();
    }
  });

  document.addEventListener("click", (e) => {
    const t = e.target;
    const act = t.getAttribute("data-act");
    const id = t.getAttribute("data-id");
    if(!act || !id) return;

    const proc = getSelectedProcess();
    if(!proc) return;

    if(act === "deleteRec"){
      const ok = confirm("Excluir esta recomendação? Esta ação não pode ser desfeita.");
      if(!ok) return;
      proc.recs = proc.recs.filter(r => r.id !== id);
      saveDB(DB);
      render();
    }
  });

  btnPrint.addEventListener("click", () => {
    const proc = getSelectedProcess();
    if(!proc){
      alert("Selecione um processo para imprimir.");
      return;
    }
    document.title = `Plano de Ação 5W2H - ${proc.sei}`;
    window.print();
    document.title = "SIGR 5W2H | Plano de Ação por Processo";
  });

  btnReset.addEventListener("click", () => {
    const ok = confirm("Isso vai apagar todos os dados salvos no navegador. Continuar?");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    DB = seedDB();
    render();
  });

  btnExport.addEventListener("click", () => {
    const proc = getSelectedProcess();
    if(!proc){
      alert("Selecione um processo para exportar.");
      return;
    }
    const dataStr = JSON.stringify(proc, null, 2);
    const blob = new Blob([dataStr], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `plano_acao_${proc.sei.replaceAll("/","-")}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  if(!DB.selectedProcessId && DB.processes.length){
    DB.selectedProcessId = DB.processes[0].id;
    saveDB(DB);
  }
  render();
</script>
</body>
</html>
